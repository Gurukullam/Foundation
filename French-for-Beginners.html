<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French for Beginners - GK Academy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #3c2d1f;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #cd853f 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            min-height: 120px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .user-greeting {
            color: #2d3748;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .subscription-status {
            font-size: 0.625rem;
            padding: 0.15rem 0.4rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .subscription-status.premium {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b4513;
            border: 1px solid #d4af37;
        }
        
        .subscription-status.free {
            background: rgba(156, 163, 175, 0.2);
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .subscription-btn {
            display: none; /* Hide by default to prevent flash for premium users */
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            padding: 0.25rem 0.6rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            text-decoration: none;
            align-items: center;
            gap: 0.4rem;
        }

        .subscription-btn:hover {
            background: linear-gradient(135deg, #218838, #1fa186);
            transform: translateY(-2px);
        }

        .subscription-btn.premium {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #8b4513;
            font-weight: 600;
        }

        .subscription-btn.premium:hover {
            background: linear-gradient(135deg, #ffed4e, #ff7f00);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .nav-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .nav-menu-row {
            display: flex;
            justify-content: flex-start;
            width: 100%;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 3rem;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8b4513;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .gk-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b4513, #d4af37);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            transition: all 0.3s ease;
        }

        .gk-logo:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .gk-letters {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transform: skew(-10deg) rotate(-5deg);
            letter-spacing: -2px;
            position: relative;
        }

        .gk-letters::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, white, transparent);
            animation: running-line 2s ease-in-out infinite;
        }

        @keyframes running-line {
            0%, 100% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(0); opacity: 1; }
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #3c2d1f;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-links a:hover {
            color: #8b4513;
            text-decoration: none;
        }

        .nav-links > li > a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: #8b4513;
            transition: width 0.3s ease;
        }

        .nav-links > li > a:hover::after {
            width: 100%;
        }

        /* Navigation Donate Button Styles - Matched to menu items */
        .nav-donate {
            display: none; /* Hidden by default, shown only when user is signed in */
        }

        .nav-donate-btn {
            background: none;
            border: none;
            color: #3c2d1f; /* Match menu items color */
            font-weight: 500; /* Match menu items font-weight */
            font-size: 1rem; /* Match menu items font-size */
            cursor: pointer;
            transition: color 0.3s ease; /* Match menu items transition */
            position: relative; /* For underline effect */
            padding: 0; /* Remove padding to match menu links */
            text-decoration: none;
            display: inline-block; /* Match menu links display */
            line-height: normal;
        }

        .nav-donate-btn:hover {
            color: #8b4513; /* Match menu items hover color */
            background: none;
            text-decoration: none; /* Match menu items hover */
        }

        .nav-donate-btn::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px; /* Match menu items underline height */
            bottom: -5px; /* Match menu items underline position */
            left: 0; /* Match menu items underline alignment */
            background-color: #8b4513; /* Match menu items underline color */
            transition: width 0.3s ease; /* Match menu items transition */
        }

        .nav-donate-btn:hover::after {
            width: 100%;
        }

        /* Donation Modal Styles */
        .donation-amounts {
            margin: 2rem 0;
        }

        .amount-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .amount-btn {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 2px solid #dee2e6;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .amount-btn:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .amount-btn.selected {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-color: #c0392b;
        }

        .custom-amount {
            text-align: center;
            margin-top: 1.5rem;
        }

        .custom-amount label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
            font-weight: 500;
        }

        .amount-input-container {
            display: inline-flex;
            align-items: center;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            max-width: 200px;
            margin: 0 auto;
        }

        .currency-symbol {
            padding: 0.75rem 0.5rem 0.75rem 1rem;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 1.1rem;
        }

        #customAmount {
            border: none;
            outline: none;
            padding: 0.75rem 1rem 0.75rem 0.5rem;
            font-size: 1.1rem;
            width: 120px;
            background: transparent;
        }

        .selected-amount-display {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .selected-amount-display p {
            margin: 0;
            font-size: 1.1rem;
            color: #495057;
        }

        @media (max-width: 768px) {
            .amount-buttons {
                gap: 0.5rem;
            }
            
            .amount-btn {
                padding: 0.8rem 1rem;
                font-size: 1rem;
                min-width: 60px;
            }
        }

        /* Authentication Styles */
        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sign-in-btn, .sign-up-btn, .sign-out-btn {
            padding: 0.25rem 0.6rem;
            border: none;
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .subscription-btn {
            padding: 0.25rem 0.6rem;
            border: none;
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            text-decoration: none;
            display: none; /* Hide by default to prevent flash for premium users */
            align-items: center;
            gap: 0.4rem;
        }

        .sign-in-btn {
            background: transparent;
            color: #8b4513;
            border: 2px solid #8b4513;
        }

        .sign-in-btn:hover {
            background: #8b4513;
            color: white;
        }

        .sign-up-btn {
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            border: 2px solid transparent;
        }

        .sign-up-btn:hover {
            background: linear-gradient(135deg, #654321, #b8860b);
            transform: translateY(-2px);
        }



        .subscription-btn:hover {
            background: linear-gradient(135deg, #218838, #1ba085);
            transform: translateY(-2px);
        }

        .sign-out-btn {
            background: #dc3545;
            color: white;
        }

        .sign-out-btn:hover {
            background: #c82333;
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
            top: 100%;
            left: 0;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .dropdown-content.show {
            display: block;
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            color: #3c2d1f;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
            border-bottom: 1px solid #f1f5f9;
            white-space: nowrap;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .dropdown-item:hover {
            background-color: #f8fafc;
            color: #8b4513;
            padding-left: 20px;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Nested Dropdown */
        .nested-dropdown {
            position: relative;
        }

        .nested-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1002;
            top: 0;
            left: 100%;
            margin-left: 5px;
            border: 1px solid #e2e8f0;
        }

        .nested-dropdown-content.show {
            display: block;
            animation: fadeInDown 0.3s ease;
        }

        .nested-dropdown:hover .nested-dropdown-content {
            display: block;
        }

        /* Main Content */
        .main-content {
            margin-top: 140px;
            padding: 2rem;
            display: flex;
            gap: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            border: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 160px;
            height: fit-content;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .sidebar-header h3 {
            color: #374151;
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 0;
        }

        /* Module Slider */
        .module-slider {
            position: relative;
            padding: 0.5rem 0;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem 1.25rem;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f8fafc;
            -webkit-overflow-scrolling: touch;
        }

        .slider-container::-webkit-scrollbar {
            width: 6px;
        }

        .slider-container::-webkit-scrollbar-track {
            background: #f8fafc;
            border-radius: 3px;
        }

        .slider-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
            transition: background 0.2s ease;
        }

        .slider-container::-webkit-scrollbar-thumb:hover {
            background: #8b4513;
        }

        .slider-item {
            width: 100%;
            flex-shrink: 0;
            padding: 0.875rem;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .slider-item:hover {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.25);
        }

        .slider-item.available {
            cursor: pointer;
        }

        .slider-item.coming-soon {
            color: #9ca3af;
            cursor: default;
            opacity: 0.8;
        }

        .slider-item.coming-soon:hover {
            background: #f1f5f9;
            color: #6b7280;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .slider-item .icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .slider-item .module-info {
            flex: 1;
            min-width: 0;
        }

        .slider-item .module-name {
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slider-item .module-status {
            font-size: 0.625rem;
            margin: 0;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slider-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 6px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            flex-shrink: 0;
        }

        .slider-badge.premium {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: #92400e;
        }

        .slider-badge.coming-soon {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* Scroll hint indicator */
        .scroll-hint {
            text-align: center;
            padding: 0.5rem 1.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
            font-style: italic;
        }

        /* Content Area */
        .content-area {
            flex: 1;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #3c2d1f;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #5a4a3a;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Modules Section */
        .modules-section {
            padding: 2rem 0;
        }

        .section-title {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 1rem;
            color: #3c2d1f;
        }

        .section-subtitle {
            text-align: center;
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 3rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .module-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d4af37, #b8860b);
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .module-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .module-card h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #3c2d1f;
        }

        .module-card p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .module-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b4513;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .module-link:hover {
            color: #654321;
            transform: translateX(5px);
        }

        /* Premium Badge */
        .premium-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #8b4513;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        /* Premium Unlocked Styling */
        .premium-module.premium-unlocked {
            border: 2px solid #4ade80;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.2);
        }

        .premium-module.premium-unlocked::after {
            content: "‚úÖ UNLOCKED";
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
            z-index: 10;
            animation: unlockPulse 0.6s ease-out;
        }

        @keyframes unlockPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .premium-module.premium-unlocked .module-link {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .premium-module.premium-unlocked .module-link:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

                /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: static;
                order: -1;
                border-radius: 12px;
            }

            .slider-container {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 0.5rem;
                overflow: visible !important;
                max-height: none !important;
                padding: 1rem;
            }

            .slider-item {
                width: auto;
            }

            .scroll-hint {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .modules-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .nav-container {
                padding: 1rem;
            }

            .nav-top-row {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-menu-row {
                justify-content: center;
            }

            .nav-links {
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .sidebar-header {
                padding: 0.75rem 1rem;
            }

            .slider-container {
                grid-template-columns: 1fr !important;
                padding: 0.5rem;
                overflow: visible !important;
                max-height: none !important;
            }

            .slider-item {
                width: auto;
            }
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover {
            color: #8b4513;
        }

        .modal h2 {
            color: #8b4513;
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #8b4513;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #654321;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #3c2d1f;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8b4513;
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }

        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #8b4513;
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .auth-btn:hover {
            background: linear-gradient(135deg, #654321, #b8860b);
            transform: translateY(-2px);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .switch-auth {
            text-align: center;
            margin-top: 1rem;
            color: #666;
        }

        .switch-auth a {
            color: #8b4513;
            text-decoration: none;
            font-weight: 500;
        }

        .switch-auth a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Subscription Modal Styles */
        .subscription-modal-content {
            max-width: 950px;
            padding: 1.2rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.2rem 0;
        }

        .plan-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 320px;
        }

        .plan-card:hover {
            border-color: #28a745;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
            transform: translateY(-3px);
        }

        .plan-card.selected {
            border: 3px solid #28a745;
            box-shadow: 0 8px 30px rgba(40, 167, 69, 0.3);
            transform: translateY(-5px);
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
        }

        .plan-card.selected::before {
            content: '‚úÖ SELECTED';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .plan-card.popular {
            border-color: #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .plan-card.popular:hover, .plan-card.popular.selected {
            border-color: #2980b9;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .plan-card.premium {
            border-color: #ffd700;
            background: linear-gradient(135deg, #fff9c4, #ffeaa7);
        }

        .plan-card.premium:hover, .plan-card.premium.selected {
            border-color: #ff8c00;
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.3);
        }

        .plan-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.4rem;
        }

        .plan-price {
            font-size: 1.4rem;
            font-weight: 800;
            color: #27ae60;
            margin-bottom: 0.8rem;
        }

        .plan-price .currency {
            font-size: 0.9rem;
            vertical-align: top;
        }

        .plan-price .period {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-weight: 400;
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
            font-size: 0.75rem;
        }

        .plan-features li {
            padding: 0.15rem 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            text-align: left;
        }

        .plan-features li::before {
            content: '‚úì';
            color: #27ae60;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* Enhanced mobile responsiveness for subscription plans */
        @media (max-width: 768px) {
            .subscription-modal-content {
                width: 98% !important;
                max-width: 98% !important;
                margin: 1% auto !important;
                padding: 1rem !important;
                max-height: 95vh !important;
                overflow-y: auto !important;
            }
            
            .subscription-plans {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .plan-card {
                padding: 1rem !important;
                min-height: auto !important;
                margin-bottom: 1rem;
            }
            
            .plan-price {
                font-size: 1.8rem !important;
            }
            
            .payment-section {
                padding: 1rem !important;
                margin-top: 1rem !important;
            }
            
            .subscription-btn-modal {
                width: 100% !important;
                padding: 1rem !important;
                font-size: 1.1rem !important;
                margin-top: 1rem !important;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            /* Touch-friendly form inputs */
            #cardholderName, #card-element {
                padding: 1rem !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px !important;
                touch-action: manipulation;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .subscription-plans {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Additional mobile enhancements */
        @media (max-width: 480px) {
            .subscription-modal-content {
                width: 100% !important;
                height: 100vh !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                padding: 1rem 0.5rem !important;
            }
            
            .plan-price {
                font-size: 1.5rem !important;
            }
            
            .plan-features {
                font-size: 0.9rem !important;
            }
            
            /* Improved mobile navigation */
            .dropdown-content {
                position: fixed !important;
                top: 70px !important;
                left: 5% !important;
                right: 5% !important;
                width: 90% !important;
                max-width: none !important;
                z-index: 9999 !important;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
            }
            
            .dropdown-item {
                padding: 1rem !important;
                font-size: 1rem !important;
                min-height: 48px !important;
                touch-action: manipulation;
            }
        }

        .payment-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
        }

        .payment-form {
            margin-top: 1rem;
        }

        #card-element {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 1rem 0;
            transition: border-color 0.3s ease;
        }

        #card-element:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .subscription-btn-modal {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .subscription-btn-modal:hover {
            background: linear-gradient(135deg, #218838, #1fa186);
            transform: translateY(-2px);
        }

        .subscription-btn-modal:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <!-- Top Row: Logo + Auth -->
            <div class="nav-top-row">
                <a href="index.html" class="logo-container">
                    <div class="gk-logo">
                        <span class="gk-letters">GK</span>
                    </div>
                    <span class="logo">Foundation</span>
                </a>
                <div class="auth-status">
                    <div id="userStatus" class="user-status" style="display: none;">
                        <span id="userGreeting" class="user-greeting"></span>
                        <button id="subscriptionBtn" class="subscription-btn" onclick="openSubscriptionModal()">üíé Go Premium</button>
                    </div>
                    <div class="auth-buttons">
                        <button id="signInBtn" class="sign-in-btn" onclick="openSignInModal()">Sign In</button>
                        <button id="signUpBtn" class="sign-up-btn" onclick="openSignUpModal()">Sign Up</button>
                        <button id="signOutBtn" class="sign-out-btn" style="display: none;" onclick="signOut()">Sign Out</button>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Row: Menu Items -->
            <div class="nav-menu-row">
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" onclick="toggleDropdown(event, 'frenchLearningDropdown')">
                            Our Offerings
                            <span class="dropdown-arrow">‚ñº</span>
                        </a>
                        <div class="dropdown-content" id="frenchLearningDropdown">
                            <a href="French-for-Beginners.html" class="dropdown-item">üéì French for Beginners</a>
                        </div>
                    </li>
                    <li><a href="index.html#modules">Learning Modules</a></li>
                    <li><a href="index.html#features">Features</a></li>
                    <li><a href="index.html#about">About</a></li>
                    <li class="nav-donate">
                        <button class="nav-donate-btn" onclick="openDonationModal()">‚ù§Ô∏è Support Us</button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Sidebar Navigation -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3>ALL MODULES</h3>
                </div>
                
                <div class="module-slider">
                    <div class="slider-container" id="sliderContainer">
                        <!-- Available Modules -->
                        <div class="slider-item available" onclick="navigateToModule('French-Alphabets.html')">
                            <span class="icon">üî§</span>
                            <div class="module-info">
                                <p class="module-name">Alphabets</p>
                                <p class="module-status">Available now</p>
                            </div>
                        </div>
                        
                        <div class="slider-item available" onclick="handleNumbersAccess(event, 'French-Numbers.html')">
                            <span class="icon">üî¢</span>
                            <div class="module-info">
                                <p class="module-name">Numbers</p>
                                <p class="module-status">Premium content</p>
                            </div>
                            <span class="slider-badge premium">Premium</span>
                        </div>
                        
                        <div class="slider-item available" onclick="navigateToModule('French-Verbs.html')">
                            <span class="icon">üìù</span>
                            <div class="module-info">
                                <p class="module-name">Verbs</p>
                                <p class="module-status">Available now</p>
                            </div>
                        </div>

                        <!-- Coming Soon Modules -->
                        <div class="slider-item coming-soon">
                            <span class="icon">üìÑ</span>
                            <div class="module-info">
                                <p class="module-name">Articles</p>
                                <p class="module-status">Coming Q2 2024</p>
                            </div>
                            <span class="slider-badge coming-soon">Coming Soon</span>
                        </div>
                        
                        <div class="slider-item coming-soon">
                            <span class="icon">üìö</span>
                            <div class="module-info">
                                <p class="module-name">Grammar</p>
                                <p class="module-status">Coming Q2 2024</p>
                            </div>
                            <span class="slider-badge coming-soon">Coming Soon</span>
                        </div>
                        
                        <div class="slider-item coming-soon">
                            <span class="icon">üí¨</span>
                            <div class="module-info">
                                <p class="module-name">Conversations</p>
                                <p class="module-status">Coming Q3 2024</p>
                            </div>
                            <span class="slider-badge coming-soon">Coming Soon</span>
                        </div>
                        
                        <div class="slider-item coming-soon">
                            <span class="icon">üìÖ</span>
                            <div class="module-info">
                                <p class="module-name">Days, time and Calendar</p>
                                <p class="module-status">Coming Q3 2024</p>
                            </div>
                            <span class="slider-badge coming-soon">Coming Soon</span>
                        </div>
                    </div>
                    
                    <div class="scroll-hint">
                        ‚Üë Scroll to see more modules ‚Üì
                    </div>
                </div>
            </aside>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Hero Section -->
                <section class="hero">
                    <h1>French for Beginners</h1>
                    <p>Start your French learning journey with our comprehensive beginner modules. Master the fundamentals of French language through interactive lessons, audio pronunciation guides, and structured learning paths.</p>
                </section>

                <!-- Learning Modules Section -->
                <section class="modules-section">
                    <h2 class="section-title">Choose Your Learning Module</h2>
                    <p class="section-subtitle">Select from our three foundational French learning modules, each designed with interactive exercises, audio pronunciation, and detailed explanations to help you master the basics.</p>
                    
                    <div class="modules-grid">
                        <!-- French Alphabets Module -->
                        <div class="module-card">
                            <span class="module-icon">üî§</span>
                            <h3>French Alphabets</h3>
                            <p>Master the foundation of French with comprehensive alphabet learning. Each letter includes pronunciation guides, IPA symbols, example words, and interactive audio practice to help you perfect your French pronunciation from the very beginning.</p>
                            <a href="French-Alphabets.html" class="module-link">
                                Explore Alphabets ‚Üí
                            </a>
                        </div>

                        <!-- French Numbers Module -->
                        <div class="module-card premium-module" data-feature="numbers-module">
                            <span class="premium-badge">üíé PREMIUM</span>
                            <span class="module-icon">üî¢</span>
                            <h3>French Numbers</h3>
                            <p>Learn French numbers from 1 to 100 with detailed pronunciation guides and audio support. Master the unique French counting system including the distinctive patterns for 70-99 that make French numbers special.</p>
                            <a href="#" class="module-link" onclick="return handleNumbersAccess(event, 'French-Numbers.html')">
                                Practice Numbers ‚Üí
                            </a>
                        </div>

                        <!-- French Verbs Module -->
                        <div class="module-card">
                            <span class="module-icon">üìù</span>
                            <h3>French Verbs</h3>
                            <p>Learn French verb conjugations across all major groups: -er, -ir, and -re verbs. Includes example sentences, audio pronunciation, and comprehensive conjugation tables to build your French communication skills.</p>
                            <a href="French-Verbs.html" class="module-link">
                                Study Verbs ‚Üí
                            </a>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signUpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('signUpModal')">&times;</span>
            <h2>Create Account</h2>
            <div id="signUpError" class="error-message"></div>
            <div id="signUpSuccess" class="success-message"></div>
            <form id="signUpForm">
                <div class="form-group">
                    <label for="signUpEmail">Email Address</label>
                    <input type="email" id="signUpEmail" name="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signUpPassword">Password</label>
                    <input type="password" id="signUpPassword" name="password" required placeholder="Enter your password">
                </div>
                <div class="form-group">
                    <label for="signUpName">Full Name</label>
                    <input type="text" id="signUpName" name="name" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signUpCountry">Country</label>
                    <select id="signUpCountry" name="country" required>
                        <option value="">Select your country</option>
                        <option value="Canada">üá®üá¶ Canada</option>
                        <option value="India">üáÆüá≥ India</option>
                        <option value="United States">üá∫üá∏ United States</option>
                        <option value="United Kingdom">üá¨üáß United Kingdom</option>
                        <option value="Germany">üá©üá™ Germany</option>
                        <option value="France">üá´üá∑ France</option>
                        <option value="Japan">üáØüáµ Japan</option>
                        <option value="Australia">üá¶üá∫ Australia</option>
                        <option value="Other">üåê Other</option>
                    </select>
                </div>
                <button type="submit" class="auth-btn" id="signUpBtn">
                    <span id="signUpBtnText">Create Account</span>
                    <span id="signUpSpinner" class="spinner"></span>
                </button>
            </form>
            <div class="switch-auth">
                Already have an account? <a href="#" onclick="switchToSignIn()">Sign In</a>
            </div>
        </div>
    </div>

    <!-- Sign In Modal -->
    <div id="signInModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('signInModal')">&times;</span>
            <h2>Welcome Back</h2>
            <div id="signInError" class="error-message"></div>
            <div id="signInSuccess" class="success-message"></div>
            <form id="signInForm" novalidate>
                <div class="form-group">
                    <label for="signInEmail">Email Address</label>
                    <input type="email" id="signInEmail" name="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signInPassword">Password</label>
                    <input type="password" id="signInPassword" name="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="auth-btn" id="signInBtn">
                    <span id="signInBtnText">Sign In</span>
                    <span id="signInSpinner" class="spinner"></span>
                </button>
            </form>
            <div class="switch-auth">
                Don't have an account? <a href="#" onclick="switchToSignUp()">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal">
        <div class="modal-content subscription-modal-content">
            <span class="close" onclick="closeModal('subscriptionModal')">&times;</span>
            <h2>üåü Upgrade to Premium</h2>
            <div id="subscriptionError" class="error-message"></div>
            <div id="subscriptionSuccess" class="success-message"></div>
            
            <div class="subscription-plans">
                <div class="plan-card" onclick="selectPlan('monthly')" id="monthlyPlan">
                    <div class="plan-name">Monthly Premium</div>
                    <div class="plan-price">
                        <span class="currency">$</span>9.99<span class="period">/month</span>
                    </div>
                    <ul class="plan-features">
                        <li>Unlimited access to all modules</li>
                        <li>Advanced pronunciation guides</li>
                        <li>Interactive exercises</li>
                        <li>Progress tracking</li>
                        <li>Downloadable content</li>
                        <li>Priority support</li>
                    </ul>
                </div>
                
                <div class="plan-card popular" onclick="selectPlan('quarterly')" id="quarterlyPlan">
                    <div class="plan-name">Quarterly Premium</div>
                    <div class="plan-price">
                        <span class="currency">$</span>26.99<span class="period">/3 months</span>
                    </div>
                    <div style="background: #3498db; color: white; padding: 0.3rem; border-radius: 15px; margin: 0.5rem 0; font-weight: 600; font-size: 0.7rem;">
                        Save $3.98 (10% off)
                    </div>
                    <ul class="plan-features">
                        <li>Everything in Monthly Premium</li>
                        <li>10% discount vs monthly</li>
                        <li>Quarterly progress reports</li>
                        <li>Flexible learning schedule</li>
                        <li>Mid-term assessments</li>
                        <li>Enhanced support</li>
                    </ul>
                </div>
                
                <div class="plan-card premium" onclick="selectPlan('yearly')" id="yearlyPlan">
                    <div class="plan-name">Yearly Premium</div>
                    <div class="plan-price">
                        <span class="currency">$</span>99.99<span class="period">/year</span>
                    </div>
                    <div style="background: #ff8c00; color: white; padding: 0.5rem; border-radius: 20px; margin: 1rem 0; font-weight: 600;">
                        Save $19.89 (17% off)
                    </div>
                    <ul class="plan-features">
                        <li>Everything in Monthly Premium</li>
                        <li>2 months free (14 months total)</li>
                        <li>Advanced AI tutoring</li>
                        <li>Custom learning paths</li>
                        <li>Offline mode</li>
                        <li>Certificate of completion</li>
                    </ul>
                </div>
            </div>

            <div class="payment-section" id="paymentSection" style="display: none;">
                <h3>üí≥ Payment Information</h3>
                <div class="payment-form">
                    <div class="form-group">
                        <label for="cardholderName">Cardholder Name</label>
                        <input type="text" id="cardholderName" name="cardholderName" required placeholder="Enter cardholder name">
                    </div>
                    
                    <div class="form-group">
                        <label for="card-element">Credit or Debit Card</label>
                        <div id="card-element">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <div id="card-errors" role="alert" style="color: #721c24; margin-top: 0.5rem;"></div>
                    </div>

                    <button type="button" class="subscription-btn-modal" id="subscribeBtn" onclick="processPayment()">
                        <span id="subscribeBtnText">Complete Payment & Subscribe</span>
                        <span id="subscribeSpinner" class="spinner"></span>
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.85rem;">
                <p style="margin: 0.25rem 0;">üîí Secure payment processing by Stripe</p>
                <p style="margin: 0.25rem 0;">Cancel anytime ‚Ä¢ 30-day money-back guarantee</p>
            </div>
        </div>
    </div>

    <!-- Stripe.js (Tech-Pay Centralized Payment System) -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Firebase SDK (v9 compat - standardized) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration (matching working pages)
        let firebaseInitialized = false;
        let auth, db;
        
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyA12z5FR90bSz1x5Q3ay-uJxV8xNOS_xjk",
                authDomain: "french-learning-app-46d95.firebaseapp.com",
                projectId: "french-learning-app-46d95",
                storageBucket: "french-learning-app-46d95.firebasestorage.app",
                messagingSenderId: "270430812441",
                appId: "1:270430812441:web:3fa199a9131794e90c2d88",
                measurementId: "G-GHZV5LJH4P"
            };

            // Check if Firebase is loaded before initializing
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('‚úÖ Firebase initialized successfully');
            } else {
                console.warn('‚ö†Ô∏è Firebase SDK not loaded, authentication will use fallback');
            }
        } catch (firebaseError) {
            console.warn('‚ö†Ô∏è Firebase initialization failed, using fallback auth:', firebaseError.message);
            // Don't show error to user, just use fallback authentication
        }

        // Make auth and db available globally
        window.auth = auth;
        window.db = db;

        // Firebase authentication functions (matching working pages)
        function firebaseSignUp(email, password, name, country) {
            return auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Update user profile with name
                    return user.updateProfile({
                        displayName: name
                    }).then(() => {
                        // Store additional user data in Firestore with subscription info
                        return db.collection('users').doc(user.uid).set({
                            email: email,
                            name: name,
                            country: country,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            subscription: {
                                status: 'free',
                                plan: null,
                                startDate: null,
                                endDate: null,
                                active: false,
                                paymentMethod: null
                            },
                            subscriptionHistory: []
                        });
                    }).then(() => {
                        return user;
                    });
                });
        }

        function firebaseSignIn(email, password) {
            if (!firebaseInitialized || !auth) {
                console.warn('‚ö†Ô∏è Firebase not available, this should not happen in normal flow');
                return Promise.reject(new Error('Authentication service temporarily unavailable'));
            }
            return auth.signInWithEmailAndPassword(email, password);
        }

        // Authentication state management
        function toggleAuthButtons(isSignedIn, userName = '', subscriptionStatus = 'free') {
            console.log('üîÑ toggleAuthButtons called:', { isSignedIn, userName, subscriptionStatus });
            
            const authButtons = document.querySelector('.auth-buttons');
            const userStatus = document.getElementById('userStatus');
            const userGreeting = document.getElementById('userGreeting');
            const subscriptionStatusSpan = document.getElementById('subscriptionStatus');
            const signOutBtn = document.getElementById('signOutBtn');
            const donateBtn = document.querySelector('.nav-donate');
            
            console.log('üîç DOM elements found:', {
                authButtons: !!authButtons,
                userStatus: !!userStatus,
                userGreeting: !!userGreeting,
                subscriptionStatusSpan: !!subscriptionStatusSpan,
                signOutBtn: !!signOutBtn
            });
            
            if (isSignedIn) {
                // User is signed in - show user status and hide sign in/up buttons
                console.log('üë§ Showing user status for:', userName);
                
                // Validate userName to prevent password from being displayed
                const displayName = (userName && typeof userName === 'string' && userName.trim() && !userName.includes('@')) 
                    ? userName.trim() 
                    : 'User';
                
                if (authButtons) {
                    const signInBtn = authButtons.querySelector('.sign-in-btn');
                    const signUpBtn = authButtons.querySelector('.sign-up-btn');
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (signUpBtn) signUpBtn.style.display = 'none';
                }
                
                if (userStatus) userStatus.style.display = 'flex';
                if (userGreeting) userGreeting.textContent = `Welcome, ${displayName}!`;
                if (signOutBtn) signOutBtn.style.display = 'inline-block';
                // Show Support Us button only for premium users
                if (donateBtn) {
                    if (subscriptionStatus === 'premium') {
                        donateBtn.style.display = 'block';
                        console.log('‚úÖ Support Us button shown for premium user');
                    } else {
                        donateBtn.style.display = 'none';
                        console.log('‚ùå Support Us button hidden for non-premium user');
                    }
                }
                
                // Update subscription status
                if (subscriptionStatusSpan) {
                    subscriptionStatusSpan.textContent = subscriptionStatus === 'premium' ? 'Premium' : 'Free';
                    subscriptionStatusSpan.className = `subscription-status ${subscriptionStatus}`;
                }
                
                // Handle subscription button based on premium status
                const subscriptionBtn = document.getElementById('subscriptionBtn');
                if (subscriptionBtn) {
                    if (subscriptionStatus === 'premium') {
                        subscriptionBtn.style.display = 'none';
                    } else {
                        subscriptionBtn.style.display = 'inline-flex';
                        subscriptionBtn.textContent = 'üíé Go Premium';
                    }
                }
                
                // Update premium module display based on subscription status
                if (subscriptionStatus === 'premium') {
                    updatePremiumModuleUI();
                } else {
                    // User doesn't have premium - ensure premium badges are visible
                    const premiumBadges = document.querySelectorAll('.premium-badge');
                    const premiumModules = document.querySelectorAll('.premium-module');
                    
                    premiumBadges.forEach(badge => {
                        badge.style.display = 'block';
                    });
                    premiumModules.forEach(module => {
                        module.classList.remove('premium-unlocked');
                    });
                }
                
            } else {
                // User is signed out - show sign in/up buttons and hide user status
                console.log('üö™ Hiding user status, showing sign in/up buttons');
                
                if (authButtons) {
                    const signInBtn = authButtons.querySelector('.sign-in-btn');
                    const signUpBtn = authButtons.querySelector('.sign-up-btn');
                    if (signInBtn) signInBtn.style.display = 'inline-block';
                    if (signUpBtn) signUpBtn.style.display = 'inline-block';
                }
                
                if (userStatus) userStatus.style.display = 'none';
                if (signOutBtn) signOutBtn.style.display = 'none';
                if (donateBtn) donateBtn.style.display = 'none'; // Hide Support Us button when signed out
                
                // Reset user name and subscription status to default guest state
                if (userGreeting) userGreeting.textContent = 'Welcome!';
                
                // Force reset subscription UI to free/guest state
                if (subscriptionStatusSpan) {
                    subscriptionStatusSpan.textContent = 'Free';
                    subscriptionStatusSpan.className = 'subscription-status free';
                }
                
                // Show subscription button for signed-out users
                const subscriptionBtn = document.getElementById('subscriptionBtn');
                if (subscriptionBtn) {
                    subscriptionBtn.style.display = 'inline-flex';
                    subscriptionBtn.textContent = 'üíé Go Premium';
                }
                
                // Show premium badges for signed-out users
                const premiumModules = document.querySelectorAll('.premium-module');
                const premiumBadges = document.querySelectorAll('.premium-badge');
                
                premiumBadges.forEach(badge => {
                    badge.style.display = 'block';
                });
                premiumModules.forEach(module => {
                    module.classList.remove('premium-unlocked');
                });
                
                console.log('‚úÖ UI reset to guest state');
            }
            
            console.log('‚úÖ toggleAuthButtons completed');
        }

                // Firebase auth state listener (standardized pattern)
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(async function(user) {
                console.log('üîÑ Firebase onAuthStateChanged triggered:', {
                    hasUser: !!user,
                    userEmail: user?.email,
                    currentUrl: window.location.href
                });

                // CRITICAL: Check for sign-out flags before doing anything
                const urlParams = new URLSearchParams(window.location.search);
                const sessionFlags = {
                    signedOut: urlParams.get('signedOut') === 'true' || urlParams.get('firebaseSignedOut') === 'true',
                    forceGuest: urlParams.get('forceGuest') === 'true',
                    justSignedOut: sessionStorage.getItem('just_signed_out') === 'true',
                    firebaseSignedOut: sessionStorage.getItem('firebase_signed_out') === 'true',
                    forceGuestState: sessionStorage.getItem('force_guest_state') === 'true'
                };

                const isSignOutProcess = Object.values(sessionFlags).some(flag => flag) || window.FORCE_GUEST_MODE;

                if (isSignOutProcess) {
                    console.log('üö´ SIGN-OUT PROCESS DETECTED');
                    if (user) {
                        firebase.auth().signOut().catch(error => {
                            console.log('Firebase sign-out error (ignored):', error);
                        });
                    }
                    localStorage.removeItem('french_app_current_user');
                    if (typeof toggleAuthButtons === 'function') {
                        toggleAuthButtons(false);
                    }
                    return;
                }

                if (user) {
                    console.log('‚úÖ Valid user sign-in detected - syncing localStorage...');
                    try {
                        const subscriptionStatus = await getUserSubscriptionStatus(user.uid);
                        
                        const doc = await firebase.firestore().collection('users').doc(user.uid).get();
                        let userData = {
                            email: user.email,
                            name: user.displayName || user.email,
                            country: null,
                            registeredAt: new Date().toISOString(),
                            subscription: {
                                status: subscriptionStatus,
                                plan: null,
                                startDate: null,
                                endDate: null
                            }
                        };
                        
                        if (doc.exists) {
                            const firestoreData = doc.data();
                            userData.subscription = {
                                status: subscriptionStatus,
                                plan: firestoreData.subscription?.plan || null,
                                startDate: firestoreData.subscription?.startDate || null,
                                endDate: firestoreData.subscription?.endDate || null,
                                active: firestoreData.subscription?.active || false,
                                paymentMethod: firestoreData.subscription?.paymentMethod || null
                            };
                            userData.name = firestoreData.name || userData.name;
                            userData.country = firestoreData.country || null;
                            userData.registeredAt = firestoreData.createdAt ? firestoreData.createdAt.toDate().toISOString() : userData.registeredAt;
                        }
                        
                        localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                        if (typeof toggleAuthButtons === 'function') {
                            toggleAuthButtons(true, user.displayName || user.email, userData.subscription.status);
                        }
                        
                        // Update premium module UI if applicable
                        if (userData.subscription.status === 'premium' && typeof updatePremiumModuleUI === 'function') {
                            updatePremiumModuleUI();
                        }
                        
                        console.log('‚úÖ localStorage synced for authenticated user');
                    } catch (error) {
                        console.error('Error getting user subscription:', error);
                        const userData = {
                            email: user.email,
                            name: user.displayName || user.email,
                            country: null,
                            registeredAt: new Date().toISOString(),
                            subscription: { status: 'free', plan: null, startDate: null, endDate: null }
                        };
                        localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                        if (typeof toggleAuthButtons === 'function') {
                            toggleAuthButtons(true, user.displayName || user.email, 'free');
                        }
                    }
                } else {
                    console.log('üö´ No Firebase user - clearing localStorage and setting guest state');
                    localStorage.removeItem('french_app_current_user');
                    if (typeof toggleAuthButtons === 'function') {
                        toggleAuthButtons(false);
                    }
                }
            }, function(error) {
                console.warn('üõ°Ô∏è Auth state change error caught silently:', error.message);
            });
        }



        // Manual auth state check function for testing
        window.debugAuthState = function() {
            console.log('üêõ Manual auth state check triggered');
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            console.log('üîç Current user in localStorage:', currentUser);
            console.log('üî• Firebase user:', firebase.auth().currentUser);
            
            if (currentUser) {
                toggleAuthButtons(true, currentUser.name, currentUser.subscription?.status || 'free');
                if (currentUser.subscription?.status === 'premium' && typeof updatePremiumModuleUI === 'function') {
                    updatePremiumModuleUI();
                }
                         } else {
                 toggleAuthButtons(false);
             }
        };

        // Force Firebase sync function for debugging
        window.forceFirebaseSync = async function() {
            console.log('üîÑ Force Firebase sync triggered');
            const user = firebase.auth().currentUser;
            if (user) {
                console.log('üë§ Current Firebase user:', user.email);
                const subscriptionStatus = await getUserSubscriptionStatus(user.uid);
                console.log('üìä Subscription status from Firebase:', subscriptionStatus);
                
                const userData = {
                    email: user.email,
                    name: user.displayName || user.email,
                    subscription: { status: subscriptionStatus }
                };
                
                localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                toggleAuthButtons(true, userData.name, subscriptionStatus);
                
                if (subscriptionStatus === 'premium' && typeof updatePremiumModuleUI === 'function') {
                    updatePremiumModuleUI();
                }
                
                console.log('‚úÖ Firebase sync completed');
            } else {
                console.log('üö´ No Firebase user found');
                localStorage.removeItem('french_app_current_user');
                toggleAuthButtons(false);
            }
        };

        // Test function to simulate premium user
        window.testPremiumUser = function() {
            console.log('üß™ Testing premium user state');
            const testUser = {
                email: 'test@premium.com',
                name: 'Premium User',
                uid: 'test-premium-uid',
                subscription: { status: 'premium' }
            };
            localStorage.setItem('french_app_current_user', JSON.stringify(testUser));
            toggleAuthButtons(true, testUser.name, 'premium');
        };

        // Test function to simulate free user
        window.testFreeUser = function() {
            console.log('üß™ Testing free user state');
            const testUser = {
                email: 'test@free.com',
                name: 'Free User',
                uid: 'test-free-uid',
                subscription: { status: 'free' }
            };
            localStorage.setItem('french_app_current_user', JSON.stringify(testUser));
            toggleAuthButtons(true, testUser.name, 'free');
        };

        // Check authentication state immediately when script loads
        setTimeout(() => {
            console.log('‚è∞ Immediate auth check (after timeout)');
            checkInitialAuthState();
        }, 100);

        // Also check on DOM content loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM loaded - rechecking authentication state');
                setTimeout(() => checkInitialAuthState(), 200);
            });
        } else {
            console.log('üìÑ DOM already loaded - checking auth state immediately');
            setTimeout(() => checkInitialAuthState(), 100);
        }

        // Window load authentication check (standardized pattern)
        window.addEventListener('load', function() {
            console.log('üåê Window load event fired - checking auth');
            
            // Small delay to ensure DOM is fully ready and prevent flash
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                if (currentUser) {
                    console.log('üë§ User found on page load:', {
                        email: currentUser.email,
                        name: currentUser.name,
                        subscriptionStatus: currentUser.subscription?.status
                    });
                    
                    // Pass subscription status to toggleAuthButtons
                    toggleAuthButtons(true, currentUser.name, currentUser.subscription?.status || 'free');
                    
                    // Force menu access update after a short delay
                    setTimeout(() => {
                        if (currentUser.subscription?.status === 'premium') {
                            console.log('üëë Premium user detected on page load');
                            if (typeof updatePremiumModuleUI === 'function') {
                                updatePremiumModuleUI();
                            }
                        }
                    }, 200);
                } else {
                    console.log('üö∂ No user found on page load - guest mode');
                    toggleAuthButtons(false);
                }
            }, 50);
        });

        // Listen for localStorage changes from other tabs/pages
        window.addEventListener('storage', function(event) {
            if (event.key === 'french_app_current_user') {
                console.log('üîÑ localStorage changed from another tab:', event.newValue);
                setTimeout(() => {
                    const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                    if (currentUser) {
                        toggleAuthButtons(true, currentUser.name, currentUser.subscription?.status || 'free');
                        if (currentUser.subscription?.status === 'premium' && typeof updatePremiumModuleUI === 'function') {
                            updatePremiumModuleUI();
                        }
                    } else {
                        toggleAuthButtons(false);
                    }
                }, 100);
            }
        });

        // Handle browser navigation (back/forward buttons)
        window.addEventListener('pageshow', function(event) {
            console.log('üîÑ pageshow event fired - syncing auth state');
            
            // Small delay to prevent flash on browser navigation
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                if (currentUser) {
                    console.log('üë§ User found on pageshow:', {
                        email: currentUser.email,
                        subscriptionStatus: currentUser.subscription?.status
                    });
                    toggleAuthButtons(true, currentUser.name, currentUser.subscription?.status || 'free');
                    
                    if (currentUser.subscription?.status === 'premium' && typeof updatePremiumModuleUI === 'function') {
                        updatePremiumModuleUI();
                    }
                } else {
                    console.log('üö∂ No user found on pageshow - guest mode');
                    toggleAuthButtons(false);
                }
            }, 30);
        });



        // Function to get validated subscription status from Firebase
        async function getUserSubscriptionStatus(userId) {
            try {
                console.log('üîç getUserSubscriptionStatus called for userId:', userId);
                const doc = await firebase.firestore().collection('users').doc(userId).get();
                
                if (doc.exists) {
                    const userData = doc.data();
                    const subscription = userData.subscription || { status: 'free' };
                    
                    // Check if subscription is expired
                    if (subscription.status === 'premium' && subscription.endDate) {
                        const endDate = subscription.endDate.toDate ? subscription.endDate.toDate() : new Date(subscription.endDate);
                        if (endDate < new Date()) {
                            await firebase.firestore().collection('users').doc(userId).update({
                                'subscription.status': 'expired',
                                'subscription.active': false
                            });
                            return 'expired';
                        }
                    }
                    
                    return subscription.status || 'free';
                }
                
                return 'free';
            } catch (error) {
                console.error('‚ùå Error getting subscription status:', error);
                return 'free';
            }
        }

        // Global functions
        window.signOut = async function() {
            try {
                console.log('üö™ Signing out user...');
                
                // Clear localStorage
                localStorage.removeItem('french_app_current_user');
                
                // Sign out from Firebase
                await auth.signOut();
                
                // Update UI immediately
                toggleAuthButtons(false);
                
                console.log('‚úÖ Sign out completed');
                
                // Optional: reload page to ensure clean state
                // window.location.reload();
            } catch (error) {
                console.error('‚ùå Error signing out:', error);
            }
        };

        // Dropdown functionality
        window.toggleDropdown = function(event, dropdownId) {
            event.preventDefault();
            event.stopPropagation();
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                if (dropdown.id !== dropdownId) {
                    dropdown.classList.remove('show');
                }
            });

            // Toggle the current dropdown
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');

            // Rotate arrow
            const arrow = event.target.closest('.dropdown-toggle').querySelector('.dropdown-arrow');
            if (dropdown.classList.contains('show')) {
                arrow.style.transform = 'rotate(180deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-arrow').forEach(arrow => {
                    arrow.style.transform = 'rotate(0deg)';
                });
            }
        });

        // Numbers access handler
        window.handleNumbersAccess = function(event, targetUrl) {
            event.preventDefault();
            
            console.log('üî¢ handleNumbersAccess called:', {
                hasTargetUrl: !!targetUrl,
                targetUrl: targetUrl,
                clickedElement: event.target.textContent.trim()
            });
            
            // Check both Firebase auth and localStorage
            const firebaseUser = auth.currentUser;
            const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            
            if (!firebaseUser && !localUser) {
                console.log('‚ùå User not signed in');
                alert('üîê Please sign in first to access French Numbers.\n\nThis is a premium feature that requires an account.');
                openSignInModal();
                return false;
            }

            console.log('üë§ User found:', {
                email: localUser?.email,
                subscriptionStatus: localUser?.subscription?.status
            });

            // Check subscription status for premium content
            const subscriptionStatus = localUser?.subscription?.status || 'free';
            
            if (subscriptionStatus === 'premium') {
                // User has premium access
                console.log('‚úÖ Premium user detected, navigating to:', targetUrl);
                
                if (targetUrl) {
                    window.location.href = targetUrl;
                } else {
                    // Default to French Numbers page
                    window.location.href = 'French-Numbers.html';
                }
                return true;
            } else {
                // User needs premium subscription - show upgrade popup
                console.log('üîí Free user, showing premium upgrade popup');
                
                // Clear any existing messages first
                clearMessages();
                
                // Open the subscription modal instead of just showing an alert
                console.log('üéØ Opening subscription modal for upgrade...');
                openSubscriptionModal('numbers');
                
                return false;
            }
        };

        // Navigation helper
        window.navigateToModule = function(url) {
            window.location.href = url;
        };

        // Modal functions
        window.openSignInModal = function() {
            document.getElementById('signInModal').style.display = 'block';
            clearMessages();
        };

        window.openSignUpModal = function() {
            document.getElementById('signUpModal').style.display = 'block';
            clearMessages();
        };

        // Tech-Pay Centralized Payment System Configuration
        // Environment Configuration - UPDATE FOR LIVE INTEGRATION
        const STRIPE_CONFIG = {
            environment: 'live',  // 'test' or 'live' - LIVE ENVIRONMENT ACTIVATED
            test: {
                publishableKey: 'pk_test_TYooMQauvdEDq54NiTphI7jx',
            },
            live: {
                publishableKey: 'pk_live_51Rr5H03QiDHRr52effkP2HrTynAiO7NYD8VQfmbQiHTfpj3zvbw7q4p3uSeRWHHK0ehhHAoYqHyxXwIjmuyGVz3Q00BJL8lkM9',
            }
        };

        // Get current Stripe publishable key based on environment
        function getStripePublishableKey() {
            const config = STRIPE_CONFIG[STRIPE_CONFIG.environment];
            console.log(`üîß Using ${STRIPE_CONFIG.environment} Stripe environment`);
            return config.publishableKey;
        }

        // Global Stripe variables (from Tech-Pay.html)
        let selectedPlan = null;
        let stripe = null;
        let elements = null;
        let cardElement = null;

        // Live Payment Helper Function
        function logPaymentSuccess(paymentIntent, planType, currency, amount) {
            console.log('üìä Payment Success Log:', {
                payment_id: paymentIntent?.id || 'demo_' + Date.now(),
                plan: planType,
                currency: currency,
                amount: amount,
                timestamp: new Date().toISOString(),
                environment: STRIPE_CONFIG.environment
            });

            // Store payment info in localStorage for tracking
            const paymentHistory = JSON.parse(localStorage.getItem('payment_history') || '[]');
            paymentHistory.push({
                id: paymentIntent?.id || 'demo_' + Date.now(),
                plan: planType,
                currency: currency,
                amount: amount,
                date: new Date().toISOString(),
                status: 'completed'
            });
            localStorage.setItem('payment_history', JSON.stringify(paymentHistory));
        }

        // Country-specific pricing functions (Enhanced Firebase integration)
        async function getUserCurrency() {
            try {
                // First, try to get country from Firebase Firestore
                const firebaseUser = (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) ? firebase.auth().currentUser : null;
                
                if (firebaseUser && typeof firebase.firestore !== 'undefined') {
                    console.log('üîç Checking Firebase for country data for user:', firebaseUser.uid);
                    
                    try {
                        const doc = await firebase.firestore().collection('users').doc(firebaseUser.uid).get();
                        if (doc.exists) {
                            const userData = doc.data();
                            const firebaseCountry = userData.country;
                            
                            console.log('üåç Firebase country data:', firebaseCountry);
                            
                            if (firebaseCountry) {
                                // Update localStorage with Firebase data
                                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                                currentUser.country = firebaseCountry;
                                localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                                
                                if (firebaseCountry === 'Canada') {
                                    console.log('üí∞ Using CAD currency for Canada (from Firebase)');
                                    return 'CAD';
                                } else if (firebaseCountry === 'India') {
                                    console.log('üí∞ Using INR currency for India (from Firebase)');
                                    return 'INR';
                                }
                            }
                        }
                    } catch (firebaseError) {
                        console.log('‚ö†Ô∏è Firebase query failed, falling back to localStorage:', firebaseError.message);
                    }
                }
                
                // Fallback to localStorage
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                console.log('üí∞ Getting user currency from localStorage for:', currentUser.country);
                
                if (currentUser.country === 'Canada') {
                    return 'CAD';
                } else if (currentUser.country === 'India') {
                    return 'INR';
                }
                
                // Default to USD for other countries or if no country specified
                console.log('üí∞ Using USD currency (default/fallback)');
                return 'USD';
                
            } catch (error) {
                console.error('‚ùå Error in getUserCurrency:', error);
                return 'USD';
            }
        }

        // Function to update subscription pricing based on user's country/currency
        async function updateSubscriptionPricingForUser() {
            try {
                const currency = await getUserCurrency();
                
                console.log('üéØ Updating subscription pricing for currency:', currency);
                
                if (currency === 'CAD') {
                    console.log('üçÅ Applying Canadian pricing');
                    updatePlanPrices('CAD', 13.47, 36.44, 135);
                } else if (currency === 'INR') {
                    console.log('üáÆüá≥ Applying Indian pricing');
                    updatePlanPrices('INR', 499, 1497, 5988);
                } else {
                    // Use default USD pricing for other countries
                    console.log('üá∫üá∏ Using default USD pricing');
                    updatePlanPrices('USD', 9.99, 26.99, 99.99);
                }
            } catch (error) {
                console.error('‚ùå Error in updateSubscriptionPricingForUser:', error);
                // Fallback to USD
                updatePlanPrices('USD', 9.99, 26.99, 99.99);
            }
        }

        function updatePlanPrices(currency, monthly, quarterly, yearly) {
            // Update the main price display
            const monthlyPrice = document.querySelector('#monthlyPlan .plan-price');
            const quarterlyPrice = document.querySelector('#quarterlyPlan .plan-price');
            const yearlyPrice = document.querySelector('#yearlyPlan .plan-price');
            
            const symbol = currency === 'CAD' ? '$' : currency === 'INR' ? '‚Çπ' : '$';
            
            console.log('üí∞ Updating plan prices to:', currency, { monthly, quarterly, yearly });
            
            if (monthlyPrice) {
                monthlyPrice.innerHTML = `<span class="currency">${symbol}</span>${monthly}<span class="period">/month</span>`;
                console.log('‚úÖ Updated monthly price');
            } else {
                console.log('‚ö†Ô∏è Monthly price element not found');
            }
            
            if (quarterlyPrice) {
                quarterlyPrice.innerHTML = `<span class="currency">${symbol}</span>${quarterly}<span class="period">/3 months</span>`;
                console.log('‚úÖ Updated quarterly price');
            } else {
                console.log('‚ö†Ô∏è Quarterly price element not found');
            }
            
            if (yearlyPrice) {
                yearlyPrice.innerHTML = `<span class="currency">${symbol}</span>${yearly}<span class="period">/year</span>`;
                console.log('‚úÖ Updated yearly price');
            } else {
                console.log('‚ö†Ô∏è Yearly price element not found');
            }
        }

        // Function to update premium module UI after upgrade
        function updatePremiumModuleUI() {
            console.log('üé® Updating premium module UI...');
            
            // Get all premium modules
            const premiumModules = document.querySelectorAll('.premium-module');
            const premiumBadges = document.querySelectorAll('.premium-badge');
            
            // Hide premium badges and update module styling
            premiumBadges.forEach(badge => {
                badge.style.display = 'none';
            });
            
            premiumModules.forEach(module => {
                // Add premium unlocked styling
                module.classList.add('premium-unlocked');
                
                // Update the module link text to remove premium indicators
                const moduleLink = module.querySelector('.module-link');
                if (moduleLink && moduleLink.textContent.includes('Premium')) {
                    moduleLink.textContent = moduleLink.textContent.replace(' (Premium)', '').replace('Practice Numbers ‚Üí', 'Practice Numbers ‚Üí');
                }
            });
            
            console.log('‚úÖ Premium module UI updated successfully');
        }

        window.openSubscriptionModal = function(fromFeature = null) {
            console.log('üéØ Opening subscription modal...', fromFeature ? `from ${fromFeature}` : '');
            
            // Check both Firebase auth and localStorage for current user
            const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            const firebaseUser = (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) ? firebase.auth().currentUser : null;
            
            if (!localUser && !firebaseUser) {
                alert('Please sign in first to subscribe.');
                openSignInModal();
                return;
            }
            
            // If Firebase user exists but localStorage doesn't, sync them
            if (firebaseUser && !localUser) {
                const userData = {
                    email: firebaseUser.email,
                    name: firebaseUser.displayName || firebaseUser.email,
                    registeredAt: new Date().toISOString(),
                    subscription: {
                        status: 'free',
                        plan: null,
                        startDate: null,
                        endDate: null
                    }
                };
                localStorage.setItem('french_app_current_user', JSON.stringify(userData));
            }
            
            // Reset modal state
            selectedPlan = null;
            document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('paymentSection').style.display = 'none';
            
            // Show modal
            document.getElementById('subscriptionModal').style.display = 'block';
            clearMessages();
            
            // Update pricing based on user's currency/country from Firebase
            console.log('üîÑ Updating pricing based on user currency...');
            updateSubscriptionPricingForUser().catch(error => {
                console.error('‚ùå Error updating pricing:', error);
                // Fallback to USD pricing if error
                updatePlanPrices('USD', 9.99, 26.99, 99.99);
            });
            
            // Show contextual message based on how modal was opened
            if (fromFeature === 'numbers') {
                showSuccess('subscriptionSuccess', 'üî¢ Upgrade to Premium to unlock French Numbers learning! Select a plan below to get started.');
            } else {
                showSuccess('subscriptionSuccess', 'üëÜ Please select a plan above to continue with payment');
            }
            
            // Initialize Stripe if not already done
            if (!stripe) {
                console.log('üîÑ Initializing Stripe...');
                initializeStripe();
            }
            
            console.log('‚úÖ Subscription modal opened successfully');
        };

        // Plan selection function
        window.selectPlan = async function(planType) {
            console.log('üéØ Plan selected:', planType);
            
            try {
                selectedPlan = planType;
                
                // Clear any existing error messages
                clearMessages();
                
                // Update UI - remove selected class from all cards
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Add selected class to the chosen plan
                const selectedCard = document.getElementById(planType + 'Plan');
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    console.log('‚úÖ Plan card updated:', planType + 'Plan');
                } else {
                    console.error('‚ùå Could not find plan card:', planType + 'Plan');
                }
                
                // Show payment section with smooth transition
                const paymentSection = document.getElementById('paymentSection');
                if (paymentSection) {
                    paymentSection.style.display = 'block';
                    paymentSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    console.log('‚úÖ Payment section shown');
                } else {
                    console.error('‚ùå Could not find payment section');
                }
                
                // Update button text with correct pricing based on user's currency
                const userCurrency = await getUserCurrency();
                let amount;
                
                if (userCurrency === 'CAD') {
                    if (planType === 'monthly') {
                        amount = '$13.47 CAD/month';
                    } else if (planType === 'quarterly') {
                        amount = '$36.44 CAD/3 months';
                    } else if (planType === 'yearly') {
                        amount = '$135 CAD/year';
                    }
                } else if (userCurrency === 'INR') {
                    if (planType === 'monthly') {
                        amount = '‚Çπ499 INR/month';
                    } else if (planType === 'quarterly') {
                        amount = '‚Çπ1,497 INR/3 months';
                    } else if (planType === 'yearly') {
                        amount = '‚Çπ5,988 INR/year';
                    }
                } else {
                    // Default USD pricing
                    if (planType === 'monthly') {
                        amount = '$9.99 USD/month';
                    } else if (planType === 'quarterly') {
                        amount = '$26.99 USD/3 months';
                    } else if (planType === 'yearly') {
                        amount = '$99.99 USD/year';
                    }
                }
                
                const btnText = document.getElementById('subscribeBtnText');
                if (btnText) {
                    btnText.textContent = `Complete Payment ${amount}`;
                    console.log('‚úÖ Button text updated with currency:', amount, 'for user currency:', userCurrency);
                } else {
                    console.error('‚ùå Could not find subscribe button text');
                }
                
                // Initialize Stripe if not already done
                if (!stripe) {
                    console.log('üîÑ Initializing Stripe...');
                    initializeStripe();
                }
                
                // Show success message for plan selection
                const planName = planType === 'monthly' ? 'Monthly' : planType === 'quarterly' ? 'Quarterly' : 'Yearly';
                showSuccess('subscriptionSuccess', `${planName} Premium plan selected! Please fill in your payment details below.`);
                
                console.log('üéâ Plan selection completed successfully');
                
            } catch (error) {
                console.error('‚ùå Error in selectPlan:', error);
                showError('subscriptionError', 'There was an error selecting your plan. Please try again.');
            }
        };

        // Tech-Pay Centralized Stripe Initialization (from Tech-Pay.html)
        function initializeStripe() {
            console.log('üîÑ Initializing Stripe...');
            
            if (typeof Stripe === 'undefined') {
                console.error('‚ùå Stripe.js not loaded');
                showError('subscriptionError', 'Payment system not available. Please refresh the page.');
                return;
            }

            try {
                // Initialize Stripe with environment-appropriate key (Tech-Pay System)
                const publishableKey = getStripePublishableKey();
                stripe = Stripe(publishableKey);
                elements = stripe.elements();
                
                // Create card element optimized for international users
                // Supports CAD, INR, USD, and other international cards
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                    hidePostalCode: true // International-friendly: Remove ZIP code requirement
                });
                
                cardElement.mount('#card-element');
                
                // Handle real-time validation errors from the card Element
                cardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('card-errors');
                    if (error) {
                        displayError.textContent = error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
                console.log('‚úÖ Stripe initialized successfully with Tech-Pay system');
                
            } catch (error) {
                console.error('‚ùå Error initializing Stripe:', error);
                showError('subscriptionError', 'Payment system initialization failed. Please refresh the page.');
            }
        }

        // Tech-Pay Centralized Payment Processing (Live Bank Integration Ready)
        window.processPayment = async function() {
            if (!selectedPlan) {
                showError('subscriptionError', 'Please select a subscription plan.');
                return;
            }
            
            const cardholderName = document.getElementById('cardholderName').value;
            if (!cardholderName.trim()) {
                showError('subscriptionError', 'Please enter the cardholder name.');
                return;
            }
            
            // Show loading
            const subscribeBtn = document.getElementById('subscribeBtn');
            const subscribeBtnText = document.getElementById('subscribeBtnText');
            const subscribeSpinner = document.getElementById('subscribeSpinner');
            
            subscribeBtnText.style.display = 'none';
            subscribeSpinner.style.display = 'inline';
            subscribeBtn.disabled = true;
            
            try {
                // Create payment method with Stripe
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                console.log('‚úÖ Payment method created:', paymentMethod.id);
                
                // Get pricing for the selected plan and currency
                const userCurrency = await getUserCurrency();
                let priceInCents;
                
                if (userCurrency === 'CAD') {
                    // Fee-absorbed pricing: Customer pays exactly what's displayed (no surprises!)
                    // Adjusted for 34% markup (taxes, fees, conversion): Display √∑ 1.34
                    priceInCents = selectedPlan === 'monthly' ? 1005 : selectedPlan === 'quarterly' ? 2720 : 10075;
                } else if (userCurrency === 'INR') {
                    // Fee-absorbed pricing for INR (includes all taxes and fees)
                    priceInCents = selectedPlan === 'monthly' ? 37239 : selectedPlan === 'quarterly' ? 111716 : 447015; // Adjusted for fees
                } else {
                    // Fee-absorbed pricing for USD (includes all taxes and fees)
                    priceInCents = selectedPlan === 'monthly' ? 746 : selectedPlan === 'quarterly' ? 2014 : 7462;
                }
                
                console.log('üí≥ Processing payment for:', priceInCents, userCurrency);
                
                // LIVE ENVIRONMENT: Backend Payment Processing with Stripe Payment Intents
                if (STRIPE_CONFIG.environment === 'live') {
                    console.log('üöÄ Processing LIVE payment with backend integration');
                    
                    try {
                        console.log('üí≥ Creating payment intent with backend...');
                        
                        // Get current user for customer details
                        const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                        
                        // Create payment intent via backend
                        const response = await fetch('https://foundation-backend-chi.vercel.app/create-payment-intent', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                planType: selectedPlan,
                                currency: userCurrency,
                                amount: priceInCents,
                                customerEmail: currentUser.email || '',
                                customerName: currentUser.displayName || cardholderName
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Payment setup failed');
                        }
                        
                        const { clientSecret, paymentIntentId } = await response.json();
                        console.log('‚úÖ Payment intent created:', paymentIntentId);
                        
                        // Confirm payment with Stripe
                        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                            payment_method: paymentMethod.id
                        });
                        
                        if (confirmError) {
                            throw new Error(confirmError.message);
                        }
                        
                        if (paymentIntent.status === 'succeeded') {
                            console.log('‚úÖ LIVE payment processed successfully!');
                            console.log('üí∞ Payment Details:', paymentIntent);
                            
                            // Log the successful payment for tracking
                            logPaymentSuccess(paymentIntent, selectedPlan, userCurrency, priceInCents);
                        } else {
                            throw new Error('Payment was not completed successfully');
                        }
                        
                    } catch (liveError) {
                        console.error('‚ùå Live payment processing error:', liveError);
                        
                        // Redirect to error page with details
                        const errorParams = new URLSearchParams({
                            error: liveError.message || 'Payment processing failed',
                            code: liveError.code || 'PAYMENT_FAILED',
                            plan: selectedPlan,
                            amount: priceInCents,
                            currency: userCurrency
                        });
                        
                        window.location.href = 'payment-error.html?' + errorParams.toString();
                        return;
                    }
                } else {
                    // Test environment processing
                    console.log('‚úÖ Payment processed successfully with Stripe using test card');
                }
                
                // Update user subscription in Firebase
                console.log('üí≥ Payment successful, updating Firebase...');
                const updateResult = await updateUserSubscription(selectedPlan);
                
                if (!updateResult || !updateResult.success) {
                    console.error('‚ùå Subscription update failed:', updateResult);
                    const errorMsg = updateResult?.error || 'Unknown Firebase error';
                    throw new Error(`Failed to update subscription in Firebase: ${errorMsg}`);
                }
                
                console.log('‚úÖ Firebase updated successfully, updating localStorage...');
                
                // Update localStorage with the actual Firebase data
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
                currentUser.subscription = {
                    status: 'premium',
                    plan: selectedPlan,
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + (selectedPlan === 'monthly' ? 30 : selectedPlan === 'quarterly' ? 90 : 365) * 24 * 60 * 60 * 1000).toISOString(),
                    active: true,
                    paymentMethod: 'stripe'
                };
                localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                
                console.log('‚úÖ localStorage updated with premium status');
                
                showSuccess('subscriptionSuccess', 'üéâ Payment successful! Welcome to Premium!');
                
                setTimeout(() => {
                    closeModal('subscriptionModal');
                    
                    // Update UI to show premium status
                    toggleAuthButtons(true, currentUser.name, 'premium');
                    
                    // Update premium module display
                    if (typeof updatePremiumModuleUI === 'function') {
                        updatePremiumModuleUI();
                    }
                    
                    // Force refresh the menu access
                    if (typeof updateMenuAccess === 'function') {
                        updateMenuAccess();
                    }
                    
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Payment processing error:', error);
                showError('subscriptionError', error.message);
                
            } finally {
                // Reset button state
                subscribeBtnText.style.display = 'inline';
                subscribeSpinner.style.display = 'none';
                subscribeBtn.disabled = false;
            }
        };

        // Update user subscription in Firebase
        async function updateUserSubscription(plan) {
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
            const firebaseUser = firebase.auth().currentUser;
            
            console.log('üîÑ Starting subscription update process...');
            
            if (typeof firebase === 'undefined') {
                console.error('‚ùå Firebase not loaded');
                throw new Error('Firebase not available');
            }
            
            if (!firebaseUser) {
                console.error('‚ùå No Firebase user authenticated');
                throw new Error('User not authenticated to Firebase');
            }
            
            if (!currentUser) {
                console.error('‚ùå No localStorage user found');
                throw new Error('User data not found in localStorage');
            }
            
            try {
                const userDocRef = firebase.firestore().collection('users').doc(firebaseUser.uid);
                
                const subscriptionData = {
                    status: 'premium',
                    plan: plan,
                    startDate: new Date(),
                    endDate: new Date(Date.now() + (plan === 'monthly' ? 30 : 365) * 24 * 60 * 60 * 1000),
                    paymentMethod: 'stripe',
                    active: true,
                    updatedAt: new Date()
                };
                
                try {
                    // Try to update existing document first
                    await userDocRef.update({
                        subscription: subscriptionData
                    });
                    console.log('‚úÖ Updated existing user document');
                } catch (updateError) {
                    console.log('üìù Update failed, document may not exist. Creating document...', updateError.code);
                    
                    if (updateError.code === 'not-found') {
                        // Document doesn't exist, create it
                        const newUserData = {
                            email: firebaseUser.email,
                            name: firebaseUser.displayName || currentUser.name || firebaseUser.email,
                            createdAt: new Date(),
                            subscription: subscriptionData,
                            subscriptionHistory: []
                        };
                        
                        await userDocRef.set(newUserData);
                        console.log('‚úÖ Created new user document with subscription');
                    } else {
                        throw updateError;
                    }
                }
                
                return { success: true, data: subscriptionData };
                
            } catch (error) {
                console.error('‚ùå Error in updateUserSubscription:', error);
                return { 
                    success: false, 
                    error: error.message || 'Unknown error updating subscription',
                    code: error.code || 'unknown'
                };
            }
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
            clearMessages();
            
            // Reset plan selection
            if (modalId === 'subscriptionModal') {
                selectedPlan = null;
                document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
                document.getElementById('paymentSection').style.display = 'none';
            }
        };

        window.switchToSignIn = function() {
            closeModal('signUpModal');
            openSignInModal();
        };

        window.switchToSignUp = function() {
            closeModal('signInModal');
            openSignUpModal();
        };

        function clearMessages() {
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                msg.style.display = 'none';
                msg.textContent = '';
            });
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                const modalId = event.target.id;
                event.target.style.display = 'none';
                clearMessages();
                
                // Reset plan selection for subscription modal
                if (modalId === 'subscriptionModal') {
                    selectedPlan = null;
                    document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
                    const paymentSection = document.getElementById('paymentSection');
                    if (paymentSection) {
                        paymentSection.style.display = 'none';
                    }
                }
            }
        };

        // Form submission handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Sign Up Form Handler
            const signUpForm = document.getElementById('signUpForm');
            if (signUpForm) {
                signUpForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('signUpEmail').value;
                    const password = document.getElementById('signUpPassword').value;
                    const name = document.getElementById('signUpName').value;
                    const country = document.getElementById('signUpCountry').value;
                    
                    const signUpBtn = document.getElementById('signUpBtn');
                    const signUpBtnText = document.getElementById('signUpBtnText');
                    const signUpSpinner = document.getElementById('signUpSpinner');
                    
                    try {
                        // Show loading state
                        signUpBtn.disabled = true;
                        signUpBtnText.style.display = 'none';
                        signUpSpinner.style.display = 'inline-block';
                        
                        const user = await firebaseSignUp(email, password, name, country);
                        
                        // Store user data in localStorage
                        const userData = {
                            email: user.email,
                            name: name,
                            country: country,
                            uid: user.uid,
                            subscription: { status: 'free' }
                        };
                        localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                        
                        showSuccess('signUpSuccess', 'Account created successfully!');
                        setTimeout(() => {
                            closeModal('signUpModal');
                            toggleAuthButtons(true, name, 'free');
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Sign up error:', error);
                        showError('signUpError', error.message);
                    } finally {
                        // Reset button state
                        signUpBtn.disabled = false;
                        signUpBtnText.style.display = 'inline';
                        signUpSpinner.style.display = 'none';
                    }
                });
            }
            
            // Sign In Form Handler
            const signInForm = document.getElementById('signInForm');
            if (signInForm) {
                signInForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    console.log('üöÄ Sign-in form submitted');
                    
                    // Clear any existing error messages first
                    clearMessages();
                    
                    const email = document.getElementById('signInEmail').value;
                    const password = document.getElementById('signInPassword').value;
                    
                    // Basic validation
                    if (!email || !password) {
                        showError('signInError', 'Please enter both email and password.');
                        return;
                    }
                    
                    if (!email.includes('@')) {
                        showError('signInError', 'Please enter a valid email address.');
                        return;
                    }
                    
                    console.log('‚úÖ Form validation passed for:', email);
                    
                    const signInBtn = document.getElementById('signInBtn');
                    const signInBtnText = document.getElementById('signInBtnText');
                    const signInSpinner = document.getElementById('signInSpinner');
                    
                    try {
                        // Show loading state
                        signInBtn.disabled = true;
                        signInBtnText.style.display = 'none';
                        signInSpinner.style.display = 'inline-block';
                        
                        console.log('üîê Starting Firebase authentication for:', email);
                        const userCredential = await firebaseSignIn(email, password);
                        const user = userCredential.user;
                        console.log('‚úÖ Firebase authentication successful:', user.email);
                        
                        // Get user data from Firestore (in separate try-catch to avoid interference)
                        let userData = {
                            email: user.email,
                            name: user.displayName || user.email.split('@')[0],
                            subscription: { status: 'free' }
                        };
                        
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            if (userDoc.exists) {
                                userData = { ...userData, ...userDoc.data() };
                                console.log('‚úÖ Firestore user data retrieved:', userData);
                            } else {
                                console.log('‚ÑπÔ∏è No Firestore document found, using defaults');
                            }
                        } catch (firestoreError) {
                            console.log('‚ö†Ô∏è Firestore operation failed, using defaults:', firestoreError.message);
                            // Don't show error to user, just use default data
                        }
                        
                        // Store in localStorage
                        const localUserData = {
                            email: user.email,
                            name: userData.name,
                            uid: user.uid,
                            subscription: userData.subscription || { status: 'free' }
                        };
                        localStorage.setItem('french_app_current_user', JSON.stringify(localUserData));
                        
                        showSuccess('signInSuccess', 'Signed in successfully!');
                        setTimeout(() => {
                            closeModal('signInModal');
                            toggleAuthButtons(true, userData.name, userData.subscription?.status || 'free');
                        }, 1500);
                        
                        // Additional safeguard: Clear any error messages that might appear after success
                        setTimeout(() => {
                            clearMessages();
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Sign in error:', error);
                        
                        // Handle specific Firebase auth errors with user-friendly messages
                        let errorMessage = 'Sign in failed. Please try again.';
                        
                        if (error.code === 'auth/invalid-email') {
                            errorMessage = 'Please enter a valid email address.';
                        } else if (error.code === 'auth/user-disabled') {
                            errorMessage = 'This account has been disabled. Please contact support.';
                        } else if (error.code === 'auth/user-not-found') {
                            errorMessage = 'No account found with this email. Please check your email or sign up.';
                        } else if (error.code === 'auth/wrong-password') {
                            errorMessage = 'Incorrect password. Please try again.';
                        } else if (error.code === 'auth/too-many-requests') {
                            errorMessage = 'Too many failed attempts. Please try again later.';
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage = 'Network error. Please check your connection and try again.';
                        }
                        
                        showError('signInError', errorMessage);
                    } finally {
                        // Reset button state
                        signInBtn.disabled = false;
                        signInBtnText.style.display = 'inline';
                        signInSpinner.style.display = 'none';
                    }
                });
            }
        });

        // Global Firebase error handler to prevent error flashing
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Firebase') || 
                 event.reason.message.includes('auth/') ||
                 event.reason.message.includes('firestore'))) {
                console.warn('üõ°Ô∏è Caught unhandled Firebase error:', event.reason.message);
                event.preventDefault(); // Prevent the error from showing to user
            }
        });
        
        // Prevent Firebase auth errors from showing in console as user-visible errors
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(function(user) {
                // This listener helps catch auth state change errors silently
            }, function(error) {
                console.warn('üõ°Ô∏è Auth state change error caught silently:', error.message);
                // Don't let this error bubble up to user
            });
        }
    </script>

    <!-- Donation Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content subscription-modal-content">
            <span class="close" onclick="closeModal('donationModal')">&times;</span>
            <h2>‚ù§Ô∏è Support Global Education</h2>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">
                Help support the GK Foundation's mission to provide free education globally. Your donation directly funds the development of new educational content, maintains our learning platform, and expands access to quality education for students and professionals worldwide.
            </p>
            <div id="donationError" class="error-message"></div>
            <div id="donationSuccess" class="success-message"></div>
            
            <!-- Suggested Donation Amounts -->
            <div class="donation-amounts">
                <h3 style="text-align: center; margin-bottom: 1rem;">Choose an amount</h3>
                <div class="amount-buttons">
                    <button class="amount-btn" onclick="selectDonationAmount(5)">$5</button>
                    <button class="amount-btn" onclick="selectDonationAmount(10)">$10</button>
                    <button class="amount-btn" onclick="selectDonationAmount(25)">$25</button>
                    <button class="amount-btn" onclick="selectDonationAmount(50)">$50</button>
                </div>
                
                <!-- Custom Amount Input -->
                <div class="custom-amount">
                    <label for="customAmount">Or enter a custom amount:</label>
                    <div class="amount-input-container">
                        <span class="currency-symbol">$</span>
                        <input type="number" 
                               id="customAmount" 
                               placeholder="0.00" 
                               min="1" 
                               step="0.01"
                               onchange="selectCustomAmount(this.value)"
                               onfocus="clearAmountSelection()">
                    </div>
                </div>
            </div>

            <!-- Payment Section -->
            <div id="donationPaymentSection" class="payment-section" style="display: none; margin-top: 2rem;">
                <h3>Payment Details</h3>
                
                <div class="selected-amount-display">
                    <p>Donation Amount: <strong id="selectedDonationAmount">$0.00</strong></p>
                </div>

                <div class="form-group">
                    <label for="donationCardholderName">Cardholder Name</label>
                    <input type="text" id="donationCardholderName" placeholder="Your full name" required>
                </div>

                <div class="form-group">
                    <label for="donation-card-element">Credit or Debit Card</label>
                    <div id="donation-card-element">
                        <!-- Stripe Elements will create form elements here -->
                    </div>
                    <div id="donation-card-errors" role="alert" style="color: #721c24; margin-top: 0.5rem;"></div>
                </div>

                <button type="button" class="subscription-btn-modal" id="donateProcessBtn" onclick="processDonation()">
                    <span id="donateBtnText">Complete Donation</span>
                    <span id="donateSpinner" class="spinner"></span>
                </button>
            </div>

            <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.85rem;">
                <p style="margin: 0.25rem 0;">üîí Secure donation processing by Stripe</p>
                <p style="margin: 0.25rem 0;">üíù Every contribution supports the Foundation's educational mission</p>
            </div>
        </div>
    </div>

    <script>
        // Donation system variables
        let selectedDonationAmount = 0;
        let donationCardElement = null;

        // Function to update donation amounts based on user currency
        async function updateDonationAmounts() {
            try {
                const userCurrency = await getUserCurrency();
                const amountButtons = document.querySelectorAll('.amount-btn');
                const currencySymbol = document.querySelector('.currency-symbol');
                
                let amounts, symbol;
                
                if (userCurrency === 'INR') {
                    amounts = [10, 20, 30, 40]; // INR amounts (‚Çπ10 to ‚Çπ40)
                    symbol = '‚Çπ';
                } else if (userCurrency === 'CAD') {
                    amounts = [3, 4, 5, 6]; // CAD amounts ($3 to $6 CAD)
                    symbol = '$';
                } else {
                    amounts = [2, 3, 4, 5]; // USD amounts ($2 to $5 USD - default)
                    symbol = '$';
                }
                
                // Update amount buttons
                amountButtons.forEach((btn, index) => {
                    if (index < amounts.length) {
                        const amount = amounts[index];
                        btn.textContent = `${symbol}${amount}`;
                        btn.onclick = () => selectDonationAmount(amount);
                    }
                });
                
                // Update currency symbol in custom input
                if (currencySymbol) {
                    currencySymbol.textContent = symbol;
                }
                
                console.log('üí∞ Updated donation amounts for currency:', userCurrency, amounts);
            } catch (error) {
                console.error('‚ùå Error updating donation amounts:', error);
                // Fallback to USD
                const amountButtons = document.querySelectorAll('.amount-btn');
                amountButtons.forEach((btn, index) => {
                    const amounts = [2, 3, 4, 5]; // USD fallback amounts
                    if (index < amounts.length) {
                        btn.textContent = `$${amounts[index]}`;
                        btn.onclick = () => selectDonationAmount(amounts[index]);
                    }
                });
            }
        }

        // Open Donation Modal
        function openDonationModal() {
            console.log('üéÅ Opening donation modal...');
            
            // Reset any previous selections
            selectedDonationAmount = 0;
            clearAmountSelection();
            document.getElementById('donationPaymentSection').style.display = 'none';
            document.getElementById('donationError').textContent = '';
            document.getElementById('donationSuccess').textContent = '';
            
            // Update donation amounts based on user currency
            updateDonationAmounts();
            
            // Initialize Stripe for donations if not already done
            if (!donationCardElement) {
                initializeDonationStripe();
            }
            
            document.getElementById('donationModal').style.display = 'block';
        }

        // Initialize Stripe Elements for Donation
        function initializeDonationStripe() {
            console.log('üîÑ Initializing Stripe for donations...');
            
            if (typeof Stripe === 'undefined') {
                console.error('‚ùå Stripe.js not loaded');
                showError('donationError', 'Payment system not available. Please refresh the page.');
                return;
            }

            try {
                // Use existing stripe instance from Tech-Pay system
                if (!stripe) {
                    const publishableKey = getStripePublishableKey();
                    stripe = Stripe(publishableKey);
                    elements = stripe.elements();
                }
                
                // Create separate card element for donations
                donationCardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                    hidePostalCode: true
                });
                
                donationCardElement.mount('#donation-card-element');
                
                // Handle real-time validation errors
                donationCardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('donation-card-errors');
                    if (error) {
                        displayError.textContent = error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
                console.log('‚úÖ Donation Stripe initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing donation Stripe:', error);
                showError('donationError', 'Payment system initialization failed. Please refresh the page.');
            }
        }

        // Select Donation Amount (Preset)
        function selectDonationAmount(amount) {
            console.log('üíù Donation amount selected:', amount);
            
            selectedDonationAmount = amount;
            
            // Clear custom amount input
            document.getElementById('customAmount').value = '';
            
            // Update button states
            updateAmountButtons(amount);
            
            // Show payment section
            showDonationPaymentSection();
        }

        // Select Custom Donation Amount
        function selectCustomAmount(amount) {
            const numAmount = parseFloat(amount);
            if (numAmount && numAmount >= 1) {
                console.log('üíù Custom donation amount:', numAmount);
                selectedDonationAmount = numAmount;
                
                // Clear preset button selections
                clearAmountSelection();
                
                // Show payment section
                showDonationPaymentSection();
            } else {
                selectedDonationAmount = 0;
                document.getElementById('donationPaymentSection').style.display = 'none';
            }
        }

        // Clear Amount Selection
        function clearAmountSelection() {
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // Update Amount Button States
        function updateAmountButtons(selectedAmount) {
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent === `$${selectedAmount}`) {
                    btn.classList.add('selected');
                }
            });
        }

        // Show Donation Payment Section
        function showDonationPaymentSection() {
            document.getElementById('selectedDonationAmount').textContent = `$${selectedDonationAmount.toFixed(2)}`;
            document.getElementById('donationPaymentSection').style.display = 'block';
            
            // Scroll to payment section
            document.getElementById('donationPaymentSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }

        // Process Donation (Tech-Pay Integration)
        async function processDonation() {
            if (!selectedDonationAmount || selectedDonationAmount < 1) {
                showError('donationError', 'Please select a donation amount of at least $1.');
                return;
            }
            
            const cardholderName = document.getElementById('donationCardholderName').value;
            if (!cardholderName.trim()) {
                showError('donationError', 'Please enter the cardholder name.');
                return;
            }
            
            // Show loading
            const donateBtn = document.getElementById('donateProcessBtn');
            const donateBtnText = document.getElementById('donateBtnText');
            const donateSpinner = document.getElementById('donateSpinner');
            
            donateBtnText.style.display = 'none';
            donateSpinner.style.display = 'inline';
            donateBtn.disabled = true;
            
            try {
                // Create payment method with Stripe
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: donationCardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                console.log('‚úÖ Donation payment method created:', paymentMethod.id);
                
                // Get user currency (reuse existing function)
                const userCurrency = await getUserCurrency();
                // üéØ FEE-ABSORBED DONATION PRICING: Customer pays exactly what they see!
                let amountInCents = Math.round(selectedDonationAmount * 100);
                
                // Absorb all fees, taxes, and currency conversion charges
                if (userCurrency === 'CAD') {
                    // Fix: Absorb 34% markup (taxes, fees) so customer pays displayed amount
                    amountInCents = Math.round((selectedDonationAmount * 100) / 1.34);
                } else if (userCurrency === 'INR') {
                    // Fee-absorbed INR pricing (absorb taxes and fees)
                    amountInCents = Math.round((selectedDonationAmount * 8300) / 1.34);
                } else {
                    // Fee-absorbed USD pricing (absorb taxes and fees)
                    amountInCents = Math.round((selectedDonationAmount * 100) / 1.34);
                }
                
                console.log('üí≥ Processing donation:', amountInCents, userCurrency);
                
                // LIVE ENVIRONMENT: Backend Donation Processing with Stripe Payment Intents
                if (STRIPE_CONFIG.environment === 'live') {
                    try {
                        console.log('üíù Creating donation payment intent with backend...');
                        
                        // Get current user for customer details
                        const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                        
                        // Create donation payment intent via backend
                        const response = await fetch('https://foundation-backend-chi.vercel.app/create-payment-intent', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                planType: 'donation',
                                currency: userCurrency,
                                amount: amountInCents,
                                customerEmail: currentUser.email || '',
                                customerName: currentUser.displayName || cardholderName
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Donation setup failed');
                        }
                        
                        const { clientSecret, paymentIntentId } = await response.json();
                        console.log('‚úÖ Donation payment intent created:', paymentIntentId);
                        
                        // Confirm donation payment with Stripe
                        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                            payment_method: paymentMethod.id
                        });
                        
                        if (confirmError) {
                            throw new Error(confirmError.message);
                        }
                        
                        if (paymentIntent.status !== 'succeeded') {
                            throw new Error('Donation was not completed successfully');
                        }
                        
                        console.log('‚úÖ LIVE donation processed successfully!');
                        console.log('üí∞ Donation Details:', paymentIntent);
                        
                    } catch (donationError) {
                        console.error('‚ùå Live donation processing error:', donationError);
                        throw donationError;
                    }
                } else {
                    // Test environment processing
                    console.log('‚úÖ Donation processed successfully with Stripe using test card');
                }
                
                // Log donation in Firebase (optional)
                await logDonation(selectedDonationAmount, userCurrency, paymentMethod.id, cardholderName);
                
                console.log('‚úÖ Donation completed successfully');
                
                showSuccess('donationSuccess', `üéâ Thank you for your $${selectedDonationAmount.toFixed(2)} donation! Your support helps the GK Foundation expand free educational access globally.`);
                
                // Store amount before modal reset
                const finalDonationAmount = selectedDonationAmount;
                
                setTimeout(() => {
                    closeModal('donationModal');
                    
                    // Show appreciation message with preserved amount
                    alert(`üíù Thank you for supporting the GK Foundation! Your $${finalDonationAmount.toFixed(2)} donation helps us fulfill our mission of providing free, quality education to students and professionals worldwide.`);
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Donation processing error:', error);
                showError('donationError', error.message);
                
            } finally {
                // Reset button state
                donateBtnText.style.display = 'inline';
                donateSpinner.style.display = 'none';
                donateBtn.disabled = false;
            }
        }

        // Log Donation (Optional - for record keeping)
        async function logDonation(amount, currency, paymentMethodId, donorName) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
                const firebaseUser = firebase.auth().currentUser;
                
                const donationData = {
                    amount: amount,
                    currency: currency,
                    donorName: donorName,
                    paymentMethodId: paymentMethodId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: firebaseUser ? firebaseUser.uid : null,
                    userEmail: firebaseUser ? firebaseUser.email : 'anonymous',
                    environment: STRIPE_CONFIG.environment
                };
                
                // Log to Firebase (if available)
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    await firebase.firestore().collection('donations').add(donationData);
                    console.log('üìù Donation logged to Firebase');
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not log donation:', error);
                // Don't throw error - donation was successful even if logging failed
            }
        }
    </script>
</body>
</html> 