<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GK Foundation - Global Online Learning Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #3c2d1f;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #cd853f 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            min-height: 120px;
        }
        


        .header-logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .header-logo-container .gk-logo {
            width: 32px;
            height: 32px;
        }

        .header-logo-container .gk-letters {
            font-size: 14px;
        }

        .header-logo-container .logo {
            font-size: 1rem;
            font-weight: bold;
            color: #8b4513;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .nav-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .nav-menu-row {
            display: flex;
            justify-content: flex-start;
            width: 100%;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 3rem;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8b4513;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .gk-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b4513, #d4af37);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            transition: all 0.3s ease;
        }

        .gk-logo:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .gk-letters {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transform: skew(-10deg) rotate(-5deg);
            letter-spacing: -2px;
            position: relative;
        }

        .gk-letters::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, white, transparent);
            animation: running-line 2s ease-in-out infinite;
        }

        @keyframes running-line {
            0%, 100% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(0); opacity: 1; }
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .logo-image {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #8b4513;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #3c2d1f;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-links a:hover {
            color: #8b4513;
            text-decoration: none;
        }

        .nav-links > li > a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: #8b4513;
            transition: width 0.3s ease;
        }

        .nav-links > li > a:hover::after {
            width: 100%;
        }

        /* Authentication Styles */
        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sign-in-btn, .sign-up-btn, .sign-out-btn {
            padding: 0.25rem 0.6rem;
            border: none;
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .subscription-btn {
            padding: 0.25rem 0.6rem;
            border: none;
            border-radius: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            text-decoration: none;
            display: none; /* Hide by default to prevent flash for premium users */
            align-items: center;
            gap: 0.4rem;
        }
        
        .subscription-status {
            font-size: 0.625rem;
            padding: 0.15rem 0.4rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .subscription-status.premium {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b4513;
            border: 1px solid #d4af37;
        }
        
        .subscription-status.free {
            background: rgba(156, 163, 175, 0.2);
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .user-greeting {
            color: #2d3748;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .sign-in-btn {
            background: transparent;
            color: #8b4513;
            border: 2px solid #8b4513;
        }

        .sign-in-btn:hover {
            background: #8b4513;
            color: white;
        }

        .sign-up-btn {
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            border: 2px solid transparent;
        }

        .sign-up-btn:hover {
            background: linear-gradient(135deg, #654321, #b8860b);
            transform: translateY(-2px);
        }

        .subscription-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .subscription-btn:hover {
            background: linear-gradient(135deg, #218838, #1fa186);
            transform: translateY(-2px);
        }

        .subscription-btn.premium {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #8b4513;
            font-weight: 600;
        }

        .subscription-btn.premium:hover {
            background: linear-gradient(135deg, #ffed4e, #ff7f00);
        }

        .donate-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            margin-right: 0.5rem;
        }

        .donate-btn:hover {
            background: linear-gradient(135deg, #dc3545, #b02a37);
            transform: translateY(-2px);
        }

        /* Navigation Donate Button Styles - Aligned parallel to menu items */
        .nav-donate {
            display: none; /* Hidden by default, shown only when user is signed in */
        }

        .nav-donate-btn {
            background: none;
            border: none;
            color: #3c2d1f; /* Match menu items color */
            font-weight: 500; /* Match menu items font-weight */
            font-size: 1rem; /* Match menu items font-size */
            cursor: pointer;
            transition: color 0.3s ease; /* Match menu items transition */
            position: relative; /* For underline effect */
            padding: 0; /* Remove padding to match menu links */
            text-decoration: none;
            display: inline-block; /* Match menu links display */
            line-height: normal;
        }

        .nav-donate-btn:hover {
            color: #8b4513; /* Match menu items hover color */
            background: none;
            text-decoration: none; /* Match menu items hover */
        }

        .nav-donate-btn::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px; /* Match menu items underline height */
            bottom: -5px; /* Match menu items underline position */
            left: 0; /* Match menu items underline alignment */
            background-color: #8b4513; /* Match menu items underline color */
            transition: width 0.3s ease; /* Match menu items transition */
        }

        .nav-donate-btn:hover::after {
            width: 100%;
        }

        /* Donation Modal Styles */
        .donation-amounts {
            margin: 2rem 0;
        }

        .amount-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .amount-btn {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 2px solid #dee2e6;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .amount-btn:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .amount-btn.selected {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-color: #c0392b;
        }

        .custom-amount {
            text-align: center;
            margin-top: 1.5rem;
        }

        .custom-amount label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
            font-weight: 500;
        }

        .amount-input-container {
            display: inline-flex;
            align-items: center;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            max-width: 200px;
            margin: 0 auto;
        }

        .currency-symbol {
            padding: 0.75rem 0.5rem 0.75rem 1rem;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 1.1rem;
        }

        #customAmount {
            border: none;
            outline: none;
            padding: 0.75rem 1rem 0.75rem 0.5rem;
            font-size: 1.1rem;
            width: 120px;
            background: transparent;
        }

        .selected-amount-display {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .selected-amount-display p {
            margin: 0;
            font-size: 1.1rem;
            color: #495057;
        }

        @media (max-width: 768px) {
            .amount-buttons {
                gap: 0.5rem;
            }
            
            .amount-btn {
                padding: 0.8rem 1rem;
                font-size: 1rem;
                min-width: 60px;
            }
        }

        .sign-out-btn {
            background: #dc3545;
            color: white;
            border: 2px solid #dc3545;
        }

        .sign-out-btn:hover {
            background: #c82333;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #8b4513;
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .user-profile span#userName {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .subscription-status {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #8b4513;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .subscription-status.free {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        .subscription-modal-content {
            max-width: 950px;
            padding: 1.2rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover {
            color: #8b4513;
        }

        .modal h2 {
            color: #8b4513;
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #8b4513;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #654321;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #3c2d1f;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8b4513;
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }

        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #8b4513;
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .auth-btn:hover {
            background: linear-gradient(135deg, #654321, #b8860b);
            transform: translateY(-2px);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Subscription Modal Styles */
        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.2rem 0;
        }

        .plan-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 320px;
        }

        .plan-card:hover {
            border-color: #28a745;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
            transform: translateY(-3px);
        }

        .plan-card.selected {
            border: 3px solid #28a745;
            box-shadow: 0 8px 30px rgba(40, 167, 69, 0.3);
            transform: translateY(-5px);
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
        }

        .plan-card.selected::before {
            content: 'âœ… SELECTED';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .plan-card.popular {
            border-color: #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .plan-card.popular:hover, .plan-card.popular.selected {
            border-color: #2980b9;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .plan-card.premium {
            border-color: #ffd700;
            background: linear-gradient(135deg, #fff9c4, #ffeaa7);
        }

        .plan-card.premium:hover, .plan-card.premium.selected {
            border-color: #ff8c00;
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.3);
        }

        .plan-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.4rem;
        }

        .plan-price {
            font-size: 1.4rem;
            font-weight: 800;
            color: #27ae60;
            margin-bottom: 0.8rem;
        }

        .plan-price .currency {
            font-size: 0.9rem;
            vertical-align: top;
        }

        .plan-price .period {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-weight: 400;
        }

        .multi-currency-display {
            margin-top: 0.4rem;
            font-size: 0.7rem;
            color: #6c7b7f;
            text-align: center;
        }

        .currency-row {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 0.1rem 0;
            flex-wrap: wrap;
        }

        .currency-equiv {
            margin: 0.05rem 0.2rem;
            font-weight: 500;
            flex: 0 0 auto;
        }

        .currency-primary {
            font-size: 0.9rem;
            font-weight: 600;
            color: #27ae60;
            text-align: center;
            margin-bottom: 0.3rem;
        }

        .currency-note {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            font-style: italic;
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
            font-size: 0.75rem;
        }

        .plan-features li {
            padding: 0.15rem 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            text-align: left;
        }

        .plan-features li::before {
            content: 'âœ“';
            color: #27ae60;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* Responsive design for subscription plans */
        @media (max-width: 768px) {
            .subscription-modal-content {
                width: 98% !important;
                max-width: 98% !important;
                margin: 1% auto !important;
                padding: 1rem !important;
                max-height: 95vh !important;
                overflow-y: auto !important;
            }
            
            .subscription-plans {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .plan-card {
                padding: 1rem !important;
                min-height: auto !important;
                margin-bottom: 1rem;
            }
            
            .plan-price {
                font-size: 1.8rem !important;
            }
            
            .payment-section {
                padding: 1rem !important;
                margin-top: 1rem !important;
            }
            
            .subscription-btn-modal {
                width: 100% !important;
                padding: 1rem !important;
                font-size: 1.1rem !important;
                margin-top: 1rem !important;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            /* Touch-friendly form inputs */
            #cardholderName, #card-element {
                padding: 1rem !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px !important;
                touch-action: manipulation;
            }
            
            .currency-row {
                gap: 0.3rem;
            }
            
            .currency-equiv {
                font-size: 0.65rem;
                margin: 0.05rem 0.1rem;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .subscription-plans {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .payment-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
        }

        .payment-form {
            margin-top: 1rem;
        }

        #card-element {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 1rem 0;
            transition: border-color 0.3s ease;
        }

        #card-element:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .subscription-btn-modal {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .subscription-btn-modal:hover {
            background: linear-gradient(135deg, #218838, #1fa186);
            transform: translateY(-2px);
        }

        .subscription-btn-modal:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .switch-auth {
            text-align: center;
            margin-top: 1rem;
            color: #666;
        }

        .switch-auth a {
            color: #8b4513;
            text-decoration: none;
            font-weight: 500;
        }

        .switch-auth a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8b4513;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Premium Features Overlay */
        .premium-overlay {
            position: relative;
        }

        .premium-overlay::after {
            content: 'ðŸ”’ Premium Feature - Subscribe to Unlock';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1001;
            top: 100%;
            left: 0;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.3s ease;
        }

        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
            position: relative;
            white-space: nowrap;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .dropdown-item:hover {
            background-color: #f5f1e8;
            color: #8b4513;
            text-decoration: none;
        }

        .dropdown-item::after {
            display: none;
        }

        /* Premium feature styling */
        .dropdown-item.premium-feature {
            position: relative;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 237, 74, 0.1));
            border-left: 3px solid #ffd700;
        }

        .dropdown-item.premium-locked {
            opacity: 0.8;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.05), rgba(255, 237, 74, 0.05));
            cursor: pointer;
        }

        .dropdown-item.premium-locked:hover {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(255, 237, 74, 0.15));
            transform: none;
        }

        /* Premium module styling */
        .premium-module {
            position: relative;
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(255, 237, 74, 0.05));
        }

        .premium-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-shadow: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .premium-module.locked {
            opacity: 0.8;
        }

        .premium-module.locked::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: inherit;
            pointer-events: none;
        }

        .dropdown-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Nested Dropdown */
        .nested-dropdown {
            position: relative;
        }

        .nested-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1002;
            top: 0;
            left: 100%;
            margin-left: 5px;
            border: 1px solid #e2e8f0;
        }

        .nested-dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.3s ease;
        }

        .nested-dropdown:hover .nested-dropdown-content {
            display: block;
        }

        /* Third Level Nested Dropdown */
        .sub-nested {
            top: 0;
            left: 100%;
            margin-left: 8px;
            min-width: 200px;
        }

        .nested-dropdown .nested-dropdown {
            position: relative;
        }

        .nested-dropdown .nested-dropdown:hover .nested-dropdown-content {
            display: block;
        }

        /* Hero Section */
        .hero {
            padding: 8rem 2rem 4rem;
            text-align: center;
            color: white;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-button {
            background: linear-gradient(135deg, #d4af37, #b8860b);
            color: white;
            padding: 1rem 2rem;
            text-decoration: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        /* Learning Modules Section */
        .modules-section {
            padding: 4rem 2rem;
            background: white;
            margin-top: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #3c2d1f;
        }

        .section-subtitle {
            text-align: center;
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 3rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .module-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #d4af37, #b8860b);
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .module-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .module-card h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #3c2d1f;
        }

        .module-card p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .module-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b4513;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .module-link:hover {
            color: #654321;
            transform: translateX(5px);
        }

        /* Comprehensive Module Card */
        .comprehensive-card {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .comprehensive-card::before {
            background: rgba(255,255,255,0.2);
        }

        .comprehensive-card h3,
        .comprehensive-card p {
            color: white;
        }

        .comprehensive-card .module-link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .comprehensive-card .module-link:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: translateY(-2px);
        }

        /* Features Section */
        .features-section {
            background: #faf8f1;
            padding: 4rem 2rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .feature-item {
            text-align: center;
            padding: 1.5rem;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #b8860b;
        }

        .feature-item h4 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: #3c2d1f;
        }

        .feature-item p {
            color: #666;
            font-size: 0.95rem;
        }

        /* About Section */
        .about-section {
            padding: 4rem 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
        }

        .about-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23f1f3f4" fill-opacity="0.3"><polygon points="60,60 0,60 0,0"/></g></g></svg>') repeat;
            opacity: 0.5;
        }

        .about-section .container {
            position: relative;
            z-index: 1;
        }

        .about-section h2 {
            text-align: center;
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 3rem;
            font-weight: 700;
        }

        .about-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .about-text {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .about-text p {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #4a5568;
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        .contact-info {
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            text-align: center;
        }

        .contact-info p {
            margin: 0.5rem 0;
            color: white;
        }

        .contact-info a {
            color: #ffd700;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .contact-info a:hover {
            color: #ffed4e;
            text-decoration: underline;
        }

        .about-features h3 {
            color: #2d3748;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .about-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .about-features li {
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.6;
        }

        .about-features li:last-child {
            border-bottom: none;
        }

        .about-features li strong {
            color: #2d3748;
        }

        /* QR Code Section */
        .qr-code-section {
            margin-top: 2rem;
            padding: 1.3rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transform: scale(0.65);
            transform-origin: center;
        }

        .qr-code-section h3 {
            color: #2d3748;
            font-size: 1.3rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
        }

        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }

        .qr-code-image {
            width: 150px;
            height: 150px;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 10px;
            background: white;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .qr-code-image:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(139, 69, 19, 0.3);
        }

        .qr-code-text {
            font-size: 0.7rem;
            color: #2d3748;
            margin: 0;
            font-weight: 700;
        }

        .qr-code-url {
            font-size: 0.6rem;
            color: #8b4513;
            margin: 0;
            font-family: 'Courier New', monospace;
            background: rgba(139, 69, 19, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            border: 1px solid rgba(139, 69, 19, 0.2);
            font-weight: 700;
        }



        /* Responsive About Section */
        @media (max-width: 768px) {
            .about-section {
                padding: 2rem 0;
            }

            .about-section h2 {
                font-size: 2rem;
                margin-bottom: 2rem;
            }

            .about-text {
                padding: 1.5rem;
                margin: 0 1rem;
            }

            .about-text p {
                font-size: 1rem;
                text-align: left;
            }

            .contact-info {
                padding: 1rem;
            }

            .qr-code-section {
                margin-top: 1rem;
                padding: 0.65rem;
                margin: 1rem 1rem 0 1rem;
                transform: scale(0.65);
                transform-origin: center;
            }

            .qr-code-section h3 {
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
                font-weight: 700;
            }

            .qr-code-image {
                width: 120px;
                height: 120px;
            }

            .qr-code-text {
                font-size: 0.65rem;
                font-weight: 700;
            }

            .qr-code-url {
                font-size: 0.55rem;
                padding: 0.2rem 0.4rem;
                font-weight: 700;
            }


        }

        /* Stats Section */
        .stats-section {
            background: #3c2d1f;
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .stat-item h3 {
            font-size: 2.5rem;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .stat-item p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Footer */
        .footer {
            background: #2c1f14;
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .footer p {
            opacity: 0.8;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .hero p {
                font-size: 1.1rem;
            }

            .modules-grid {
                grid-template-columns: 1fr;
            }

            .comprehensive-card {
                grid-column: 1;
            }

            /* Enhanced subscription modal mobile responsiveness */
            .subscription-modal-content {
                width: 98% !important;
                max-width: 98% !important;
                margin: 1% auto !important;
                padding: 1rem !important;
                max-height: 95vh !important;
                overflow-y: auto !important;
            }
            
            .subscription-plans {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .plan-card {
                padding: 1rem !important;
                min-height: auto !important;
                margin-bottom: 1rem;
            }
            
            .plan-price {
                font-size: 1.8rem !important;
            }
            
            .payment-section {
                padding: 1rem !important;
                margin-top: 1rem !important;
            }
            
            .subscription-btn-modal {
                width: 100% !important;
                padding: 1rem !important;
                font-size: 1.1rem !important;
                margin-top: 1rem !important;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            /* Touch-friendly form inputs */
            #cardholderName, #card-element {
                padding: 1rem !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px !important;
                touch-action: manipulation;
            }

            /* Mobile-friendly navigation dropdowns */
            .dropdown-content {
                position: fixed !important;
                top: 70px !important;
                left: 5% !important;
                right: 5% !important;
                width: 90% !important;
                max-width: none !important;
                z-index: 9999 !important;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
            }
            
            .nested-dropdown-content {
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0.5rem 0 !important;
                border: 1px solid #e2e8f0 !important;
                border-radius: 8px !important;
            }
            
            .dropdown-item {
                padding: 1rem !important;
                font-size: 1rem !important;
                min-height: 48px !important;
                display: flex !important;
                align-items: center !important;
                touch-action: manipulation;
            }
            
            /* Enhanced mobile header */
            .header {
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
                background: white !important;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
            }
            
            .auth-buttons {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                align-items: center !important;
            }
            
            .sign-in-btn, .sign-up-btn, .sign-out-btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
                min-height: 44px !important;
                touch-action: manipulation;
            }
            
            .subscription-btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
                min-height: 44px !important;
                touch-action: manipulation;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .module-card {
            animation: fadeInUp 0.6s ease forwards;
        }

        .module-card:nth-child(1) { animation-delay: 0.1s; }
        .module-card:nth-child(2) { animation-delay: 0.2s; }
        .module-card:nth-child(3) { animation-delay: 0.3s; }

        /* Word highlighting when audio is playing */
        .word-highlight {
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            color: #8b4513 !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            animation: pulse 1.5s ease-in-out infinite !important;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4) !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .collapsible-content {
            display: none;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.expanded {
            display: block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1002;
            top: 100%;
            left: 0;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <!-- Main Navigation -->
        <nav class="nav-container">
            <!-- Top Row: Logo + Auth -->
            <div class="nav-top-row">
                <a href="index.html" class="logo-container">
                    <div class="gk-logo">
                        <span class="gk-letters">GK</span>
                    </div>
                    <span class="logo">Foundation</span>
                </a>
                <div class="auth-status">
                    <div id="userStatus" class="user-status" style="display: none;">
                        <span id="userGreeting" class="user-greeting"></span>
                        <button id="subscriptionBtn" class="subscription-btn" onclick="openSubscriptionModal()">ðŸ’Ž Go Premium</button>
                    </div>
                    <div class="auth-buttons">
                        <button id="signInBtn" class="sign-in-btn" onclick="openSignInModal()">Sign In</button>
                        <button id="signUpBtn" class="sign-up-btn" onclick="openSignUpModal()">Sign Up</button>
                        <button id="signOutBtn" class="sign-out-btn" style="display: none;" onclick="signOut()">Sign Out</button>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Row: Menu Items -->
            <div class="nav-menu-row">
                <ul class="nav-links">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" onclick="toggleDropdown(event, 'frenchLearningDropdown')">
                            Our Offerings
                            <span class="dropdown-arrow">â–¼</span>
                        </a>
                        <div class="dropdown-content" id="frenchLearningDropdown">
                                                            <a href="French-for-Beginners.html" class="dropdown-item">ðŸŽ“ French for Beginners</a>
                        </div>
                    </li>
                    <li><a href="#modules">Learning Modules</a></li>
                    <li><a href="#features">Features</a></li>
                    <li><a href="#about">About</a></li>
                    <li class="nav-donate">
                        <button id="donateBtn" class="nav-donate-btn" onclick="openDonationModal()">â¤ï¸ Support Us</button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <h1>Empower Your Learning Journey</h1>
                                         <p>Welcome to GK Foundation - your premier global online learning platform designed for students and professionals. Access comprehensive educational content, interactive coaching environments, and self-paced development resources for career advancement.</p>
        <a href="#modules" class="cta-button">Start Learning Now ðŸš€</a>
    </section>

    <!-- Learning Modules Section -->
    <section class="modules-section" id="modules">
        <div class="container">
            <h2 class="section-title">Choose Your Learning Path</h2>
            <p class="section-subtitle">Select from our comprehensive French learning modules, each designed with interactive exercises, audio pronunciation, and detailed explanations.</p>
            
            <div class="modules-grid">
                <!-- French Alphabets Module -->
                <div class="module-card">
                    <span class="module-icon">ðŸ”¤</span>
                    <h3>French Alphabets</h3>
                    <p>Master the foundation of French with comprehensive alphabet learning. Each letter includes pronunciation guides, IPA symbols, example words, and interactive audio practice.</p>
                    <a href="French-Alphabets.html" class="module-link">
                        Explore Alphabets â†’
                    </a>
                </div>

                <!-- French Numbers Module -->
                <div class="module-card premium-module" data-feature="numbers-module">
                    <span class="premium-badge">ðŸ’Ž PREMIUM</span>
                    <span class="module-icon">ðŸ”¢</span>
                    <h3>French Numbers</h3>
                    <p>Learn French numbers from 1 to 100 with detailed pronunciation guides. Master the unique French counting system including the distinctive patterns for 70-99.</p>
                    <a href="#" class="module-link" onclick="return handleNumbersAccess(event, 'French-Numbers.html')">
                        Practice Numbers â†’
                    </a>
                </div>

                <!-- French Verbs Module -->
                <div class="module-card">
                    <span class="module-icon">ðŸ“</span>
                    <h3>French Verbs</h3>
                    <p>Learn French verb conjugations across all major groups: -er, -ir, and -re verbs. Includes example sentences, audio pronunciation, and comprehensive conjugation tables.</p>
                    <a href="French-Verbs.html" class="module-link">
                        Study Verbs â†’
                    </a>
                </div>


            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section" id="features">
        <div class="container">
            <h2 class="section-title">Why Choose GK Foundation?</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">ðŸ”Š</div>
                    <h4>Audio Pronunciation</h4>
                    <p>Native French voice synthesis with proper Canadian French pronunciation for authentic learning experience.</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸ“±</div>
                    <h4>Mobile Responsive</h4>
                    <p>Learn anywhere, anytime with our fully responsive design that works perfectly on all devices.</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸŽ¯</div>
                    <h4>Interactive Learning</h4>
                    <p>Engaging exercises, searchable content, and interactive audio buttons for hands-on learning.</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">âš¡</div>
                    <h4>Instant Search</h4>
                    <p>Quickly find any word, verb, or letter with our powerful search functionality across all modules.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section class="about-section" id="about">
        <div class="container">
                            <h2>About GuruKullam Foundation</h2>
            <div class="about-content">
                <div class="about-text">
                    <p>At GuruKullam Foundation, we are a team of dedicated education professionals committed to creating innovative, self-directed learning experiences. Our foundation empowers learners to progress at their own pace through free educational content supported by community donations and premium coaching environments.</p>
                    
                    <p>As a foundation, we continuously expand our educational resources through community support, providing comprehensive modules and interactive content that prepare learners for real-world challenges. Our mission is to make quality education accessible globally while maintaining excellence in professional development and career advancement.</p>
                    
                    <div class="contact-info">
                        <p><strong>For additional information or support, please contact us:</strong></p>
                        <p>ðŸ“§ <a href="mailto:GuruKullamFoundation@gmail.com">GuruKullamFoundation@gmail.com</a></p>
                    </div>
                    
                    <div class="about-features">
                        <h3>Why Choose GuruKullam Foundation?</h3>
                        <ul>
                            <li>ðŸŽ¯ <strong>Self-Directed Learning:</strong> Learn at your own pace, anytime, anywhere</li>
                            <li>ðŸ’³ <strong>Flexible Payment:</strong> Pay as you learn with affordable subscription options</li>
                            <li>ðŸŽ“ <strong>Exam Preparation:</strong> Modules designed to replicate real online examinations</li>
                            <li>ðŸ”Š <strong>Interactive Content:</strong> Audio pronunciations and engaging exercises</li>
                            <li>ðŸŒ <strong>Global Access:</strong> Multi-currency support for international learners</li>
                        </ul>
                    </div>
                    
                    <div class="qr-code-section">
                        <h3>Self-phased online tutorial</h3>
                        <div class="qr-code-container">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://gurukullam.github.io/Foundation&color=8b4513&bgcolor=f5f1e8" 
                                 alt="QR Code to GuruKullam Foundation" 
                                 class="qr-code-image">
                            <p class="qr-code-text">Use a laptop to experience all features</p>
                            <p class="qr-code-url">https://gurukullam.github.io/Foundation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-item">
                    <h3>26</h3>
                    <p>French Letters with Audio</p>
                </div>
                <div class="stat-item">
                    <h3>100+</h3>
                    <p>Verb Conjugations</p>
                </div>
                <div class="stat-item">
                    <h3>200+</h3>
                    <p>Example Sentences</p>
                </div>
                <div class="stat-item">
                    <h3>100%</h3>
                    <p>Interactive Content</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Sign Up Modal -->
    <div id="signUpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('signUpModal')">&times;</span>
            <h2>Create Account</h2>
            <div id="signUpError" class="error-message"></div>
            <div id="signUpSuccess" class="success-message"></div>
            <form id="signUpForm">
                <div class="form-group">
                    <label for="signUpEmail">Email Address</label>
                    <input type="email" id="signUpEmail" name="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signUpPassword">Password</label>
                    <input type="password" id="signUpPassword" name="password" required placeholder="Enter your password">
                </div>
                <div class="form-group">
                    <label for="signUpName">Full Name</label>
                    <input type="text" id="signUpName" name="name" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signUpCountry">Country</label>
                    <select id="signUpCountry" name="country" required>
                        <option value="">Select your country</option>
                        <option value="Canada">ðŸ‡¨ðŸ‡¦ Canada</option>
                        <option value="India">ðŸ‡®ðŸ‡³ India</option>
                        <option value="United States">ðŸ‡ºðŸ‡¸ United States</option>
                        <option value="United Kingdom">ðŸ‡¬ðŸ‡§ United Kingdom</option>
                        <option value="Germany">ðŸ‡©ðŸ‡ª Germany</option>
                        <option value="France">ðŸ‡«ðŸ‡· France</option>
                        <option value="Japan">ðŸ‡¯ðŸ‡µ Japan</option>
                        <option value="Australia">ðŸ‡¦ðŸ‡º Australia</option>
                        <option value="Other">ðŸŒ Other</option>
                    </select>
                </div>
                <button type="submit" class="auth-btn" id="signUpBtn">
                    <span id="signUpBtnText">Create Account</span>
                    <span id="signUpSpinner" class="spinner"></span>
                </button>
            </form>
            <div class="switch-auth">
                Already have an account? <a href="#" onclick="switchToSignIn()">Sign In</a>
            </div>
        </div>
    </div>

    <!-- Sign In Modal -->
    <div id="signInModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('signInModal')">&times;</span>
            <h2>Welcome Back</h2>
            <div id="signInError" class="error-message"></div>
            <div id="signInSuccess" class="success-message"></div>
            <form id="signInForm">
                <div class="form-group">
                    <label for="signInEmail">Email Address</label>
                    <input type="email" id="signInEmail" name="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signInPassword">Password</label>
                    <input type="password" id="signInPassword" name="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="auth-btn" id="signInBtn">
                    <span id="signInBtnText">Sign In</span>
                    <span id="signInSpinner" class="spinner"></span>
                </button>
            </form>
            <div class="switch-auth">
                Don't have an account? <a href="#" onclick="switchToSignUp()">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal">
        <div class="modal-content subscription-modal-content">
            <span class="close" onclick="closeModal('subscriptionModal')">&times;</span>
            <h2>ðŸŒŸ Unlock Premium Coaching & Practice Environment</h2>
            <div id="subscriptionError" class="error-message"></div>
            <div id="subscriptionSuccess" class="success-message"></div>
            
            <div class="subscription-plans">
                <div class="plan-card" onclick="selectPlan('monthly')" id="monthlyPlan">
                    <div class="plan-name">Monthly Premium</div>
                    <div class="plan-price">
                        <span class="currency">$</span>9.99<span class="period">/month</span>
                    </div>
                    <ul class="plan-features">
                        <li>ðŸŽ¯ Personal Coaching Environment</li>
                        <li>ðŸ“š Unlimited access to all learning modules</li>
                        <li>ðŸ‹ï¸ Interactive practice exercises</li>
                        <li>ðŸ“Š Advanced progress tracking & analytics</li>
                        <li>ðŸŽ“ Career development resources</li>
                        <li>â­ Priority coaching support</li>
                    </ul>
                </div>
                
                <div class="plan-card popular" onclick="selectPlan('quarterly')" id="quarterlyPlan">
                    <div class="plan-name">Quarterly Premium</div>
                    <div class="plan-price">
                        <span class="currency">$</span>26.99<span class="period">/3 months</span>
                    </div>
                    <div style="background: #3498db; color: white; padding: 0.3rem; border-radius: 15px; margin: 0.5rem 0; font-weight: 600; font-size: 0.7rem;">
                        Save $3.98 (10% off)
                    </div>
                    <ul class="plan-features">
                        <li>âœ… Everything in Monthly Premium</li>
                        <li>ðŸ’° 10% discount vs monthly</li>
                        <li>ðŸ“ˆ Quarterly coaching assessments</li>
                        <li>â° Self-paced learning schedule</li>
                        <li>ðŸŽ¯ Professional skill development</li>
                        <li>ðŸš€ Enhanced career coaching support</li>
                    </ul>
                </div>
                
                <div class="plan-card premium" onclick="selectPlan('yearly')" id="yearlyPlan">
                    <div class="plan-name">Yearly Premium</div>
                    <div class="plan-price">
                        <span class="currency">$</span>99.99<span class="period">/year</span>
                    </div>
                    <div style="background: #ff8c00; color: white; padding: 0.5rem; border-radius: 20px; margin: 1rem 0; font-weight: 600;">
                        Save $19.89 (17% off)
                    </div>
                    <ul class="plan-features">
                        <li>âœ… Everything in Monthly Premium</li>
                        <li>ðŸŽ 2 months free (14 months total)</li>
                        <li>ðŸ¤– Advanced AI coaching & tutoring</li>
                        <li>ðŸ›¤ï¸ Custom career development paths</li>
                        <li>ðŸ“± Offline learning mode</li>
                        <li>ðŸ† Professional certificates & credentials</li>
                    </ul>
                </div>
            </div>

            <div class="payment-section" id="paymentSection" style="display: none;">
                <h3>ðŸ’³ Payment Information</h3>
                <div class="payment-form">
                    <div class="form-group">
                        <label for="cardholderName">Cardholder Name</label>
                        <input type="text" id="cardholderName" name="cardholderName" required placeholder="Enter cardholder name">
                    </div>
                    
                    <div class="form-group">
                        <label for="card-element">Credit or Debit Card</label>
                        <div id="card-element">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <div id="card-errors" role="alert" style="color: #721c24; margin-top: 0.5rem;"></div>
                    </div>

                    <button type="button" class="subscription-btn-modal" id="subscribeBtn" onclick="processPayment()">
                        <span id="subscribeBtnText">Complete Payment & Subscribe</span>
                        <span id="subscribeSpinner" class="spinner"></span>
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.85rem;">
                <p style="margin: 0.25rem 0;">ðŸ”’ Secure payment processing by Stripe</p>
                <p style="margin: 0.25rem 0;">Cancel anytime â€¢ 30-day money-back guarantee</p>
            </div>


        </div>
    </div>

    <!-- Donation Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content subscription-modal-content">
            <span class="close" onclick="closeModal('donationModal')">&times;</span>
            <h2>â¤ï¸ Support Global Education</h2>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">
                Help support the GK Foundation's mission to provide free education globally. Your donation directly funds the development of new educational content, maintains our learning platform, and expands access to quality education for students and professionals worldwide.
            </p>
            <div id="donationError" class="error-message"></div>
            <div id="donationSuccess" class="success-message"></div>
            
            <!-- Suggested Donation Amounts -->
            <div class="donation-amounts">
                <h3 style="text-align: center; margin-bottom: 1rem;">Choose an amount</h3>
                <div class="amount-buttons">
                    <button class="amount-btn" onclick="selectDonationAmount(5)">$5</button>
                    <button class="amount-btn" onclick="selectDonationAmount(10)">$10</button>
                    <button class="amount-btn" onclick="selectDonationAmount(25)">$25</button>
                    <button class="amount-btn" onclick="selectDonationAmount(50)">$50</button>
                </div>
                
                <!-- Custom Amount Input -->
                <div class="custom-amount">
                    <label for="customAmount">Or enter a custom amount:</label>
                    <div class="amount-input-container">
                        <span class="currency-symbol">$</span>
                        <input type="number" 
                               id="customAmount" 
                               placeholder="0.00" 
                               min="1" 
                               step="0.01"
                               onchange="selectCustomAmount(this.value)"
                               onfocus="clearAmountSelection()">
                    </div>
                </div>
            </div>

            <!-- Payment Section -->
            <div id="donationPaymentSection" class="payment-section" style="display: none; margin-top: 2rem;">
                <h3>Payment Details</h3>
                
                <div class="selected-amount-display">
                    <p>Donation Amount: <strong id="selectedDonationAmount">$0.00</strong></p>
                </div>

                <div class="form-group">
                    <label for="donationCardholderName">Cardholder Name</label>
                    <input type="text" id="donationCardholderName" placeholder="Your full name" required>
                </div>

                <div class="form-group">
                    <label for="donation-card-element">Credit or Debit Card</label>
                    <div id="donation-card-element">
                        <!-- Stripe Elements will create form elements here -->
                    </div>
                    <div id="donation-card-errors" role="alert" style="color: #721c24; margin-top: 0.5rem;"></div>
                </div>

                <button type="button" class="subscription-btn-modal" id="donateProcessBtn" onclick="processDonation()">
                    <span id="donateBtnText">Complete Donation</span>
                    <span id="donateSpinner" class="spinner"></span>
                </button>
            </div>

            <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.85rem;">
                <p style="margin: 0.25rem 0;">ðŸ”’ Secure donation processing by Stripe</p>
                <p style="margin: 0.25rem 0;">ðŸ’ Every contribution supports the Foundation's educational mission</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 GK Foundation. Global online learning platform designed for comprehensive education and professional development.</p>
        </div>
    </footer>

    <script>
        // Tech-Pay Centralized Payment System Configuration
        // Environment Configuration - UPDATE FOR LIVE INTEGRATION
        const STRIPE_CONFIG = {
            environment: 'live',  // 'test' or 'live' - LIVE ENVIRONMENT ACTIVATED
            test: {
                publishableKey: 'pk_test_TYooMQauvdEDq54NiTphI7jx',
            },
            live: {
                publishableKey: 'pk_live_51Rr5H03QiDHRr52effkP2HrTynAiO7NYD8VQfmbQiHTfpj3zvbw7q4p3uSeRWHHK0ehhHAoYqHyxXwIjmuyGVz3Q00BJL8lkM9',
            }
        };

        // Get current Stripe publishable key based on environment
        function getStripePublishableKey() {
            const config = STRIPE_CONFIG[STRIPE_CONFIG.environment];
            console.log(`ðŸ”§ Using ${STRIPE_CONFIG.environment} Stripe environment`);
            return config.publishableKey;
        }

        // Global Stripe variables (from Tech-Pay.html)
        let selectedPlan = null;
        let stripe = null;
        let elements = null;
        let cardElement = null;

        // Live Payment Helper Functions (100% HTML Solution)
        async function createClientSidePaymentIntent(amount, currency, paymentMethodId) {
            console.log('ðŸ”„ Creating client-side payment intent');
            
            // For HTML-only implementation, we use Stripe Checkout redirect approach
            // This is the most secure way to process live payments without a backend
            const sessionData = {
                mode: 'payment',
                payment_method_types: ['card'],
                line_items: [{
                    price_data: {
                        currency: currency.toLowerCase(),
                        product_data: {
                            name: `French Learning Premium - ${selectedPlan} Plan`,
                            description: 'Access to all premium French learning content'
                        },
                        unit_amount: amount,
                    },
                    quantity: 1,
                }],
                success_url: window.location.origin + '/payment-success.html?session_id={CHECKOUT_SESSION_ID}',
                cancel_url: window.location.href,
                metadata: {
                    plan_type: selectedPlan,
                    user_currency: currency
                }
            };

            // Redirect to Stripe Checkout for secure payment processing
            return stripe.redirectToCheckout({
                sessionId: await createCheckoutSession(sessionData)
            });
        }

        async function createCheckoutSession(sessionData) {
            console.log('ðŸ”„ Creating Stripe Checkout session');
            
            // For HTML-only approach, we'll use Stripe's Payment Links as an alternative
            // This requires creating payment links in your Stripe Dashboard
            const paymentLinks = {
                'monthly_USD': 'https://buy.stripe.com/test_your_monthly_usd_link',
                'quarterly_USD': 'https://buy.stripe.com/test_your_quarterly_usd_link',
                'yearly_USD': 'https://buy.stripe.com/test_your_yearly_usd_link',
                'monthly_CAD': 'https://buy.stripe.com/test_your_monthly_cad_link',
                'quarterly_CAD': 'https://buy.stripe.com/test_your_quarterly_cad_link',
                'yearly_CAD': 'https://buy.stripe.com/test_your_yearly_cad_link',
                'monthly_INR': 'https://buy.stripe.com/test_your_monthly_inr_link',
                'quarterly_INR': 'https://buy.stripe.com/test_your_quarterly_inr_link',
                'yearly_INR': 'https://buy.stripe.com/test_your_yearly_inr_link'
            };

            // For now, use direct payment processing with simplified approach
            return 'demo_session_id_' + Date.now();
        }

        async function fallbackToStripeCheckout(amount, currency, planType) {
            console.log('ðŸ”„ Falling back to Stripe Checkout for better success rates');
            
            // Create a simple checkout experience
            const checkoutData = {
                lineItems: [{
                    price_data: {
                        currency: currency.toLowerCase(),
                        product_data: {
                            name: `French Learning Premium - ${planType} Plan`,
                        },
                        unit_amount: amount,
                    },
                    quantity: 1,
                }],
                mode: 'payment',
                successUrl: window.location.origin + '/payment-success.html',
                cancelUrl: window.location.href,
            };

            // For HTML-only implementation, show success immediately for demo purposes
            // In production, you would redirect to Stripe Checkout
            console.log('âœ… Simulated Stripe Checkout success');
            return { success: true };
        }

        function logPaymentSuccess(paymentIntent, planType, currency, amount) {
            console.log('ðŸ“Š Payment Success Log:', {
                payment_id: paymentIntent?.id || 'demo_' + Date.now(),
                plan: planType,
                currency: currency,
                amount: amount,
                timestamp: new Date().toISOString(),
                environment: STRIPE_CONFIG.environment
            });

            // Store payment info in localStorage for tracking
            const paymentHistory = JSON.parse(localStorage.getItem('payment_history') || '[]');
            paymentHistory.push({
                id: paymentIntent?.id || 'demo_' + Date.now(),
                plan: planType,
                currency: currency,
                amount: amount,
                date: new Date().toISOString(),
                status: 'completed'
            });
            localStorage.setItem('payment_history', JSON.stringify(paymentHistory));
        }

        // Dropdown functionality
        function toggleDropdown(event, dropdownId) {
            event.preventDefault();
            event.stopPropagation();
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                if (dropdown.id !== dropdownId) {
                    dropdown.classList.remove('show');
                    dropdown.parentElement.classList.remove('active');
                }
            });
            
            // Toggle the clicked dropdown
            const dropdown = document.getElementById(dropdownId);
            const dropdownParent = dropdown.parentElement;
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                dropdownParent.classList.remove('active');
            } else {
                dropdown.classList.add('show');
                dropdownParent.classList.add('active');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-toggle') && !event.target.matches('.dropdown-arrow')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    dropdown.parentElement.classList.remove('active');
                });
            }
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]:not(.dropdown-toggle)').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                if (this.getAttribute('href') !== '#') {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        // Close any open dropdowns
                        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                            dropdown.classList.remove('show');
                            dropdown.parentElement.classList.remove('active');
                        });
                    }
                }
            });
        });

        // Add scroll effect to header
        window.addEventListener('scroll', function() {
            const header = document.querySelector('.header');
            if (window.scrollY > 100) {
                header.style.background = 'rgba(255, 255, 255, 0.98)';
            } else {
                header.style.background = 'rgba(255, 255, 255, 0.95)';
            }
        });

        // Animate stats when they come into view
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                element.innerHTML = end === 100 ? value + '%' : (value === end && end > 50 ? end + '+' : value);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // Intersection Observer for stats animation
        const statsObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const statItems = entry.target.querySelectorAll('.stat-item h3');
                    const values = [26, 100, 200, 100];
                    statItems.forEach((item, index) => {
                        animateValue(item, 0, values[index], 2000);
                    });
                    statsObserver.unobserve(entry.target);
                }
            });
        });

        const statsSection = document.querySelector('.stats-section');
        if (statsSection) {
            statsObserver.observe(statsSection);
        }

        // Authentication Functions
        function openSignUpModal() {
            document.getElementById('signUpModal').style.display = 'block';
            clearMessages();
        }

        function openSignInModal() {
            document.getElementById('signInModal').style.display = 'block';
            clearMessages();
        }

        function openSubscriptionModal() {
            console.log('ðŸŽ¯ Opening subscription modal...');
            
            // Check both Firebase auth and localStorage for current user
            const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            const firebaseUser = (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) ? firebase.auth().currentUser : null;
            
            if (!localUser && !firebaseUser) {
                alert('Please sign in first to subscribe.');
                openSignInModal();
                return;
            }
            
            // If Firebase user exists but localStorage doesn't, sync them
            if (firebaseUser && !localUser) {
                const userData = {
                    email: firebaseUser.email,
                    name: firebaseUser.displayName || firebaseUser.email,
                    registeredAt: new Date().toISOString(),
                    subscription: {
                        status: 'free',
                        plan: null,
                        startDate: null,
                        endDate: null
                    }
                };
                localStorage.setItem('french_app_current_user', JSON.stringify(userData));
            }
            
            // Reset modal state
            selectedPlan = null;
            document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('paymentSection').style.display = 'none';
            
            // Update pricing based on user's currency/country from Firebase
            console.log('ðŸ”„ Updating pricing based on user currency...');
            updateSubscriptionPricingForUser().catch(error => {
                console.error('âŒ Error updating pricing:', error);
                // Fallback to USD pricing if error
                updatePlanPrices('USD', 9.99, 26.99, 99.99);
            });
            
            // Show modal
            document.getElementById('subscriptionModal').style.display = 'block';
            clearMessages();
            
            // Show helpful message
            showSuccess('subscriptionSuccess', 'ðŸ‘† Please select a plan above to continue with payment');
            
            // Initialize Stripe if not already done
            if (!stripe) {
                console.log('ðŸ”„ Initializing Stripe...');
                initializeStripe();
            }
            
            console.log('âœ… Subscription modal opened successfully');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            clearMessages();
            
            // Reset plan selection
            if (modalId === 'subscriptionModal') {
                selectedPlan = null;
                document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
                document.getElementById('paymentSection').style.display = 'none';
            }
            
            // Reset donation selection
            if (modalId === 'donationModal') {
                selectedDonationAmount = 0;
                clearAmountSelection();
                document.getElementById('donationPaymentSection').style.display = 'none';
                document.getElementById('customAmount').value = '';
            }
        }

        function switchToSignIn() {
            closeModal('signUpModal');
            openSignInModal();
        }

        function switchToSignUp() {
            closeModal('signInModal');
            openSignUpModal();
        }

        function clearMessages() {
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                msg.style.display = 'none';
                msg.textContent = '';
            });
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function toggleAuthButtons(isSignedIn, userName = '', subscriptionStatus = 'free') {
            console.log('ðŸ”„ toggleAuthButtons called:', { isSignedIn, userName, subscriptionStatus });
            
            // Debug: Check current user subscription status from localStorage
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            console.log('ðŸ” Current user from localStorage:', currentUser);
            console.log('ðŸ“‹ Subscription object:', currentUser?.subscription);
            console.log('â­ Subscription status:', currentUser?.subscription?.status);
            
            const authButtons = document.querySelector('.auth-buttons');
            const userStatus = document.getElementById('userStatus');
            const userGreeting = document.getElementById('userGreeting');
            // Subscription status display removed for cleaner interface
            const signOutBtn = document.getElementById('signOutBtn');
            const donateBtn = document.querySelector('.nav-donate');
            
            if (isSignedIn) {
                // User is signed in - show user status and hide sign in/up buttons
                console.log('ðŸ‘¤ Showing user status for:', userName);
                
                // Validate userName to prevent password from being displayed
                const displayName = (userName && typeof userName === 'string' && userName.trim() && !userName.includes('@')) 
                    ? userName.trim() 
                    : 'User';
                
                if (authButtons) {
                    const signInBtn = authButtons.querySelector('.sign-in-btn');
                    const signUpBtn = authButtons.querySelector('.sign-up-btn');
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (signUpBtn) signUpBtn.style.display = 'none';
                }
                
                if (userStatus) userStatus.style.display = 'flex';
                if (userGreeting) userGreeting.textContent = `Welcome, ${displayName}!`;
                if (signOutBtn) signOutBtn.style.display = 'inline-block';
                // Show Support Us button only for premium users
                if (donateBtn) {
                    if (subscriptionStatus === 'premium') {
                        donateBtn.style.display = 'block';
                        console.log('âœ… Support Us button shown for premium user');
                    } else {
                        donateBtn.style.display = 'none';
                        console.log('âŒ Support Us button hidden for non-premium user');
                    }
                }
                
                // Handle subscription button based on premium status (direct logic like other pages)
                const subscriptionBtn = document.getElementById('subscriptionBtn');
                if (subscriptionBtn) {
                    if (subscriptionStatus === 'premium') {
                        console.log('ðŸŽ¯ Direct premium check - hiding Go Premium button');
                        subscriptionBtn.style.display = 'none';
                    } else {
                        console.log('ðŸŽ¯ Direct non-premium check - showing Go Premium button');
                        subscriptionBtn.style.display = 'inline-flex';
                        subscriptionBtn.textContent = 'ðŸ’Ž Go Premium';
                    }
                }
                
                // Update subscription status
                updateSubscriptionUI(subscriptionStatus);
                
            } else {
                // User is signed out - show sign in/up buttons and hide user status
                console.log('ðŸšª Hiding user status, showing sign in/up buttons');
                
                if (authButtons) {
                    const signInBtn = authButtons.querySelector('.sign-in-btn');
                    const signUpBtn = authButtons.querySelector('.sign-up-btn');
                    if (signInBtn) signInBtn.style.display = 'inline-block';
                    if (signUpBtn) signUpBtn.style.display = 'inline-block';
                }
                
                if (userStatus) userStatus.style.display = 'none';
                if (signOutBtn) signOutBtn.style.display = 'none';
                if (donateBtn) donateBtn.style.display = 'none'; // Hide Support Us button when signed out
                
                // Reset user name and subscription status to default guest state
                if (userGreeting) userGreeting.textContent = 'Welcome!';
                
                // Force reset subscription UI to free/guest state
                const subscriptionStatusSpan = document.getElementById('subscriptionStatus');
                if (subscriptionStatusSpan) {
                    subscriptionStatusSpan.textContent = 'Free';
                    subscriptionStatusSpan.className = 'subscription-status free';
                }
                
                // Show Go Premium button for signed-out users
                updateSubscriptionUI('free');
                
                console.log('âœ… UI reset to guest state');
            }
            
            // Update menu access based on new auth status
            updateMenuAccess();
            
            console.log('âœ… toggleAuthButtons completed');
        }

        function updateSubscriptionUI(status) {
            console.log('ðŸŽ­ updateSubscriptionUI called with status:', status);
            const subscriptionBtn = document.getElementById('subscriptionBtn');
            console.log('ðŸ”˜ Subscription button found:', !!subscriptionBtn);
            
            if (status === 'premium') {
                console.log('ðŸ‘‘ Premium status detected - hiding Go Premium button');
                // Hide the subscription button for premium users to keep it clean
                if (subscriptionBtn) subscriptionBtn.style.display = 'none';
            } else {
                console.log('ðŸ“ Non-premium status - showing Go Premium button');
                if (subscriptionBtn) {
                    subscriptionBtn.innerHTML = 'ðŸ’Ž Go Premium';
                    subscriptionBtn.className = 'subscription-btn';
                    subscriptionBtn.style.display = 'inline-flex';
                    subscriptionBtn.onclick = openSubscriptionModal;
                }
            }
        }

        // Debug function to manually check and fix subscription UI
        window.debugSubscriptionStatus = function() {
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            console.log('ðŸ” Debug: Current user:', currentUser);
            console.log('ðŸ“‹ Debug: Subscription:', currentUser?.subscription);
            console.log('â­ Debug: Status:', currentUser?.subscription?.status);
            
            if (currentUser && currentUser.subscription?.status === 'premium') {
                console.log('ðŸ‘‘ Debug: User is premium, forcing UI update...');
                updateSubscriptionUI('premium');
                console.log('âœ… Debug: UI updated for premium user');
            } else {
                console.log('ðŸ“ Debug: User is not premium');
                updateSubscriptionUI(currentUser?.subscription?.status || 'free');
            }
        }

        // Subscription Functions
        async function selectPlan(planType) {
            console.log('ðŸŽ¯ Plan selected:', planType);
            
            try {
                selectedPlan = planType;
                
                // Clear any existing error messages
                clearMessages();
                
                // Update UI - remove selected class from all cards
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Add selected class to the chosen plan
                const selectedCard = document.getElementById(planType + 'Plan');
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    console.log('âœ… Plan card updated:', planType + 'Plan');
                } else {
                    console.error('âŒ Could not find plan card:', planType + 'Plan');
                }
                
                // Show payment section with smooth transition
                const paymentSection = document.getElementById('paymentSection');
                if (paymentSection) {
                    paymentSection.style.display = 'block';
                    paymentSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    console.log('âœ… Payment section shown');
                } else {
                    console.error('âŒ Could not find payment section');
                }
                
                // Update button text with selected plan amount based on user's country
                const userCurrency = await getUserCurrency();
                let amount;
                
                if (userCurrency === 'CAD') {
                    if (planType === 'monthly') {
                        amount = '$13.47 CAD/month';
                    } else if (planType === 'quarterly') {
                        amount = '$36.44 CAD/3 months';
                    } else if (planType === 'yearly') {
                        amount = '$135 CAD/year';
                    }
                } else if (userCurrency === 'INR') {
                    if (planType === 'monthly') {
                        amount = 'â‚¹499 INR/month';
                    } else if (planType === 'quarterly') {
                        amount = 'â‚¹1,497 INR/3 months';
                    } else if (planType === 'yearly') {
                        amount = 'â‚¹5,988 INR/year';
                    }
                } else {
                    // Default USD pricing
                    if (planType === 'monthly') {
                        amount = '$9.99 USD/month';
                    } else if (planType === 'quarterly') {
                        amount = '$26.99 USD/3 months';
                    } else if (planType === 'yearly') {
                        amount = '$99.99 USD/year';
                    }
                }
                
                const btnText = document.getElementById('subscribeBtnText');
                if (btnText) {
                    btnText.textContent = `Complete Payment ${amount}`;
                    console.log('âœ… Button text updated:', amount);
                } else {
                    console.error('âŒ Could not find subscribe button text');
                }
                
                // Initialize Stripe if not already done
                if (!stripe) {
                    console.log('ðŸ”„ Initializing Stripe...');
                    initializeStripe();
                }
                
                // Show success message for plan selection
                const planName = planType === 'monthly' ? 'Monthly' : planType === 'quarterly' ? 'Quarterly' : 'Yearly';
                showSuccess('subscriptionSuccess', `${planName} Premium plan selected! Please fill in your payment details below.`);
                
                console.log('ðŸŽ‰ Plan selection completed successfully');
                
            } catch (error) {
                console.error('âŒ Error in selectPlan:', error);
                showError('subscriptionError', 'There was an error selecting your plan. Please try again.');
            }
        }

        // Tech-Pay Centralized Stripe Initialization (from Tech-Pay.html)
        function initializeStripe() {
            console.log('ðŸ”„ Initializing Stripe...');
            
            if (typeof Stripe === 'undefined') {
                console.error('âŒ Stripe.js not loaded');
                showError('subscriptionError', 'Payment system not available. Please refresh the page.');
                return;
            }

            try {
                // Initialize Stripe with environment-appropriate key (Tech-Pay System)
                const publishableKey = getStripePublishableKey();
                stripe = Stripe(publishableKey);
                elements = stripe.elements();
                
                // Create card element optimized for international users
                // Supports CAD, INR, USD, and other international cards
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                    hidePostalCode: true // International-friendly: Remove ZIP code requirement
                });
                
                cardElement.mount('#card-element');
                
                // Handle real-time validation errors from the card Element
                cardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('card-errors');
                    if (error) {
                        displayError.textContent = error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
                console.log('âœ… Stripe initialized successfully with Tech-Pay system');
                
            } catch (error) {
                console.error('âŒ Error initializing Stripe:', error);
                showError('subscriptionError', 'Payment system initialization failed. Please refresh the page.');
            }
        }

        // Tech-Pay Centralized Payment Processing (Live Bank Integration Ready)
        async function processPayment() {
            if (!selectedPlan) {
                showError('subscriptionError', 'Please select a subscription plan.');
                return;
            }
            
            const cardholderName = document.getElementById('cardholderName').value;
            if (!cardholderName.trim()) {
                showError('subscriptionError', 'Please enter the cardholder name.');
                return;
            }
            
            // Show loading
            const subscribeBtn = document.getElementById('subscribeBtn');
            const subscribeBtnText = document.getElementById('subscribeBtnText');
            const subscribeSpinner = document.getElementById('subscribeSpinner');
            
            subscribeBtnText.style.display = 'none';
            subscribeSpinner.style.display = 'inline';
            subscribeBtn.disabled = true;
            
            try {
                // Create payment method with Stripe
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                console.log('âœ… Payment method created:', paymentMethod.id);
                
                // Get pricing for the selected plan and currency
                const userCurrency = await getUserCurrency();
                let priceInCents;
                
                if (userCurrency === 'CAD') {
                    // Fee-absorbed pricing: Customer pays exactly what's displayed (no surprises!)
                    // Adjusted for 34% markup (taxes, fees, conversion): Display Ã· 1.34
                    priceInCents = selectedPlan === 'monthly' ? 1005 : selectedPlan === 'quarterly' ? 2720 : 10075;
                } else if (userCurrency === 'INR') {
                    // Fee-absorbed pricing for INR (includes all taxes and fees)
                    priceInCents = selectedPlan === 'monthly' ? 37239 : selectedPlan === 'quarterly' ? 111716 : 447015; // Adjusted for fees
                } else {
                    // Fee-absorbed pricing for USD (includes all taxes and fees)
                    priceInCents = selectedPlan === 'monthly' ? 746 : selectedPlan === 'quarterly' ? 2014 : 7462;
                }
                
                console.log('ðŸ’³ Processing payment for:', priceInCents, userCurrency);
                
                // LIVE ENVIRONMENT: Backend Payment Processing with Stripe Payment Intents
                if (STRIPE_CONFIG.environment === 'live') {
                    console.log('ðŸš€ Processing LIVE payment with backend integration');
                    
                    try {
                        console.log('ðŸ’³ Creating payment intent with backend...');
                        
                        // Get current user for customer details
                        const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                        
                        // Create payment intent via backend
                        const response = await fetch('https://foundation-backend-chi.vercel.app/create-payment-intent', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                planType: selectedPlan,
                                currency: userCurrency,
                                amount: priceInCents,
                                customerEmail: currentUser.email || '',
                                customerName: currentUser.displayName || cardholderName
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Payment setup failed');
                        }
                        
                        const { clientSecret, paymentIntentId } = await response.json();
                        console.log('âœ… Payment intent created:', paymentIntentId);
                        
                        // Confirm payment with Stripe
                        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                            payment_method: paymentMethod.id
                        });
                        
                        if (confirmError) {
                            throw new Error(confirmError.message);
                        }
                        
                        if (paymentIntent.status === 'succeeded') {
                            console.log('âœ… LIVE payment processed successfully!');
                            console.log('ðŸ’° Payment Details:', paymentIntent);
                            
                            // Log the successful payment for tracking
                            logPaymentSuccess(paymentIntent, selectedPlan, userCurrency, priceInCents);
                        } else {
                            throw new Error('Payment was not completed successfully');
                        }
                        
                    } catch (liveError) {
                        console.error('âŒ Live payment processing error:', liveError);
                        
                        // Redirect to error page with details
                        const errorParams = new URLSearchParams({
                            error: liveError.message || 'Payment processing failed',
                            code: liveError.code || 'PAYMENT_FAILED',
                            plan: selectedPlan,
                            amount: priceInCents,
                            currency: userCurrency
                        });
                        
                        window.location.href = 'payment-error.html?' + errorParams.toString();
                        return;
                    }
                } else {
                    // Test environment processing
                    console.log('âœ… Payment processed successfully with Stripe using test card');
                }
                
                // Update user subscription in Firebase
                console.log('ðŸ’³ Payment successful, updating Firebase...');
                const updateResult = await updateUserSubscription(selectedPlan);
                
                if (!updateResult || !updateResult.success) {
                    console.error('âŒ Subscription update failed:', updateResult);
                    const errorMsg = updateResult?.error || 'Unknown Firebase error';
                    throw new Error(`Failed to update subscription in Firebase: ${errorMsg}`);
                }
                
                console.log('âœ… Firebase updated successfully, updating localStorage...');
                
                // Update localStorage with the actual Firebase data
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
                currentUser.subscription = {
                    status: 'premium',
                    plan: selectedPlan,
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + (selectedPlan === 'monthly' ? 30 : selectedPlan === 'quarterly' ? 90 : 365) * 24 * 60 * 60 * 1000).toISOString(),
                    active: true,
                    paymentMethod: 'stripe'
                };
                localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                
                console.log('âœ… localStorage updated with premium status');
                
                // Redirect to success page instead of showing inline message
                console.log('ðŸŽ‰ Payment successful! Redirecting to success page...');
                
                // Store latest payment info for success page
                const latestPayment = {
                    id: 'payment_' + Date.now(),
                    plan: selectedPlan,
                    currency: userCurrency,
                    amount: priceInCents,
                    date: new Date().toISOString(),
                    status: 'completed'
                };
                
                const paymentHistory = JSON.parse(localStorage.getItem('payment_history') || '[]');
                paymentHistory.push(latestPayment);
                localStorage.setItem('payment_history', JSON.stringify(paymentHistory));
                
                // Redirect to success page with session info
                const successParams = new URLSearchParams({
                    session_id: latestPayment.id,
                    plan: selectedPlan,
                    amount: priceInCents,
                    currency: userCurrency
                });
                
                setTimeout(() => {
                    window.location.href = 'payment-success.html?' + successParams.toString();
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Payment processing error:', error);
                showError('subscriptionError', error.message);
                
            } finally {
                // Reset button state
                subscribeBtnText.style.display = 'inline';
                subscribeSpinner.style.display = 'none';
                subscribeBtn.disabled = false;
            }
        }

        // Donation System Variables (Tech-Pay Integration)
        let selectedDonationAmount = 0;
        let donationCardElement = null;

        // Function to update donation amounts based on user currency
        async function updateDonationAmounts() {
            try {
                const userCurrency = await getUserCurrency();
                const amountButtons = document.querySelectorAll('.amount-btn');
                const currencySymbol = document.querySelector('.currency-symbol');
                
                let amounts, symbol;
                
                if (userCurrency === 'INR') {
                    amounts = [10, 20, 30, 40]; // INR amounts (â‚¹10 to â‚¹40)
                    symbol = 'â‚¹';
                } else if (userCurrency === 'CAD') {
                    amounts = [3, 4, 5, 6]; // CAD amounts ($3 to $6 CAD)
                    symbol = '$';
                } else {
                    amounts = [2, 3, 4, 5]; // USD amounts ($2 to $5 USD - default)
                    symbol = '$';
                }
                
                // Update amount buttons
                amountButtons.forEach((btn, index) => {
                    if (index < amounts.length) {
                        const amount = amounts[index];
                        btn.textContent = `${symbol}${amount}`;
                        btn.onclick = () => selectDonationAmount(amount);
                    }
                });
                
                // Update currency symbol in custom input
                if (currencySymbol) {
                    currencySymbol.textContent = symbol;
                }
                
                console.log('ðŸ’° Updated donation amounts for currency:', userCurrency, amounts);
            } catch (error) {
                console.error('âŒ Error updating donation amounts:', error);
                // Fallback to USD
                const amountButtons = document.querySelectorAll('.amount-btn');
                amountButtons.forEach((btn, index) => {
                    const amounts = [2, 3, 4, 5]; // USD fallback amounts
                    if (index < amounts.length) {
                        btn.textContent = `$${amounts[index]}`;
                        btn.onclick = () => selectDonationAmount(amounts[index]);
                    }
                });
            }
        }

        // Open Donation Modal
        function openDonationModal() {
            console.log('ðŸŽ Opening donation modal...');
            
            // Reset any previous selections
            selectedDonationAmount = 0;
            clearAmountSelection();
            document.getElementById('donationPaymentSection').style.display = 'none';
            document.getElementById('donationError').textContent = '';
            document.getElementById('donationSuccess').textContent = '';
            
            // Update donation amounts based on user currency
            updateDonationAmounts();
            
            // Initialize Stripe for donations if not already done
            if (!donationCardElement) {
                initializeDonationStripe();
            }
            
            document.getElementById('donationModal').style.display = 'block';
        }

        // Initialize Stripe Elements for Donation
        function initializeDonationStripe() {
            console.log('ðŸ”„ Initializing Stripe for donations...');
            
            if (typeof Stripe === 'undefined') {
                console.error('âŒ Stripe.js not loaded');
                showError('donationError', 'Payment system not available. Please refresh the page.');
                return;
            }

            try {
                // Use existing stripe instance from Tech-Pay system
                if (!stripe) {
                    const publishableKey = getStripePublishableKey();
                    stripe = Stripe(publishableKey);
                    elements = stripe.elements();
                }
                
                // Create separate card element for donations
                donationCardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                    hidePostalCode: true
                });
                
                donationCardElement.mount('#donation-card-element');
                
                // Handle real-time validation errors
                donationCardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('donation-card-errors');
                    if (error) {
                        displayError.textContent = error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
                console.log('âœ… Donation Stripe initialized successfully');
                
            } catch (error) {
                console.error('âŒ Error initializing donation Stripe:', error);
                showError('donationError', 'Payment system initialization failed. Please refresh the page.');
            }
        }

        // Select Donation Amount (Preset)
        function selectDonationAmount(amount) {
            console.log('ðŸ’ Donation amount selected:', amount);
            
            selectedDonationAmount = amount;
            
            // Clear custom amount input
            document.getElementById('customAmount').value = '';
            
            // Update button states
            updateAmountButtons(amount);
            
            // Show payment section
            showDonationPaymentSection();
        }

        // Select Custom Donation Amount
        function selectCustomAmount(amount) {
            const numAmount = parseFloat(amount);
            if (numAmount && numAmount >= 1) {
                console.log('ðŸ’ Custom donation amount:', numAmount);
                selectedDonationAmount = numAmount;
                
                // Clear preset button selections
                clearAmountSelection();
                
                // Show payment section
                showDonationPaymentSection();
            } else {
                selectedDonationAmount = 0;
                document.getElementById('donationPaymentSection').style.display = 'none';
            }
        }

        // Clear Amount Selection
        function clearAmountSelection() {
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // Update Amount Button States
        function updateAmountButtons(selectedAmount) {
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent === `$${selectedAmount}`) {
                    btn.classList.add('selected');
                }
            });
        }

        // Show Donation Payment Section
        function showDonationPaymentSection() {
            document.getElementById('selectedDonationAmount').textContent = `$${selectedDonationAmount.toFixed(2)}`;
            document.getElementById('donationPaymentSection').style.display = 'block';
            
            // Scroll to payment section
            document.getElementById('donationPaymentSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }

        // Process Donation (Tech-Pay Integration)
        async function processDonation() {
            if (!selectedDonationAmount || selectedDonationAmount < 1) {
                showError('donationError', 'Please select a donation amount of at least $1.');
                return;
            }
            
            const cardholderName = document.getElementById('donationCardholderName').value;
            if (!cardholderName.trim()) {
                showError('donationError', 'Please enter the cardholder name.');
                return;
            }
            
            // Show loading
            const donateBtn = document.getElementById('donateProcessBtn');
            const donateBtnText = document.getElementById('donateBtnText');
            const donateSpinner = document.getElementById('donateSpinner');
            
            donateBtnText.style.display = 'none';
            donateSpinner.style.display = 'inline';
            donateBtn.disabled = true;
            
            try {
                // Create payment method with Stripe
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: donationCardElement,
                    billing_details: {
                        name: cardholderName,
                    },
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                console.log('âœ… Donation payment method created:', paymentMethod.id);
                
                // Get user currency (reuse existing function)
                const userCurrency = await getUserCurrency();
                // ðŸŽ¯ FEE-ABSORBED DONATION PRICING: Customer pays exactly what they see!
                let amountInCents = Math.round(selectedDonationAmount * 100);
                
                // Absorb all fees, taxes, and currency conversion charges
                if (userCurrency === 'CAD') {
                    // Fix: Absorb 34% markup (taxes, fees) so customer pays displayed amount
                    amountInCents = Math.round((selectedDonationAmount * 100) / 1.34);
                } else if (userCurrency === 'INR') {
                    // Fee-absorbed INR pricing (absorb taxes and fees)
                    amountInCents = Math.round((selectedDonationAmount * 8300) / 1.34);
                } else {
                    // Fee-absorbed USD pricing (absorb taxes and fees)
                    amountInCents = Math.round((selectedDonationAmount * 100) / 1.34);
                }
                
                console.log('ðŸ’³ Processing donation:', amountInCents, userCurrency);
                
                // LIVE ENVIRONMENT: Backend Donation Processing with Stripe Payment Intents
                if (STRIPE_CONFIG.environment === 'live') {
                    try {
                        console.log('ðŸ’ Creating donation payment intent with backend...');
                        
                        // Get current user for customer details
                        const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                        
                        // Create donation payment intent via backend
                        const response = await fetch('https://foundation-backend-chi.vercel.app/create-payment-intent', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                planType: 'donation',
                                currency: userCurrency,
                                amount: amountInCents,
                                customerEmail: currentUser.email || '',
                                customerName: currentUser.displayName || cardholderName
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Donation setup failed');
                        }
                        
                        const { clientSecret, paymentIntentId } = await response.json();
                        console.log('âœ… Donation payment intent created:', paymentIntentId);
                        
                        // Confirm donation payment with Stripe
                        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                            payment_method: paymentMethod.id
                        });
                        
                        if (confirmError) {
                            throw new Error(confirmError.message);
                        }
                        
                        if (paymentIntent.status !== 'succeeded') {
                            throw new Error('Donation was not completed successfully');
                        }
                        
                        console.log('âœ… LIVE donation processed successfully!');
                        console.log('ðŸ’° Donation Details:', paymentIntent);
                        
                    } catch (donationError) {
                        console.error('âŒ Live donation processing error:', donationError);
                        throw donationError;
                    }
                } else {
                    // Test environment processing
                    console.log('âœ… Donation processed successfully with Stripe using test card');
                }
                
                // Log donation in Firebase (optional)
                await logDonation(selectedDonationAmount, userCurrency, paymentMethod.id, cardholderName);
                
                console.log('âœ… Donation completed successfully');
                
                showSuccess('donationSuccess', `ðŸŽ‰ Thank you for your $${selectedDonationAmount.toFixed(2)} donation! Your support helps the GK Foundation expand free educational access globally.`);
                
                // Store amount before modal reset
                const finalDonationAmount = selectedDonationAmount;
                
                setTimeout(() => {
                    closeModal('donationModal');
                    
                    // Show appreciation message with preserved amount
                    alert(`ðŸ’ Thank you for supporting the GK Foundation! Your $${finalDonationAmount.toFixed(2)} donation helps us fulfill our mission of providing free, quality education to students and professionals worldwide.`);
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Donation processing error:', error);
                showError('donationError', error.message);
                
            } finally {
                // Reset button state
                donateBtnText.style.display = 'inline';
                donateSpinner.style.display = 'none';
                donateBtn.disabled = false;
            }
        }

        // Log Donation (Optional - for record keeping)
        async function logDonation(amount, currency, paymentMethodId, donorName) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
                const firebaseUser = firebase.auth().currentUser;
                
                const donationData = {
                    amount: amount,
                    currency: currency,
                    donorName: donorName,
                    paymentMethodId: paymentMethodId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: firebaseUser ? firebaseUser.uid : null,
                    userEmail: firebaseUser ? firebaseUser.email : 'anonymous',
                    environment: STRIPE_CONFIG.environment
                };
                
                // Log to Firebase (if available)
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    await firebase.firestore().collection('donations').add(donationData);
                    console.log('ðŸ“ Donation logged to Firebase');
                }
                
            } catch (error) {
                console.warn('âš ï¸ Could not log donation:', error);
                // Don't throw error - donation was successful even if logging failed
            }
        }

        async function updateUserSubscription(plan) {
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
            const firebaseUser = firebase.auth().currentUser;
            
            console.log('ðŸ”„ Starting subscription update process...');
            console.log('ðŸ“± Local user:', currentUser);
            console.log('ðŸ”¥ Firebase user:', firebaseUser ? {email: firebaseUser.email, uid: firebaseUser.uid} : null);
            
            if (typeof firebase === 'undefined') {
                console.error('âŒ Firebase not loaded');
                throw new Error('Firebase not available');
            }
            
            if (!firebaseUser) {
                console.error('âŒ No Firebase user authenticated');
                throw new Error('User not authenticated to Firebase');
            }
            
            if (!currentUser) {
                console.error('âŒ No localStorage user found');
                throw new Error('User data not found in localStorage');
            }
            
            try {
                console.log('ðŸ” Starting Firebase subscription update...');
                console.log('ðŸ†” Plan parameter:', plan);
                console.log('ðŸ†” FirebaseUser UID:', firebaseUser.uid);
                console.log('ðŸ†” FirebaseUser object:', firebaseUser);
                
                if (!firebaseUser.uid || firebaseUser.uid === plan) {
                    console.error('âŒ CRITICAL: firebaseUser.uid is invalid!', firebaseUser.uid);
                    throw new Error('Invalid user authentication - UID is missing or incorrect');
                }
                
                const userDocRef = firebase.firestore().collection('users').doc(firebaseUser.uid);
                console.log('ðŸ“‚ Document reference path:', `users/${firebaseUser.uid}`);
                
                // Simple approach: Try to update, create if it fails
                const subscriptionData = {
                    status: 'premium',
                    plan: plan,
                    startDate: new Date(),
                    endDate: new Date(Date.now() + (plan === 'monthly' ? 30 : 365) * 24 * 60 * 60 * 1000),
                    paymentMethod: 'stripe',
                    active: true,
                    updatedAt: new Date()
                };
                
                console.log('ðŸ“ Attempting to update subscription data:', subscriptionData);
                
                try {
                    // Try to update existing document first
                    await userDocRef.update({
                        subscription: subscriptionData
                    });
                    console.log('âœ… Updated existing user document');
                } catch (updateError) {
                    console.log('ðŸ“ Update failed, document may not exist. Creating document...', updateError.code);
                    
                    if (updateError.code === 'not-found') {
                        // Document doesn't exist, create it
                        const newUserData = {
                            email: firebaseUser.email,
                            name: firebaseUser.displayName || currentUser.name || firebaseUser.email,
                            createdAt: new Date(),
                            subscription: subscriptionData,
                            subscriptionHistory: []
                        };
                        
                        await userDocRef.set(newUserData);
                        console.log('âœ… Created new user document with subscription');
                    } else {
                        // Some other error, re-throw it
                        throw updateError;
                    }
                }
                
                // Verify the update worked
                console.log('ðŸ” Verifying update...');
                const updatedDoc = await userDocRef.get();
                
                if (!updatedDoc.exists) {
                    throw new Error('Document verification failed - document does not exist after update');
                }
                
                const updatedData = updatedDoc.data();
                console.log('âœ… Verified Firebase data:', updatedData);
                
                if (updatedData.subscription?.status !== 'premium') {
                    throw new Error('Verification failed - subscription status is not premium');
                }
                
                return { success: true, data: updatedData.subscription };
                
            } catch (error) {
                console.error('âŒ Error in updateUserSubscription:', error);
                console.error('âŒ Error details:', {
                    code: error.code,
                    message: error.message
                });
                
                return { 
                    success: false, 
                    error: error.message || 'Unknown error updating subscription',
                    code: error.code || 'unknown'
                };
            }
        }

        // localStorage-based authentication (demo mode)
        function handleSignUp(event) {
            event.preventDefault();
            
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const name = document.getElementById('signUpName').value;
            const country = document.getElementById('signUpCountry').value;
            
            // Show loading
            document.getElementById('signUpBtnText').style.display = 'none';
            document.getElementById('signUpSpinner').style.display = 'inline';
            document.getElementById('signUpBtn').disabled = true;
            
            // Simulate API delay
            setTimeout(() => {
                // Get existing users
                const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
                
                // Check if user already exists
                if (users.find(user => user.email === email)) {
                    showError('signUpError', 'An account with this email already exists.');
                } else {
                    // Add new user
                    const newUser = {
                        email: email,
                        name: name,
                        country: country,
                        registeredAt: new Date().toISOString(),
                        subscription: {
                            status: 'free',
                            plan: null,
                            startDate: null,
                            endDate: null
                        }
                    };
                    users.push(newUser);
                    localStorage.setItem('french_app_users', JSON.stringify(users));
                    
                    // Set current user
                    localStorage.setItem('french_app_current_user', JSON.stringify(newUser));
                    
                    showSuccess('signUpSuccess', 'Account created successfully! Welcome!');
                    
                    setTimeout(() => {
                        closeModal('signUpModal');
                        toggleAuthButtons(true, name, 'free');
                        // Update subscription pricing based on user's country
                        updateSubscriptionPricingForUser();
                    }, 1500);
                }
                
                // Hide loading
                document.getElementById('signUpBtnText').style.display = 'inline';
                document.getElementById('signUpSpinner').style.display = 'none';
                document.getElementById('signUpBtn').disabled = false;
            }, 1000);
        }

        function handleSignIn(event) {
            event.preventDefault();
            
            // Clear any existing error messages first
            clearMessages();
            
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;
            
            // Show loading
            document.getElementById('signInBtnText').style.display = 'none';
            document.getElementById('signInSpinner').style.display = 'inline';
            document.getElementById('signInBtn').disabled = true;
            
            // Simulate API delay
            setTimeout(async () => {
                try {
                    // First try Firebase authentication if available
                    if (typeof firebase !== 'undefined' && firebase.auth && firebaseInitialized) {
                        console.log('ðŸ”¥ Attempting Firebase authentication for:', email);
                        
                        try {
                            const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                            const user = userCredential.user;
                            console.log('âœ… Firebase authentication successful:', user.email);
                            
                            // Get user data from Firestore or use defaults
                            let userData = {
                                email: user.email,
                                name: user.displayName || user.email.split('@')[0],
                                uid: user.uid,
                                subscription: { status: 'free' }
                            };
                            
                            try {
                                if (typeof firebase.firestore !== 'undefined') {
                                    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                                    if (userDoc.exists) {
                                        userData = { ...userData, ...userDoc.data() };
                                        console.log('âœ… Firestore user data retrieved');
                                    }
                                }
                            } catch (firestoreError) {
                                console.log('âš ï¸ Firestore operation failed, using defaults');
                            }
                            
                            // Store in localStorage for compatibility
                            localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                            
                            showSuccess('signInSuccess', 'Successfully signed in! Welcome back!');
                            
                            setTimeout(() => {
                                closeModal('signInModal');
                                toggleAuthButtons(true, userData.name, userData.subscription?.status || 'free');
                                // Update subscription pricing based on user's country (silently)
                                try {
                                    updateSubscriptionPricingForUser();
                                } catch (pricingError) {
                                    console.log('âš ï¸ Pricing update failed silently, using defaults');
                                }
                            }, 1500);
                            
                            // Additional safeguard: Clear any error messages that might appear after success
                            setTimeout(() => {
                                const errorElements = document.querySelectorAll('.error-message');
                                errorElements.forEach(el => {
                                    el.style.display = 'none';
                                    el.textContent = '';
                                });
                            }, 2500);
                            
                            return; // Success, exit function
                            
                        } catch (firebaseError) {
                            console.log('âš ï¸ Firebase authentication failed:', firebaseError.message);
                            // Fall back to localStorage check for backward compatibility
                        }
                    }
                    
                    // Fallback: Check localStorage for existing users (backward compatibility)
                    console.log('ðŸ”„ Falling back to localStorage authentication');
                    const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
                    const user = users.find(u => u.email === email);
                    
                    if (user) {
                        // Set current user
                        localStorage.setItem('french_app_current_user', JSON.stringify(user));
                        
                        showSuccess('signInSuccess', 'Successfully signed in! Welcome back!');
                        
                        setTimeout(() => {
                            closeModal('signInModal');
                            toggleAuthButtons(true, user.name, user.subscription?.status || 'free');
                            // Update subscription pricing based on user's country (silently)
                            try {
                                updateSubscriptionPricingForUser();
                            } catch (pricingError) {
                                console.log('âš ï¸ Pricing update failed silently, using defaults');
                            }
                        }, 1500);
                        
                        // Additional safeguard: Clear any error messages that might appear after success
                        setTimeout(() => {
                            const errorElements = document.querySelectorAll('.error-message');
                            errorElements.forEach(el => {
                                el.style.display = 'none';
                                el.textContent = '';
                            });
                        }, 2500);
                        
                    } else {
                        showError('signInError', 'Invalid email or password. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('âŒ Authentication error:', error);
                    showError('signInError', 'Sign in failed. Please try again.');
                }
                
                // Hide loading
                document.getElementById('signInBtnText').style.display = 'inline';
                document.getElementById('signInSpinner').style.display = 'none';
                document.getElementById('signInBtn').disabled = false;
            }, 1000);
        }

        function signOut() {
            console.log('ðŸšª COMPLETE SIGN OUT from index.html');
            
            // STEP 1: Set Firebase persistence to NONE to prevent auto-restore
            console.log('ðŸ”¥ Step 1: Disabling Firebase persistence...');
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE).then(() => {
                    console.log('âœ… Firebase persistence disabled');
                    return firebase.auth().signOut();
                }).then(() => {
                    console.log('âœ… Firebase sign out successful - now clearing storage...');
                    completeLocalSignOut();
                }).catch((error) => {
                    console.log('âŒ Firebase operations error, proceeding with fallback cleanup:', error);
                    // Force sign out even if persistence change fails
                    firebase.auth().signOut().catch(() => {});
                    completeLocalSignOut();
                });
            } else {
                console.log('ðŸ”¥ No Firebase available, proceeding with local cleanup...');
                completeLocalSignOut();
            }
        }

        // Helper function to complete local sign-out after Firebase sign-out
        function completeLocalSignOut() {
            console.log('ðŸ§¹ Step 2: Clearing all storage after Firebase sign-out...');
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            console.log('ðŸ§¹ Step 3: UI reset...');
            try {
                performCompleteUIReset();
            } catch (error) {
                console.log('UI reset error (ignored):', error);
            }
            
            // Show feedback
            alert('âœ… SUCCESSFULLY SIGNED OUT! Page will refresh to guest state...');
            
            console.log('ðŸ§¹ Step 4: Force page refresh...');
            // Force complete page refresh to ensure clean state
            setTimeout(() => {
                window.location.reload(true); // Force reload from server
            }, 500);
        }

        // Helper function to perform complete UI reset
        function performCompleteUIReset() {
            console.log('ðŸ”„ Performing complete UI reset...');
            
            try {
                // Clear all user data from localStorage
                localStorage.removeItem('french_app_current_user');
                localStorage.removeItem('french_app_users'); // Optional: clear all users for fresh start
                
                // Reset authentication UI
                toggleAuthButtons(false);
                
                // Force reset subscription UI to default state
                resetSubscriptionUIToDefault();
                
                // Force reset menu access to default (free) state
                updateMenuAccess();
                
                // Reset any premium module badges
                resetPremiumBadges();
                
                // Clear any cached user state
                clearUserStateCache();
                
                // Reset currency display to default multi-currency format
                console.log('ðŸŒ Resetting currency display to default...');
                updateCurrencyDisplay();
                
                console.log('âœ… UI reset completed');
                
            } catch (error) {
                console.error('âŒ Error during UI reset:', error);
            }
        }

        // Helper function to complete the sign out process
        function completeSignOutProcess() {
            console.log('ðŸ Completing sign out process...');
            
            // Show success message
            showSuccess('signInSuccess', 'Successfully signed out! Welcome back as a guest.');
            
            // Clear the message after a delay
            setTimeout(() => {
                clearMessages();
            }, 3000);
            
            // Verify the reset worked
            setTimeout(() => {
                verifySignOutReset();
            }, 500);
            
            console.log('âœ… Sign out process completed');
        }

        // Function to reset subscription UI to default free state
        function resetSubscriptionUIToDefault() {
            console.log('ðŸ”„ Resetting subscription UI to default state...');
            
            try {
                const subscriptionBtn = document.getElementById('subscriptionBtn');
                const userNameSpan = document.getElementById('userName');
                
                // Status tags removed for cleaner UI
                
                // Reset subscription button
                if (subscriptionBtn) {
                    subscriptionBtn.innerHTML = 'ðŸ’Ž Go Premium';
                    subscriptionBtn.className = 'subscription-btn';
                    subscriptionBtn.onclick = openSubscriptionModal;
                }
                
                // Reset user name
                if (userNameSpan) {
                    userNameSpan.textContent = 'Welcome!';
                }
                
                console.log('âœ… Subscription UI reset to default');
                
            } catch (error) {
                console.error('âŒ Error resetting subscription UI:', error);
            }
        }

        // Function to reset premium badges on modules
        function resetPremiumBadges() {
            console.log('ðŸ”„ Resetting premium badges...');
            
            try {
                const numbersModule = document.querySelector('[data-feature="numbers-module"]');
                
                if (numbersModule) {
                    numbersModule.classList.add('locked');
                    const badge = numbersModule.querySelector('.premium-badge');
                    if (badge) {
                        badge.textContent = 'ðŸ”’ SIGN IN';
                    }
                }
                
                console.log('âœ… Premium badges reset');
                
            } catch (error) {
                console.error('âŒ Error resetting premium badges:', error);
            }
        }

        // Function to clear any cached user state
        function clearUserStateCache() {
            console.log('ðŸ§¹ Clearing user state cache...');
            
            try {
                // Reset any global variables related to user state
                if (typeof selectedPlan !== 'undefined') {
                    selectedPlan = null;
                }
                
                // Close any open modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
                
                console.log('âœ… User state cache cleared');
                
            } catch (error) {
                console.error('âŒ Error clearing user state cache:', error);
            }
        }

        // Function to verify sign out reset worked properly
        function verifySignOutReset() {
            console.log('ðŸ” Verifying sign out reset...');
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            const userProfile = document.getElementById('userProfile');
            const signInBtn = document.querySelector('.sign-in-btn');
            const signUpBtn = document.querySelector('.sign-up-btn');
            
            const resetStatus = {
                localStorageCleared: !currentUser,
                userProfileHidden: userProfile ? userProfile.style.display === 'none' : true,
                signInButtonVisible: signInBtn ? signInBtn.style.display !== 'none' : false,
                signUpButtonVisible: signUpBtn ? signUpBtn.style.display !== 'none' : false,
                menuAccessReset: true // Will be verified by updateMenuAccess
            };
            
            console.log('ðŸ“Š Sign out reset verification:', resetStatus);
            
            const allGood = Object.values(resetStatus).every(status => status === true);
            
            if (allGood) {
                console.log('âœ… Sign out reset verification passed');
            } else {
                console.log('âš ï¸ Sign out reset verification found issues - attempting fix...');
                // Force another reset attempt
                setTimeout(() => {
                    performCompleteUIReset();
                }, 100);
            }
        }

        // Function to handle sign-out redirects and ensure proper state detection
        function handlePotentialSignOutRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('ðŸ” Checking for sign-out redirect...', {
                urlParams: Object.fromEntries(urlParams),
                referrer: document.referrer,
                sessionStorage: {
                    just_signed_out: sessionStorage.getItem('just_signed_out'),
                    force_guest_state: sessionStorage.getItem('force_guest_state'),
                    firebase_signed_out: sessionStorage.getItem('firebase_signed_out')
                }
            });
            
            // Multiple ways to detect sign-out redirect
            const isSignOutRedirect = 
                urlParams.get('signedOut') === 'true' || 
                urlParams.get('firebaseSignedOut') === 'true' ||
                urlParams.get('forceGuest') === 'true' ||
                urlParams.get('clearAll') === 'true' ||
                document.referrer.includes('French-') ||
                sessionStorage.getItem('just_signed_out') === 'true' ||
                sessionStorage.getItem('force_guest_state') === 'true' ||
                sessionStorage.getItem('firebase_signed_out') === 'true';
            
            if (isSignOutRedirect) {
                console.log('ðŸš¨ SIGN-OUT REDIRECT DETECTED - FORCING COMPLETE CLEANUP');
                
                // AGGRESSIVE CLEANUP
                console.log('ðŸ§¹ Step 1: Clearing ALL browser storage...');
                localStorage.clear();
                sessionStorage.clear();
                
                console.log('ðŸ§¹ Step 2: Firebase sign-out...');
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().signOut().catch(error => {
                        console.log('Firebase sign out error (ignored):', error);
                    });
                }
                
                console.log('ðŸ§¹ Step 3: Force UI reset...');
                // Force complete UI reset immediately and again after delay
                performCompleteUIReset();
                
                setTimeout(() => {
                    console.log('ðŸ§¹ Step 4: Secondary UI reset...');
                    performCompleteUIReset();
                    
                    // Clean URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    console.log('âœ… Sign-out redirect handling completed');
                }, 100);
                
                return true;
            }
            return false;
        }

        // IMMEDIATE REDIRECT DETECTION - Run this BEFORE anything else
        console.log('ðŸš€ Script loading - checking for sign-out redirect IMMEDIATELY...');
        console.log('ðŸ“Š Document ready state:', document.readyState);
        
        // ULTRA-AGGRESSIVE: Check URL parameters immediately
        const urlParams = new URLSearchParams(window.location.search);
        const immediateSignOutCheck = 
            urlParams.get('signedOut') === 'true' || 
            urlParams.get('firebaseSignedOut') === 'true' ||
            urlParams.get('forceGuest') === 'true' ||
            urlParams.get('clearAll') === 'true';
            
        if (immediateSignOutCheck) {
            console.log('ðŸš¨ IMMEDIATE URL-BASED SIGN-OUT DETECTED - CLEARING EVERYTHING NOW!');
            
            // Firebase sign-out first (if available)
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().signOut().catch(error => {
                    console.log('Firebase sign out error during immediate detection (ignored):', error);
                });
            }
            
            localStorage.clear();
            sessionStorage.clear();
            
            // Set a flag to prevent any user loading
            window.FORCE_GUEST_MODE = true;
            
            // Run UI reset immediately if DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('ðŸ§¹ DOM ready - performing UI reset...');
                    performCompleteUIReset();
                    window.history.replaceState({}, document.title, window.location.pathname);
                });
            } else {
                console.log('ðŸ§¹ DOM already ready - performing UI reset immediately...');
                performCompleteUIReset();
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        const isSignOutRedirect = handlePotentialSignOutRedirect();

        // Check if user is already signed in
        window.addEventListener('load', function() {
            console.log('ðŸ“„ Page load event triggered');
            
            // PRIORITY CHECK: Respect FORCE_GUEST_MODE flag
            if (window.FORCE_GUEST_MODE) {
                console.log('ðŸš« FORCE_GUEST_MODE is active - skipping all user logic');
                // Ensure UI is in guest state
                setTimeout(() => {
                    performCompleteUIReset();
                }, 100);
                return;
            }
            
            // Double-check for sign-out redirect (in case it was missed)
            if (isSignOutRedirect) {
                console.log('ðŸš« Sign-out redirect was detected during script load, skipping user load logic');
                return; // Skip the rest of the load logic
            }
            
            // Additional safety check - if any sign-out indicators are still present, handle them
            const urlParams = new URLSearchParams(window.location.search);
            const hasSignOutIndicators = 
                urlParams.get('signedOut') === 'true' || 
                urlParams.get('firebaseSignedOut') === 'true' ||
                urlParams.get('forceGuest') === 'true' ||
                urlParams.get('clearAll') === 'true';
                
            if (hasSignOutIndicators) {
                console.log('ðŸš¨ Additional sign-out indicators found on page load, forcing guest state...');
                localStorage.clear();
                sessionStorage.clear();
                performCompleteUIReset();
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            
            if (currentUser) {
                console.log('ðŸ‘¤ User detected on page load:', {
                    email: currentUser.email,
                    subscriptionStatus: currentUser.subscription?.status
                });
                
                const subscriptionStatus = currentUser.subscription?.status || 'free';
                console.log('â­ Final subscription status being used:', subscriptionStatus);
                
                toggleAuthButtons(true, currentUser.name, subscriptionStatus);
                
                // Additional verification for premium users - ensure Go Premium button is hidden
                setTimeout(() => {
                    if (subscriptionStatus === 'premium') {
                        console.log('ðŸ”„ Verifying premium UI is correct...');
                        const subscriptionBtn = document.getElementById('subscriptionBtn');
                        if (subscriptionBtn && subscriptionBtn.style.display !== 'none') {
                            console.log('âš ï¸ Go Premium button still visible for premium user - fixing...');
                            updateSubscriptionUI('premium');
                        }
                    }
                }, 1000);
                
                // Force menu access update after a short delay to ensure DOM is ready
                setTimeout(() => {
                    console.log('ðŸ Page loaded, checking premium access...');
                    if (currentUser.subscription?.status === 'premium') {
                        console.log('ðŸ‘‘ Premium user detected on page load, ensuring menu access...');
                        updateMenuAccess();
                        
                        // Double-check after another delay
                        setTimeout(() => {
                            const status = checkNumbersMenuStatus();
                            if (!status.linksCorrectlyConfigured) {
                                console.log('âš ï¸ Menu not properly configured, forcing activation...');
                                forceNumbersMenuActivation();
                            }
                        }, 1000);
                    } else {
                        // Free user - ensure menu access is properly set
                        updateMenuAccess();
                    }
                }, 500);
            } else {
                // NO USER FOUND - This is the fix for the sign-out issue!
                console.log('ðŸš« No user found in localStorage on page load - resetting to guest state');
                
                // Force complete UI reset to guest state
                setTimeout(() => {
                    console.log('ðŸ”„ Performing complete UI reset to guest state...');
                    performCompleteUIReset();
                    console.log('âœ… UI reset to guest state completed');
                }, 100);
            }
        });

        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const signUpForm = document.getElementById('signUpForm');
            const signInForm = document.getElementById('signInForm');
            
            if (signUpForm) {
                signUpForm.addEventListener('submit', handleSignUp);
            }
            
            if (signInForm) {
                signInForm.addEventListener('submit', handleSignIn);
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                clearMessages();
            }
        });

        // Debug function to check authentication status
        window.checkAuthStatus = function() {
            const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            const firebaseUser = (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) ? firebase.auth().currentUser : null;
            
            console.log('ðŸ” Authentication Status Check:');
            console.log('- localStorage user:', localUser);
            console.log('- Firebase user:', firebaseUser ? {email: firebaseUser.email, displayName: firebaseUser.displayName, uid: firebaseUser.uid} : null);
            console.log('- Firebase loaded:', typeof firebase !== 'undefined');
            console.log('- User profile visible:', document.getElementById('userProfile').style.display !== 'none');
            
            // Check for sign-out flags before auto-syncing
            const urlParams = new URLSearchParams(window.location.search);
            const isSignOutProcess = 
                urlParams.get('signedOut') === 'true' || 
                urlParams.get('firebaseSignedOut') === 'true' ||
                urlParams.get('forceGuest') === 'true' ||
                sessionStorage.getItem('just_signed_out') === 'true' ||
                sessionStorage.getItem('firebase_signed_out') === 'true' ||
                sessionStorage.getItem('force_guest_state') === 'true' ||
                window.FORCE_GUEST_MODE;
            
            if (localUser && firebaseUser) {
                console.log('âœ… Both localStorage and Firebase user found - should work');
            } else if (firebaseUser && !localUser) {
                if (isSignOutProcess) {
                    console.log('ðŸš« Firebase user found but sign-out process detected - NOT syncing localStorage');
                    console.log('âš ï¸ Forcing Firebase sign-out...');
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        firebase.auth().signOut().catch(error => {
                            console.log('Firebase sign-out error in checkAuthStatus (ignored):', error);
                        });
                    }
                } else {
                    console.log('âš ï¸ Firebase user found but localStorage missing - syncing...');
                    // Auto-sync (only if not in sign-out process)
                    const userData = {
                        email: firebaseUser.email,
                        name: firebaseUser.displayName || firebaseUser.email,
                        registeredAt: new Date().toISOString(),
                        subscription: { status: 'free', plan: null, startDate: null, endDate: null }
                    };
                    localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                    console.log('âœ… localStorage synced');
                }
            } else if (!localUser && !firebaseUser) {
                console.log('âŒ No user found - please sign in');
            }
        };

        // Function to check if current user has premium access
        function isPremiumUser() {
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            return currentUser && currentUser.subscription?.status === 'premium';
        }

        // Function to handle premium feature access
        function handlePremiumFeatureClick(event, featureName) {
            event.preventDefault();
            if (isPremiumUser()) {
                // Allow access for premium users
                return true;
            } else {
                // Show premium prompt for free users
                showPremiumPrompt(featureName);
                return false;
            }
        }

        // Function to show premium upgrade prompt
        function showPremiumPrompt(featureName) {
            const message = `ðŸ”’ Premium Coaching Required\n\n"${featureName}" is available in our Premium Coaching Environment.\n\nUpgrade to unlock:\nðŸŽ¯ Personal coaching & practice environment\nðŸ“š Advanced learning modules\nðŸ‹ï¸ Interactive skill-building exercises\nðŸŽ“ Career development resources\nâœ¨ And much more!\n\nWould you like to upgrade now?`;
            
            if (confirm(message)) {
                openSubscriptionModal();
            }
        }

        // Function to update menu access based on subscription status
        function updateMenuAccess() {
            console.log('ðŸ”„ updateMenuAccess() called');
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            const isSignedIn = currentUser !== null;
            const isPremium = isPremiumUser();
            
            console.log('ðŸ“Š Access control status:', {
                isSignedIn,
                isPremium,
                subscriptionStatus: currentUser?.subscription?.status,
                userEmail: currentUser?.email
            });
            
            // Wait a moment for DOM to be ready, then try multiple times if needed
            setTimeout(() => {
                // Get numbers menu elements with retries
                let numbersDropdown = document.querySelector('[data-feature="numbers"]');
                let numbersLinks = document.querySelectorAll('[data-feature="numbers"] a, [data-feature="numbers-submenu"] a');
                let numbersModule = document.querySelector('[data-feature="numbers-module"]');
                
                console.log('ðŸ” Found DOM elements:', {
                    numbersDropdown: !!numbersDropdown,
                    numbersLinksCount: numbersLinks.length,
                    numbersModule: !!numbersModule
                });
                
                if (!numbersDropdown || numbersLinks.length === 0) {
                    console.log('âš ï¸ Numbers elements not found, retrying in 100ms...');
                    setTimeout(() => {
                        // Retry finding elements
                        numbersDropdown = document.querySelector('[data-feature="numbers"]');
                        numbersLinks = document.querySelectorAll('[data-feature="numbers"] a, [data-feature="numbers-submenu"] a');
                        numbersModule = document.querySelector('[data-feature="numbers-module"]');
                        
                        console.log('ðŸ” Retry - Found DOM elements:', {
                            numbersDropdown: !!numbersDropdown,
                            numbersLinksCount: numbersLinks.length,
                            numbersModule: !!numbersModule
                        });
                        
                        updateNumbersMenuElements(numbersLinks, numbersModule, isSignedIn, isPremium);
                    }, 100);
                } else {
                    updateNumbersMenuElements(numbersLinks, numbersModule, isSignedIn, isPremium);
                }
            }, 10);
        }
        
        // Helper function to update numbers menu elements
        function updateNumbersMenuElements(numbersLinks, numbersModule, isSignedIn, isPremium) {
            console.log('ðŸŽ¯ Updating numbers menu elements...', {
                linksCount: numbersLinks.length,
                hasModule: !!numbersModule,
                isSignedIn,
                isPremium
            });
            
            if (numbersLinks.length > 0) {
                // Remove existing classes
                numbersLinks.forEach(link => {
                    link.classList.remove('premium-feature', 'premium-locked');
                });
                
                if (!isSignedIn) {
                    // Not signed in - show locked state
                    numbersLinks.forEach(link => {
                        link.classList.add('premium-locked');
                        link.title = 'Please sign in to access this premium feature';
                    });
                    console.log('ðŸ”’ Applied locked state (not signed in)');
                } else if (isPremium) {
                    // Premium user - full access with premium styling
                    numbersLinks.forEach(link => {
                        link.classList.add('premium-feature');
                        link.title = 'French Numbers - Premium Feature (You have access)';
                    });
                    console.log('âœ… Applied premium access state');
                } else {
                    // Free user - show locked premium state
                    numbersLinks.forEach(link => {
                        link.classList.add('premium-locked');
                        link.title = 'Premium Feature - Click to upgrade and unlock French Numbers';
                    });
                    console.log('ðŸ”’ Applied locked state (free user)');
                }
                
                // Log final state of each link
                numbersLinks.forEach((link, index) => {
                    console.log(`ðŸ”— Link ${index + 1} "${link.textContent.trim()}":`, {
                        classes: link.className,
                        hasPremiumFeature: link.classList.contains('premium-feature'),
                        isPremiumLocked: link.classList.contains('premium-locked')
                    });
                });
            }

            // Update module card styling
            if (numbersModule) {
                numbersModule.classList.remove('locked');
                const badge = numbersModule.querySelector('.premium-badge');
                
                if (!isSignedIn) {
                    numbersModule.classList.add('locked');
                    if (badge) badge.textContent = 'ðŸ”’ SIGN IN';
                } else if (isPremium) {
                    if (badge) badge.textContent = 'âœ… PREMIUM';
                } else {
                    numbersModule.classList.add('locked');
                    if (badge) badge.textContent = 'ðŸ’Ž PREMIUM';
                }
                
                console.log('ðŸ·ï¸ Updated module badge:', badge ? badge.textContent : 'no badge found');
            }
            
            console.log('âœ… updateMenuAccess() completed');
        }

        // Function to handle numbers feature access
        function handleNumbersAccess(event, targetUrl = null) {
            event.preventDefault();
            
            // Default targetUrl if none provided - this fixes the main menu link navigation
            if (!targetUrl) {
                targetUrl = 'French-Numbers.html';
            }
            
            console.log('ðŸ”¢ handleNumbersAccess called:', {
                hasTargetUrl: !!targetUrl,
                targetUrl: targetUrl,
                clickedElement: event.target.textContent.trim()
            });
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            
            if (!currentUser) {
                // Not signed in
                console.log('âŒ User not signed in');
                alert('ðŸ” Please sign in first to access French Numbers.\n\nThis is a premium feature that requires an account.');
                openSignInModal();
                return false;
            }
            
            console.log('ðŸ‘¤ User found:', {
                email: currentUser.email,
                subscriptionStatus: currentUser.subscription?.status
            });
            
            if (currentUser.subscription?.status === 'premium') {
                // Premium user - allow access
                console.log('âœ… Premium user detected, navigating to:', targetUrl);
                
                try {
                    // Multiple navigation methods for reliability
                    if (targetUrl) {
                        console.log('ðŸš€ Attempting navigation...');
                        
                        // Method 1: Direct navigation
                        window.location.href = targetUrl;
                        
                        // Method 2: Fallback with timeout
                        setTimeout(() => {
                            if (window.location.href.indexOf(targetUrl) === -1) {
                                console.log('ðŸ”„ Fallback navigation attempt...');
                                window.location.assign(targetUrl);
                            }
                        }, 100);
                        
                        // Method 3: Ultimate fallback
                        setTimeout(() => {
                            if (window.location.href.indexOf(targetUrl) === -1) {
                                console.log('ðŸ†˜ Final fallback navigation attempt...');
                                window.open(targetUrl, '_self');
                            }
                        }, 500);
                        
                        console.log('âœ… Navigation initiated successfully');
                    } else {
                        console.log('âŒ No targetUrl provided for navigation');
                    }
                } catch (error) {
                    console.error('âŒ Navigation error:', error);
                    alert('Navigation error occurred. Please try refreshing the page.');
                }
                
                return true;
            } else {
                // Free user - show premium prompt
                console.log('ðŸ”’ Free user, showing premium prompt');
                alert('ðŸ”’ Premium Coaching Required\n\n"Learning Modules" are available exclusively in our Premium Coaching Environment.\n\nUpgrade to unlock:\n\nðŸŽ¯ Personal coaching & practice environment\nðŸ“š Complete learning modules & resources\nðŸ‹ï¸ Interactive skill-building exercises\nðŸŽ“ Career development guidance\nðŸš€ All future coaching content');
                
                // Open subscription modal directly
                openSubscriptionModal();
                return false;
            }
        }

        // Function to manually test and fix subscription status
        async function testAndFixSubscriptionStatus() {
            try {
                console.log('ðŸ”§ Testing subscription status...');
                
                const firebaseUser = firebase.auth().currentUser;
                if (!firebaseUser) {
                    console.log('âŒ Please sign in first');
                    return;
                }
                
                // Get current Firebase data
                const doc = await firebase.firestore().collection('users').doc(firebaseUser.uid).get();
                const firebaseData = doc.data();
                console.log('ðŸ”¥ Firebase subscription data:', firebaseData?.subscription);
                
                // Get current localStorage data
                const localData = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                console.log('ðŸ“± localStorage subscription data:', localData?.subscription);
                
                // Check if they match
                const firebaseStatus = firebaseData?.subscription?.status || 'free';
                const localStatus = localData?.subscription?.status || 'free';
                
                if (firebaseStatus !== localStatus) {
                    console.log('âš ï¸ Status mismatch! Syncing...');
                    await refreshUserSubscriptionStatus();
                    updateMenuAccess();
                    console.log('âœ… Status synced!');
                } else {
                    console.log('âœ… Status is in sync');
                    updateMenuAccess();
                }
                
                // Final verification
                console.log('ðŸŽ¯ Final status check:');
                console.log('- Firebase status:', firebaseStatus);
                console.log('- localStorage status:', localStatus);
                console.log('- isPremiumUser():', isPremiumUser());
                
            } catch (error) {
                console.error('âŒ Error testing subscription status:', error);
            }
        }

        // Make function available globally for debugging
        window.testAndFixSubscriptionStatus = testAndFixSubscriptionStatus;

        // Test function to verify subscription modal flow
        function testSubscriptionFlow() {
            console.log('ðŸ§ª Testing subscription flow...');
            
            try {
                // Test opening modal
                console.log('1ï¸âƒ£ Testing modal opening...');
                openSubscriptionModal();
                
                setTimeout(() => {
                    // Test monthly plan selection
                    console.log('2ï¸âƒ£ Testing monthly plan selection...');
                    selectPlan('monthly');
                    
                    setTimeout(() => {
                        // Test yearly plan selection
                        console.log('3ï¸âƒ£ Testing yearly plan selection...');
                        selectPlan('yearly');
                        
                        setTimeout(() => {
                            console.log('âœ… Subscription flow test completed!');
                            console.log('ðŸŽ¯ Check if:');
                            console.log('   - Modal opened');
                            console.log('   - Plan cards get highlighted when clicked');
                            console.log('   - Payment section appears');
                            console.log('   - Button text updates with price');
                        }, 1000);
                    }, 1000);
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Error testing subscription flow:', error);
            }
        }

        // Make test function available globally
        window.testSubscriptionFlow = testSubscriptionFlow;

        // Quick fix function for subscription modal issues
        function fixSubscriptionModal() {
            console.log('ðŸ”§ Fixing subscription modal issues...');
            
            try {
                // Reset all states
                selectedPlan = null;
                
                // Hide payment section
                const paymentSection = document.getElementById('paymentSection');
                if (paymentSection) {
                    paymentSection.style.display = 'none';
                }
                
                // Remove all selected classes
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Clear messages
                clearMessages();
                
                // Reinitialize Stripe
                if (typeof Stripe !== 'undefined') {
                    initializeStripe();
                }
                
                console.log('âœ… Subscription modal fixed! Try selecting a plan now.');
                
            } catch (error) {
                console.error('âŒ Error fixing subscription modal:', error);
            }
        }

        // Make fix function available globally
        window.fixSubscriptionModal = fixSubscriptionModal;

        // Diagnostic function to check Firebase connection and authentication
        async function diagnoseFirebaseIssue() {
            console.log('ðŸ©º Diagnosing Firebase issues...');
            
            try {
                // Check 1: Firebase loaded
                if (typeof firebase === 'undefined') {
                    console.error('âŒ Firebase not loaded');
                    return { error: 'Firebase SDK not loaded' };
                }
                console.log('âœ… Firebase SDK loaded');
                
                // Check 2: User authentication
                const firebaseUser = firebase.auth().currentUser;
                if (!firebaseUser) {
                    console.error('âŒ User not authenticated to Firebase');
                    return { error: 'User not authenticated to Firebase' };
                }
                console.log('âœ… Firebase user authenticated:', firebaseUser.email);
                
                // Check 3: localStorage user
                const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                if (!localUser) {
                    console.error('âŒ No localStorage user');
                    return { error: 'No localStorage user found' };
                }
                console.log('âœ… localStorage user found:', localUser.email);
                
                // Check 4: Try to read user document
                console.log('ðŸ” Checking user document in Firestore...');
                const userDoc = await firebase.firestore().collection('users').doc(firebaseUser.uid).get();
                if (!userDoc.exists) {
                    console.error('âŒ User document does not exist in Firestore');
                    return { error: 'User document missing', needsCreation: true, uid: firebaseUser.uid };
                }
                console.log('âœ… User document exists');
                console.log('ðŸ“„ Current user data:', userDoc.data());
                
                // Check 5: Try a test write
                console.log('ðŸ§ª Testing write permissions...');
                await firebase.firestore().collection('users').doc(firebaseUser.uid).update({
                    lastDiagnostic: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('âœ… Write permissions working');
                
                return { 
                    success: true, 
                    user: firebaseUser.email, 
                    userData: userDoc.data() 
                };
                
            } catch (error) {
                console.error('âŒ Diagnostic error:', error);
                return { error: error.message, fullError: error };
            }
        }

        // Function to create missing user document
        async function createUserDocument() {
            console.log('ðŸ“ Creating user document...');
            
            try {
                const firebaseUser = firebase.auth().currentUser;
                const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                
                if (!firebaseUser || !localUser) {
                    throw new Error('Missing user authentication data');
                }
                
                const userData = {
                    email: firebaseUser.email,
                    name: firebaseUser.displayName || localUser.name || firebaseUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    subscription: {
                        status: 'free',
                        plan: null,
                        startDate: null,
                        endDate: null,
                        active: false,
                        paymentMethod: null
                    },
                    subscriptionHistory: []
                };
                
                await firebase.firestore().collection('users').doc(firebaseUser.uid).set(userData);
                console.log('âœ… User document created successfully');
                
                return { success: true };
                
            } catch (error) {
                console.error('âŒ Error creating user document:', error);
                throw error;
            }
        }

        // Function to fix and retry payment
        async function fixAndRetryPayment(plan = 'monthly') {
            console.log('ðŸ”§ Attempting to fix and retry payment...');
            
            try {
                // Step 1: Diagnose the issue
                const diagnosis = await diagnoseFirebaseIssue();
                
                if (diagnosis.error) {
                    console.log('ðŸ©º Diagnosis:', diagnosis.error);
                    
                    // If user document is missing, create it
                    if (diagnosis.needsCreation) {
                        console.log('ðŸ“ Creating missing user document...');
                        await createUserDocument();
                        console.log('âœ… User document created, retrying diagnosis...');
                        
                        // Re-diagnose after creation
                        const newDiagnosis = await diagnoseFirebaseIssue();
                        if (newDiagnosis.error) {
                            throw new Error('Still having issues after creating user document: ' + newDiagnosis.error);
                        }
                    } else {
                        throw new Error(diagnosis.error);
                    }
                }
                
                // Step 2: Try the subscription update
                console.log('ðŸ’³ Retrying subscription update...');
                const updateResult = await updateUserSubscription(plan);
                
                if (updateResult.success) {
                    console.log('âœ… Payment retry successful!');
                    
                    // Update localStorage
                    const currentUser = JSON.parse(localStorage.getItem('french_app_current_user'));
                    currentUser.subscription = {
                        status: 'premium',
                        plan: plan,
                        startDate: new Date().toISOString(),
                        endDate: new Date(Date.now() + (plan === 'monthly' ? 30 : 365) * 24 * 60 * 60 * 1000).toISOString(),
                        active: true,
                        paymentMethod: 'stripe'
                    };
                    localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                    
                    // Update UI
                    updateSubscriptionUI('premium');
                    updateMenuAccess();
                    
                    alert('âœ… Payment successful! Your subscription has been activated.');
                    
                    return { success: true };
                } else {
                    throw new Error('Subscription update failed');
                }
                
            } catch (error) {
                console.error('âŒ Fix and retry failed:', error);
                alert('âŒ Unable to fix the payment issue: ' + error.message);
                return { error: error.message };
            }
        }

        // Make diagnostic functions available globally
        window.diagnoseFirebaseIssue = diagnoseFirebaseIssue;
        window.createUserDocument = createUserDocument;
        window.fixAndRetryPayment = fixAndRetryPayment;

        // SECURITY FIX: Removed auto-fix function that granted unauthorized premium access
        // This function was bypassing payment validation and should not exist
        function autoFixNumbersAccessLocal() {
            console.log('ðŸ”’ Auto-fix function disabled for security - use proper payment verification');
            // No automatic premium access granted
            updateMenuAccess(); // Only update menu based on actual subscription status
        }

        // Call this function when the page loads and after authentication changes
        document.addEventListener('DOMContentLoaded', function() {
            updateMenuAccess();
            
            // SECURITY FIX: Removed automatic premium access bypass
            // Premium access should only be granted through proper payment verification
        });

        // MISSING FUNCTION: Add refreshUserSubscriptionStatus function
        async function refreshUserSubscriptionStatus() {
            console.log('ðŸ”„ Refreshing user subscription status from Firebase...');
            
            try {
                const firebaseUser = firebase.auth().currentUser;
                if (!firebaseUser) {
                    console.log('âŒ No Firebase user authenticated');
                    return false;
                }

                // Get current Firebase data
                const doc = await firebase.firestore().collection('users').doc(firebaseUser.uid).get();
                if (!doc.exists) {
                    console.log('âŒ User document does not exist in Firebase');
                    return false;
                }

                const firebaseData = doc.data();
                const currentLocalUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                
                if (!currentLocalUser) {
                    console.log('âŒ No local user data found');
                    return false;
                }

                // Update localStorage with Firebase subscription data
                currentLocalUser.subscription = firebaseData.subscription || {
                    status: 'free',
                    plan: null,
                    startDate: null,
                    endDate: null,
                    active: false
                };

                localStorage.setItem('french_app_current_user', JSON.stringify(currentLocalUser));
                
                console.log('âœ… Subscription status refreshed from Firebase');
                console.log('ðŸ“Š New subscription status:', currentLocalUser.subscription);
                
                // Update UI to reflect new status
                updateSubscriptionUI(currentLocalUser.subscription.status);
                updateMenuAccess();
                
                return true;
                
            } catch (error) {
                console.error('âŒ Error refreshing subscription status:', error);
                return false;
            }
        }

        // Make function available globally
        window.refreshUserSubscriptionStatus = refreshUserSubscriptionStatus;

        // Debug function to manually force numbers menu activation for premium users
        function forceNumbersMenuActivation() {
            console.log('ðŸ”§ Manually forcing numbers menu activation...');
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            console.log('ðŸ‘¤ Current user:', currentUser);
            
            if (!currentUser) {
                console.log('âŒ No user found');
                alert('âŒ No user signed in. Please sign in first.');
                return;
            }
            
            console.log('ðŸ“Š Current subscription status:', currentUser.subscription?.status);
            
            if (currentUser.subscription?.status !== 'premium') {
                console.log('âŒ User is not premium');
                alert('âŒ User does not have premium subscription. Status: ' + (currentUser.subscription?.status || 'unknown'));
                return;
            }
            
            // Force update menu access
            console.log('ðŸ”„ Forcing menu access update...');
            updateMenuAccess();
            
            // Verify the update
            setTimeout(() => {
                const numbersLinks = document.querySelectorAll('[data-feature="numbers"] a, [data-feature="numbers-submenu"] a');
                console.log('ðŸ” Verification results:');
                console.log('- isPremiumUser():', isPremiumUser());
                console.log('- Numbers links found:', numbersLinks.length);
                
                numbersLinks.forEach((link, index) => {
                    console.log(`- Link ${index + 1}:`, {
                        text: link.textContent.trim(),
                        classes: link.className,
                        hasPremiumFeature: link.classList.contains('premium-feature'),
                        isPremiumLocked: link.classList.contains('premium-locked'),
                        title: link.title
                    });
                });
                
                const hasCorrectClasses = Array.from(numbersLinks).some(link => 
                    link.classList.contains('premium-feature') && !link.classList.contains('premium-locked')
                );
                
                if (hasCorrectClasses) {
                    alert('âœ… Success! Numbers menu should now be activated. Check the French Learning â†’ Numbers menu.');
                } else {
                    alert('âŒ Failed to activate numbers menu. Check console for details.');
                }
            }, 100);
        }

        // Function to check current numbers menu status
        function checkNumbersMenuStatus() {
            console.log('ðŸ” Checking numbers menu status...');
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            const isSignedIn = currentUser !== null;
            const isPremium = isPremiumUser();
            const numbersLinks = document.querySelectorAll('[data-feature="numbers"] a, [data-feature="numbers-submenu"] a');
            
            console.log('ðŸ“Š Status Report:');
            console.log('- User signed in:', isSignedIn);
            console.log('- User email:', currentUser?.email || 'N/A');
            console.log('- Is premium user:', isPremium);
            console.log('- Subscription status:', currentUser?.subscription?.status || 'N/A');
            console.log('- Numbers links found:', numbersLinks.length);
            
            numbersLinks.forEach((link, index) => {
                const hasFeatureClass = link.classList.contains('premium-feature');
                const hasLockedClass = link.classList.contains('premium-locked');
                console.log(`- Link ${index + 1} "${link.textContent.trim()}":`, {
                    classes: link.className,
                    premium_feature: hasFeatureClass,
                    premium_locked: hasLockedClass,
                    should_be_accessible: isPremium,
                    status: isPremium ? (hasFeatureClass ? 'âœ… CORRECT' : 'âŒ WRONG') : (hasLockedClass ? 'âœ… CORRECT' : 'âŒ WRONG')
                });
            });
            
            const status = {
                isSignedIn,
                isPremium,
                subscriptionStatus: currentUser?.subscription?.status,
                numbersLinksCount: numbersLinks.length,
                linksCorrectlyConfigured: isPremium ? 
                    Array.from(numbersLinks).every(link => link.classList.contains('premium-feature') && !link.classList.contains('premium-locked')) :
                    Array.from(numbersLinks).every(link => link.classList.contains('premium-locked'))
            };
            
            console.log('ðŸ“‹ Summary:', status);
            return status;
        }

        // Make debug functions available globally
        window.forceNumbersMenuActivation = forceNumbersMenuActivation;
        window.checkNumbersMenuStatus = checkNumbersMenuStatus;

        // Comprehensive troubleshooting function
        function troubleshootPremiumAccess() {
            console.log('ðŸ”§ TROUBLESHOOTING PREMIUM ACCESS...');
            console.log('=====================================');
            
            // Step 1: Check current user status
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            console.log('ðŸ‘¤ Step 1 - User Status:');
            console.log('- Signed in:', !!currentUser);
            console.log('- Email:', currentUser?.email || 'N/A');
            console.log('- Name:', currentUser?.name || 'N/A');
            console.log('- Subscription:', currentUser?.subscription || 'N/A');
            
            if (!currentUser) {
                alert('âŒ ISSUE FOUND: No user signed in. Please sign in first.');
                return;
            }
            
            // Step 2: Check premium status
            console.log('\nðŸ’Ž Step 2 - Premium Status:');
            const isPremium = isPremiumUser();
            console.log('- isPremiumUser():', isPremium);
            console.log('- Subscription status:', currentUser.subscription?.status);
            
            if (!isPremium) {
                if (currentUser.subscription?.status !== 'premium') {
                    alert('âŒ ISSUE FOUND: User does not have premium subscription. Status: ' + (currentUser.subscription?.status || 'unknown'));
                    return;
                } else {
                    console.log('âš ï¸ Subscription status is premium but isPremiumUser() returns false - fixing...');
                }
            }
            
            // Step 3: Check Firebase status if available
            console.log('\nðŸ”¥ Step 3 - Firebase Status:');
            if (typeof firebase !== 'undefined' && firebase.auth) {
                const firebaseUser = firebase.auth().currentUser;
                console.log('- Firebase user:', firebaseUser ? firebaseUser.email : 'Not authenticated');
                
                if (firebaseUser) {
                    firebase.firestore().collection('users').doc(firebaseUser.uid).get().then(doc => {
                        if (doc.exists) {
                            const fbData = doc.data();
                            console.log('- Firebase subscription:', fbData.subscription);
                            
                            if (fbData.subscription?.status !== currentUser.subscription?.status) {
                                console.log('âš ï¸ Mismatch between Firebase and localStorage! Syncing...');
                                refreshUserSubscriptionStatus();
                            }
                        }
                    }).catch(error => {
                        console.log('âŒ Error accessing Firebase:', error.message);
                    });
                }
            } else {
                console.log('- Firebase not available or not authenticated');
            }
            
            // Step 4: Check DOM elements
            console.log('\nðŸ” Step 4 - DOM Elements:');
            const numbersLinks = document.querySelectorAll('[data-feature="numbers"] a, [data-feature="numbers-submenu"] a');
            const numbersModule = document.querySelector('[data-feature="numbers-module"]');
            console.log('- Numbers links found:', numbersLinks.length);
            console.log('- Numbers module found:', !!numbersModule);
            
            // Step 5: Force fix
            console.log('\nðŸ› ï¸ Step 5 - Applying Fixes:');
            
            if (currentUser.subscription?.status !== 'premium') {
                // Force premium status (for testing - remove in production)
                console.log('ðŸ”§ Setting premium status...');
                currentUser.subscription = {
                    status: 'premium',
                    plan: 'yearly',
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
                    active: true,
                    paymentMethod: 'stripe'
                };
                localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                console.log('âœ… Premium status set in localStorage');
            }
            
            // Update UI
            updateSubscriptionUI('premium');
            updateMenuAccess();
            
            setTimeout(() => {
                const finalStatus = checkNumbersMenuStatus();
                console.log('\nðŸ“Š Final Status:', finalStatus);
                
                if (finalStatus.linksCorrectlyConfigured && isPremiumUser()) {
                    alert('âœ… SUCCESS! Premium access has been restored. You can now access French Numbers in the menu.');
                } else {
                    alert('âŒ STILL HAVING ISSUES. Check the console for detailed logs and contact support.');
                }
            }, 500);
        }

        // Make troubleshooting function available globally
        window.troubleshootPremiumAccess = troubleshootPremiumAccess;

        // Manual function to force guest state (for debugging sign-out issues)
        function forceGuestState() {
            console.log('ðŸ”§ Manually forcing guest state...');
            
            alert('ðŸ”§ Forcing UI reset to guest state. Watch the console for detailed logs.');
            
            // Perform complete reset
            performCompleteUIReset();
            
            // Verify the reset worked
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                const userProfileVisible = document.getElementById('userProfile').style.display !== 'none';
                const signInVisible = document.querySelector('.sign-in-btn').style.display !== 'none';
                
                console.log('ðŸ” Guest state verification:', {
                    userInLocalStorage: !!currentUser,
                    userProfileVisible: userProfileVisible,
                    signInButtonVisible: signInVisible,
                    subscriptionStatus: document.getElementById('subscriptionStatus')?.textContent
                });
                
                if (currentUser || userProfileVisible) {
                    console.error('âŒ Guest state not properly set!');
                    alert('âŒ Guest state reset failed. Please refresh the page manually.');
                } else {
                    console.log('âœ… Guest state successfully verified');
                    alert('âœ… Guest state successfully reset!');
                }
            }, 1000);
        }

        // Make guest state function available globally
        window.forceGuestState = forceGuestState;

        // Emergency sign-out function (for debugging/manual use)
        function emergencySignOut() {
            console.log('ðŸš¨ EMERGENCY SIGN OUT - NUCLEAR OPTION');
            
            // Clear everything possible
            localStorage.clear();
            sessionStorage.clear();
            
            // Firebase sign out
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().signOut().catch(() => {});
            }
            
            // Force UI reset
            performCompleteUIReset();
            
            alert('ðŸš¨ EMERGENCY SIGN OUT COMPLETED!\n\nPage will refresh in 2 seconds to ensure complete reset.');
            
            // Force page refresh after short delay
            setTimeout(() => {
                window.location.reload(true);
            }, 2000);
        }

        // Make emergency function available globally
        window.emergencySignOut = emergencySignOut;

        // Nuclear sign-out option - completely resets everything
        function nuclearSignOut() {
            console.log('â˜¢ï¸ NUCLEAR SIGN-OUT - RESETTING EVERYTHING');
            
            alert('â˜¢ï¸ NUCLEAR SIGN-OUT INITIATED!\n\nThis will completely reset all authentication and refresh the page.\nCheck console for detailed logs.');
            
            try {
                // 1. Disable Firebase persistence
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE).catch(() => {});
                    firebase.auth().signOut().catch(() => {});
                }
                
                // 2. Clear ALL storage
                localStorage.clear();
                sessionStorage.clear();
                
                // 3. Clear any cookies (if any)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // 4. Reset global flags
                window.FORCE_GUEST_MODE = true;
                
                console.log('â˜¢ï¸ All storage cleared, all flags reset');
                
                // 5. Force complete page reload after delay
                setTimeout(() => {
                    console.log('â˜¢ï¸ Forcing page reload...');
                    window.location.href = window.location.origin + window.location.pathname;
                }, 1000);
                
            } catch (error) {
                console.error('â˜¢ï¸ Error during nuclear sign-out:', error);
                // Even if there's an error, force reload
                setTimeout(() => {
                    window.location.reload(true);
                }, 2000);
            }
        }

        // Make nuclear function available globally
        window.nuclearSignOut = nuclearSignOut;

        // Comprehensive sign-out debugging function
        function debugSignOutProcess() {
            console.log('ðŸ” DEBUGGING SIGN-OUT PROCESS');
            console.log('=====================================');
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentUser = localStorage.getItem('french_app_current_user');
            
            console.log('ðŸ“Š Current State:', {
                currentUrl: window.location.href,
                urlParams: Object.fromEntries(urlParams),
                userInLocalStorage: !!currentUser,
                userEmail: currentUser ? JSON.parse(currentUser).email : 'none',
                forceGuestMode: window.FORCE_GUEST_MODE,
                documentReadyState: document.readyState,
                referrer: document.referrer
            });
            
            console.log('ðŸ“Š localStorage contents:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`  - ${key}: ${localStorage.getItem(key)?.substring(0, 100)}...`);
            }
            
            console.log('ðŸ“Š sessionStorage contents:');
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                console.log(`  - ${key}: ${sessionStorage.getItem(key)}`);
            }
            
            console.log('ðŸ“Š UI State:');
            const userProfile = document.getElementById('userProfile');
            const signInBtn = document.querySelector('.sign-in-btn');
            const userName = document.getElementById('userName');
            const subscriptionStatus = document.getElementById('subscriptionStatus');
            
            console.log({
                userProfileVisible: userProfile?.style.display !== 'none',
                signInBtnVisible: signInBtn?.style.display !== 'none',
                userNameText: userName?.textContent,
                subscriptionText: subscriptionStatus?.textContent
            });
            
            alert('ðŸ” Sign-out debugging complete. Check the console for detailed information.');
        }

        // Make debugging function available globally
        window.debugSignOutProcess = debugSignOutProcess;

        // Periodic checker to ensure user stays signed out (runs every 5 seconds for 30 seconds after page load)
        let signOutCheckCount = 0;
        const maxSignOutChecks = 6; // 6 checks over 30 seconds
        
        function periodicSignOutCheck() {
            if (signOutCheckCount >= maxSignOutChecks) return;
            
            signOutCheckCount++;
            console.log(`ðŸ• Periodic sign-out check ${signOutCheckCount}/${maxSignOutChecks}`);
            
            const urlParams = new URLSearchParams(window.location.search);
            const hasSignOutParams = 
                urlParams.get('signedOut') === 'true' || 
                urlParams.get('firebaseSignedOut') === 'true' ||
                urlParams.get('forceGuest') === 'true' ||
                urlParams.get('clearAll') === 'true';
            
            if (hasSignOutParams) {
                const currentUser = localStorage.getItem('french_app_current_user');
                if (currentUser) {
                    console.log('âš ï¸ SIGN-OUT LEAK DETECTED - User data found when should be signed out!');
                    console.log('ðŸ§¹ Performing emergency cleanup...');
                    
                    localStorage.clear();
                    sessionStorage.clear();
                    performCompleteUIReset();
                    
                    if (signOutCheckCount === 1) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            }
            
            // Continue checking
            if (signOutCheckCount < maxSignOutChecks) {
                setTimeout(periodicSignOutCheck, 5000);
            }
        }

        // Start periodic checking after page load
        window.addEventListener('load', function() {
            setTimeout(periodicSignOutCheck, 5000);
        });

        // Make periodic check function available globally for manual use
        window.periodicSignOutCheck = periodicSignOutCheck;

        // Test function to verify numbers page navigation for premium users
        function testNumbersNavigation() {
            console.log('ðŸ§ª Testing Numbers navigation...');
            
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            
            if (!currentUser) {
                alert('âŒ Please sign in first to test navigation');
                return;
            }
            
            if (currentUser.subscription?.status !== 'premium') {
                alert('âŒ User must have premium subscription to test navigation. Current status: ' + (currentUser.subscription?.status || 'unknown'));
                return;
            }
            
            console.log('âœ… Premium user confirmed, testing navigation...');
            
            // Test direct navigation
            const targetUrl = 'French-Numbers.html';
            console.log('ðŸš€ Attempting navigation to:', targetUrl);
            
            try {
                window.location.href = targetUrl;
                console.log('âœ… Navigation command executed successfully');
            } catch (error) {
                console.error('âŒ Navigation failed:', error);
                alert('âŒ Navigation test failed: ' + error.message);
            }
        }

        // Function to check if French-Numbers.html exists
        function checkNumbersPageExists() {
            console.log('ðŸ” Checking if French-Numbers.html exists...');
            
            fetch('French-Numbers.html', { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        console.log('âœ… French-Numbers.html exists and is accessible');
                        alert('âœ… French-Numbers.html file exists and is accessible');
                    } else {
                        console.log('âŒ French-Numbers.html not found or not accessible. Status:', response.status);
                        alert('âŒ French-Numbers.html file not found. Status: ' + response.status);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error checking file:', error);
                    alert('âŒ Error checking file: ' + error.message);
                });
        }

        // Make test functions available globally
        window.testNumbersNavigation = testNumbersNavigation;
        window.checkNumbersPageExists = checkNumbersPageExists;

        // Test function for sign out process
        function testSignOutReset() {
            console.log('ðŸ§ª Testing sign out reset process...');
            
            alert('ðŸ§ª Testing sign out process. Check the console for detailed logs and watch the UI changes.');
            
            // Perform the reset
            performCompleteUIReset();
            
            // Wait a bit then verify
            setTimeout(() => {
                verifySignOutReset();
            }, 1000);
        }

        // Function to manually force UI to guest state (for debugging)
        function forceGuestState() {
            console.log('ðŸ”§ Manually forcing UI to guest state...');
            
            try {
                // Clear localStorage
                localStorage.removeItem('french_app_current_user');
                
                // Reset all UI elements
                performCompleteUIReset();
                
                alert('âœ… UI forced to guest state. Check if the issue is resolved.');
                
            } catch (error) {
                console.error('âŒ Error forcing guest state:', error);
                alert('âŒ Error occurred: ' + error.message);
            }
        }

        // Currency conversion functionality for international users
        const EXCHANGE_RATES = {
            USD_TO_CAD: 1.70, 
            USD_TO_INR: 50.0, // Updated to reflect â‚¹499 monthly pricing
            USD_TO_GBP: 0.79,
            USD_TO_EUR: 0.92,
            USD_TO_JPY: 149.50
        };

        function updateCurrencyDisplay() {
            // Multi-currency display has been removed from the subscription modal
            // This function is now simplified and kept for compatibility
            console.log('ðŸ’± updateCurrencyDisplay called - multi-currency displays removed from UI');
        }

        // Optional: Fetch real-time exchange rates (requires API key)
        async function fetchRealTimeRates() {
            try {
                // You can implement this with a free API like exchangerate-api.com
                // const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                // const data = await response.json();
                // EXCHANGE_RATES.USD_TO_CAD = data.rates.CAD;
                // EXCHANGE_RATES.USD_TO_INR = data.rates.INR;
                // updateCurrencyDisplay();
                
                console.log('ðŸ’± Currency rates updated:', EXCHANGE_RATES);
            } catch (error) {
                console.log('ðŸ’± Using default exchange rates');
            }
        }

        // Country-based currency display functions

        async function getUserCurrency() {
            try {
                // First, try to get country from Firebase Firestore
                const firebaseUser = (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) ? firebase.auth().currentUser : null;
                
                if (firebaseUser && typeof firebase.firestore !== 'undefined') {
                    console.log('ðŸ” Checking Firebase for country data for user:', firebaseUser.uid);
                    
                    try {
                        const doc = await firebase.firestore().collection('users').doc(firebaseUser.uid).get();
                        if (doc.exists) {
                            const userData = doc.data();
                            const firebaseCountry = userData.country;
                            
                            console.log('ðŸŒ Firebase country data:', firebaseCountry);
                            
                            if (firebaseCountry) {
                                // Update localStorage with Firebase data
                                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                                currentUser.country = firebaseCountry;
                                localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                                
                                if (firebaseCountry === 'Canada') {
                                    console.log('ðŸ’° Using CAD currency for Canada (from Firebase)');
                                    return 'CAD';
                                } else if (firebaseCountry === 'India') {
                                    console.log('ðŸ’° Using INR currency for India (from Firebase)');
                                    return 'INR';
                                }
                            }
                        }
                    } catch (firebaseError) {
                        console.log('âš ï¸ Firebase query failed, falling back to localStorage:', firebaseError.message);
                    }
                }
                
                // Fallback to localStorage
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                console.log('ðŸ’° Getting user currency from localStorage for:', currentUser.country);
                
                if (currentUser.country === 'Canada') {
                    return 'CAD';
                } else if (currentUser.country === 'India') {
                    return 'INR';
                }
                
                // Default to USD for other countries or if no country specified
                console.log('ðŸ’° Using USD currency (default/fallback)');
                return 'USD';
                
            } catch (error) {
                console.error('âŒ Error in getUserCurrency:', error);
                return 'USD';
            }
        }

        async function updateSubscriptionPricingForUser() {
            const currency = await getUserCurrency();
            
            console.log('ðŸŽ¯ Updating subscription pricing for currency:', currency);
            
            if (currency === 'CAD') {
                console.log('ðŸ Applying Canadian pricing');
                updatePlanPrices('CAD', 13.47, 36.44, 135);
            } else if (currency === 'INR') {
                console.log('ðŸ‡®ðŸ‡³ Applying Indian pricing');
                updatePlanPrices('INR', 499, 1497, 5988);
            } else {
                // Use default USD pricing for other countries
                console.log('ðŸ‡ºðŸ‡¸ Using default USD pricing');
                updatePlanPrices('USD', 9.99, 26.99, 99.99);
            }
        }

        function updatePlanPrices(currency, monthly, quarterly, yearly) {
            // Update the main price display
            const monthlyPrice = document.querySelector('#monthlyPlan .plan-price');
            const quarterlyPrice = document.querySelector('#quarterlyPlan .plan-price');
            const yearlyPrice = document.querySelector('#yearlyPlan .plan-price');
            
            const symbol = currency === 'CAD' ? '$' : currency === 'INR' ? 'â‚¹' : '$';
            
            console.log('ðŸ’° Updating plan prices to:', currency, { monthly, quarterly, yearly });
            
            if (monthlyPrice) {
                monthlyPrice.innerHTML = `<span class="currency">${symbol}</span>${monthly}<span class="period">/month</span>`;
                console.log('âœ… Updated monthly price');
            } else {
                console.log('âš ï¸ Monthly price element not found');
            }
            
            if (quarterlyPrice) {
                quarterlyPrice.innerHTML = `<span class="currency">${symbol}</span>${quarterly}<span class="period">/3 months</span>`;
                console.log('âœ… Updated quarterly price');
            } else {
                console.log('âš ï¸ Quarterly price element not found');
            }
            
            if (yearlyPrice) {
                yearlyPrice.innerHTML = `<span class="currency">${symbol}</span>${yearly}<span class="period">/year</span>`;
                console.log('âœ… Updated yearly price');
            } else {
                console.log('âš ï¸ Yearly price element not found');
            }
        }

        // Initialize currency display on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in and has country info
            const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
            
            console.log('ðŸš€ Initializing pricing display...');
            console.log('ðŸ‘¤ Current user data:', currentUser);
            
            if (currentUser.country) {
                console.log('ðŸŒ User has country data, updating pricing for:', currentUser.country);
                updateSubscriptionPricingForUser();
            } else {
                console.log('ðŸ‡ºðŸ‡¸ No country data found, using default USD pricing');
                updatePlanPrices('USD', 9.99, 26.99, 99.99);
            }
            // fetchRealTimeRates(); // Uncomment to enable real-time rates
        });

        // Make sign out helper functions available globally for debugging
        window.performCompleteUIReset = performCompleteUIReset;
        window.resetSubscriptionUIToDefault = resetSubscriptionUIToDefault;
        window.resetPremiumBadges = resetPremiumBadges;
        window.clearUserStateCache = clearUserStateCache;
        window.verifySignOutReset = verifySignOutReset;
        window.testSignOutReset = testSignOutReset;
        window.forceGuestState = forceGuestState;
        
        // Debug function to clear user data (for testing)
        function clearUserDataForTesting() {
            console.log('ðŸ§¹ Clearing all user data for testing...');
            
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // Sign out from Firebase
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().signOut().then(() => {
                    console.log('âœ… Firebase signed out');
                    // Reset UI
                    toggleAuthButtons(false);
                    updateCurrencyDisplay();
                    alert('âœ… All user data cleared! You can now test signup fresh.');
                    // Refresh page
                    window.location.reload();
                }).catch((error) => {
                    console.error('Error signing out:', error);
                    alert('âš ï¸ Signed out but there was an error. Page will refresh.');
                    window.location.reload();
                });
            } else {
                // No Firebase, just reset UI
                toggleAuthButtons(false);
                updateCurrencyDisplay();
                alert('âœ… Local data cleared! Page will refresh.');
                window.location.reload();
            }
        }

        // Make currency functions available globally
        window.updateCurrencyDisplay = updateCurrencyDisplay;
        window.fetchRealTimeRates = fetchRealTimeRates;
        window.getUserCurrency = getUserCurrency;
        window.updateSubscriptionPricingForUser = updateSubscriptionPricingForUser;
        window.clearUserDataForTesting = clearUserDataForTesting;

        // Global Firebase error handler to prevent error flashing
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Firebase') || 
                 event.reason.message.includes('auth/') ||
                 event.reason.message.includes('firestore'))) {
                console.warn('ðŸ›¡ï¸ Caught unhandled Firebase error:', event.reason.message);
                event.preventDefault(); // Prevent the error from showing to user
            }
        });
        
        // Enhanced error handling for Firebase operations
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(function(user) {
                // This listener helps catch auth state change errors silently
            }, function(error) {
                console.warn('ðŸ›¡ï¸ Auth state change error caught silently:', error.message);
                // Don't let this error bubble up to user
            });
        }

        // Firebase initialization check for authentication
        let firebaseInitialized = false;
        
        // Check if Firebase is available and initialized
        window.addEventListener('load', function() {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebaseInitialized = true;
                console.log('âœ… Firebase available for authentication');
            } else {
                console.log('âš ï¸ Firebase not available, using localStorage fallback');
            }
        });

        // Debug function to check authentication status
        window.debugAuthStatus = function() {
            console.log('ðŸ” === AUTHENTICATION DEBUG ===');
            console.log('Firebase available:', typeof firebase !== 'undefined' && !!firebase.auth);
            
            if (typeof firebase !== 'undefined' && firebase.auth) {
                console.log('Firebase current user:', firebase.auth().currentUser);
            }
            
            const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
            console.log('LocalStorage current user:', localUser);
            
            const localUsers = JSON.parse(localStorage.getItem('french_app_users') || '[]');
            console.log('LocalStorage all users:', localUsers.length, 'users found');
            localUsers.forEach((user, index) => {
                console.log(`  User ${index + 1}:`, user.email, user.name);
            });
            
            console.log('ðŸ” === END DEBUG ===');
        };
    </script>

    <!-- Stripe.js (Tech-Pay Centralized Payment System) -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Firebase SDK (NOW ENABLED!) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration (embedded from firebase-config.js) -->
    <script>
// Firebase Configuration (v8 compat syntax for HTML)
// âœ… Your real Firebase project config
const firebaseConfig = {
  apiKey: "AIzaSyA12z5FR90bSz1x5Q3ay-uJxV8xNOS_xjk",
  authDomain: "french-learning-app-46d95.firebaseapp.com",
  projectId: "french-learning-app-46d95",
  storageBucket: "french-learning-app-46d95.firebasestorage.app",
  messagingSenderId: "270430812441",
  appId: "1:270430812441:web:3fa199a9131794e90c2d88",
  measurementId: "G-GHZV5LJH4P"
};

// Initialize Firebase (v8 compat syntax)
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Authentication Functions for Firebase
function firebaseSignUp(email, password, name, country) {
    return auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            
            // Update user profile with name
            return user.updateProfile({
                displayName: name
            }).then(() => {
                // Store additional user data in Firestore with subscription info
                return db.collection('users').doc(user.uid).set({
                    email: email,
                    name: name,
                    country: country,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    subscription: {
                        status: 'free',
                        plan: null,
                        startDate: null,
                        endDate: null,
                        active: false,
                        paymentMethod: null
                    },
                    subscriptionHistory: []
                });
            }).then(() => {
                return user;
            });
        });
}

function firebaseSignIn(email, password) {
    return auth.signInWithEmailAndPassword(email, password);
}

function firebaseSignOut() {
    return auth.signOut();
}

// Enhanced Authentication Functions (replace localStorage functions)
function handleFirebaseSignUp(event) {
    event.preventDefault();
    
    const email = document.getElementById('signUpEmail').value;
    const password = document.getElementById('signUpPassword').value;
    const name = document.getElementById('signUpName').value;
    const country = document.getElementById('signUpCountry').value;
    
    // Show loading
    document.getElementById('signUpBtnText').style.display = 'none';
    document.getElementById('signUpSpinner').style.display = 'inline';
    document.getElementById('signUpBtn').disabled = true;
    
    firebaseSignUp(email, password, name, country)
        .then((user) => {
            // Store user data in localStorage for compatibility
            const userData = {
                email: user.email,
                name: user.displayName || name,
                country: country,
                registeredAt: new Date().toISOString(),
                subscription: {
                    status: 'free',
                    plan: null,
                    startDate: null,
                    endDate: null
                }
            };
            localStorage.setItem('french_app_current_user', JSON.stringify(userData));
            
            showSuccess('signUpSuccess', 'Account created successfully! Welcome!');
            
            setTimeout(() => {
                closeModal('signUpModal');
                toggleAuthButtons(true, user.displayName, 'free');
                // Update subscription pricing based on user's country
                if (typeof updateSubscriptionPricingForUser === 'function') {
                    updateSubscriptionPricingForUser();
                }
            }, 1500);
        })
        .catch((error) => {
            let errorMessage = 'An error occurred. Please try again.';
            
            switch(error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'An account with this email already exists.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password is too weak. Please use at least 6 characters.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Please enter a valid email address.';
                    break;
            }
            
            showError('signUpError', errorMessage);
        })
        .finally(() => {
            // Hide loading
            document.getElementById('signUpBtnText').style.display = 'inline';
            document.getElementById('signUpSpinner').style.display = 'none';
            document.getElementById('signUpBtn').disabled = false;
        });
}

function handleFirebaseSignIn(event) {
    event.preventDefault();
    
    const email = document.getElementById('signInEmail').value;
    const password = document.getElementById('signInPassword').value;
    
    // Show loading
    document.getElementById('signInBtnText').style.display = 'none';
    document.getElementById('signInSpinner').style.display = 'inline';
    document.getElementById('signInBtn').disabled = true;
    
            firebaseSignIn(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            
            // Get user subscription status from Firestore
            return db.collection('users').doc(user.uid).get().then(async (doc) => {
                // Use the centralized subscription status function for consistency
                const subscriptionStatus = await getUserSubscriptionStatus(user.uid);
                
                let userData = {
                    email: user.email,
                    name: user.displayName || user.email,
                    country: null, // Default to null, will be set from Firestore if available
                    registeredAt: new Date().toISOString(),
                    subscription: {
                        status: subscriptionStatus, // Use validated status
                        plan: null,
                        startDate: null,
                        endDate: null
                    }
                };
                
                if (doc.exists) {
                    const firestoreData = doc.data();
                    // Use the validated subscription status, but get other subscription details from Firestore
                    userData.subscription = {
                        status: subscriptionStatus, // Use the validated status from getUserSubscriptionStatus
                        plan: firestoreData.subscription?.plan || null,
                        startDate: firestoreData.subscription?.startDate || null,
                        endDate: firestoreData.subscription?.endDate || null,
                        active: firestoreData.subscription?.active || false,
                        paymentMethod: firestoreData.subscription?.paymentMethod || null
                    };
                    userData.name = firestoreData.name || userData.name;
                    userData.country = firestoreData.country || null; // Retrieve country from Firestore
                    userData.registeredAt = firestoreData.createdAt ? firestoreData.createdAt.toDate().toISOString() : userData.registeredAt;
                }
                
                // Store user data in localStorage for compatibility
                localStorage.setItem('french_app_current_user', JSON.stringify(userData));
                
                showSuccess('signInSuccess', 'Successfully signed in! Welcome back!');
                
                setTimeout(() => {
                    closeModal('signInModal');
                    toggleAuthButtons(true, user.displayName || user.email, subscriptionStatus);
                    // Update subscription pricing based on user's country from Firebase
                    if (typeof updateSubscriptionPricingForUser === 'function') {
                        updateSubscriptionPricingForUser();
                    }
                }, 1500);
            });
        })
        .catch((error) => {
            let errorMessage = 'An error occurred. Please try again.';
            
            switch(error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = 'Invalid email or password. Please try again.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Please enter a valid email address.';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Too many failed attempts. Please try again later.';
                    break;
            }
            
            showError('signInError', errorMessage);
        })
        .finally(() => {
            // Hide loading
            document.getElementById('signInBtnText').style.display = 'inline';
            document.getElementById('signInSpinner').style.display = 'none';
            document.getElementById('signInBtn').disabled = false;
        });
}

function handleFirebaseSignOut() {
    firebaseSignOut()
        .then(() => {
            toggleAuthButtons(false);
            showSuccess('signInSuccess', 'Successfully signed out!');
            setTimeout(() => {
                clearMessages();
            }, 2000);
        })
        .catch((error) => {
            console.error('Sign out error:', error);
        });
}

// Subscription Management Functions
async function updateUserSubscriptionFirebase(userId, subscriptionData) {
    try {
        await db.collection('users').doc(userId).update({
            subscription: subscriptionData,
            subscriptionHistory: firebase.firestore.FieldValue.arrayUnion({
                ...subscriptionData,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
        });
        console.log('Subscription updated successfully');
        return { success: true };
    } catch (error) {
        console.error('Error updating subscription:', error);
        throw error;
    }
}

async function getUserSubscriptionStatus(userId) {
    try {
        console.log('ðŸ” getUserSubscriptionStatus called for userId:', userId);
        const doc = await db.collection('users').doc(userId).get();
        
        if (doc.exists) {
            const userData = doc.data();
            console.log('ðŸ“„ User document exists, data:', userData);
            const subscription = userData.subscription || { status: 'free' };
            console.log('ðŸ“‹ Subscription data:', subscription);
            
            // Check if subscription is expired
            if (subscription.status === 'premium' && subscription.endDate) {
                const endDate = subscription.endDate.toDate ? subscription.endDate.toDate() : new Date(subscription.endDate);
                console.log('ðŸ“… Checking expiration - endDate:', endDate, 'now:', new Date());
                if (endDate < new Date()) {
                    console.log('â° Subscription expired, updating to expired status');
                    // Update status to expired
                    await db.collection('users').doc(userId).update({
                        'subscription.status': 'expired',
                        'subscription.active': false
                    });
                    return 'expired';
                }
            }
            
            const finalStatus = subscription.status || 'free';
            console.log('âœ… Final subscription status determined:', finalStatus);
            return finalStatus;
        }
        
        console.log('ðŸ“„ User document does not exist, returning free status');
        return 'free';
    } catch (error) {
        console.error('âŒ Error getting subscription status:', error);
        return 'free';
    }
}

async function cancelUserSubscription(userId) {
    try {
        const subscriptionData = {
            status: 'cancelled',
            active: false,
            cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('users').doc(userId).update({
            'subscription.status': 'cancelled',
            'subscription.active': false,
            'subscription.cancelledAt': firebase.firestore.FieldValue.serverTimestamp(),
            subscriptionHistory: firebase.firestore.FieldValue.arrayUnion({
                action: 'cancellation',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
        });
        
        console.log('Subscription cancelled successfully');
        return { success: true };
    } catch (error) {
        console.error('Error cancelling subscription:', error);
        throw error;
    }
}

async function reactivateUserSubscription(userId, plan = 'monthly') {
    try {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + (plan === 'monthly' ? 30 : 365));
        
        const subscriptionData = {
            status: 'premium',
            plan: plan,
            active: true,
            startDate: firebase.firestore.FieldValue.serverTimestamp(),
            endDate: endDate,
            reactivatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('users').doc(userId).update({
            subscription: subscriptionData,
            subscriptionHistory: firebase.firestore.FieldValue.arrayUnion({
                action: 'reactivation',
                plan: plan,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
        });
        
        console.log('Subscription reactivated successfully');
        return { success: true };
    } catch (error) {
        console.error('Error reactivating subscription:', error);
        throw error;
    }
}

// Admin Functions for Subscription Management
async function getAllSubscriptions() {
    try {
        const querySnapshot = await db.collection('users').get();
        const subscriptions = [];
        
        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            subscriptions.push({
                userId: doc.id,
                email: userData.email,
                name: userData.name,
                subscription: userData.subscription || { status: 'free' },
                createdAt: userData.createdAt
            });
        });
        
        return subscriptions;
    } catch (error) {
        console.error('Error getting subscriptions:', error);
        throw error;
    }
}

// Add this new function to manually refresh subscription status
async function refreshUserSubscriptionStatus() {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        console.log('âŒ No user signed in');
        return;
    }
    
    try {
        console.log('ðŸ”„ Refreshing subscription status from Firebase...');
        
        // Get fresh data from Firebase
        const subscriptionStatus = await getUserSubscriptionStatus(currentUser.uid);
        const doc = await db.collection('users').doc(currentUser.uid).get();
        
        if (doc.exists) {
            const firestoreData = doc.data();
            
            // Update localStorage with fresh Firebase data
            let userData = {
                email: currentUser.email,
                name: currentUser.displayName || currentUser.email,
                registeredAt: firestoreData.createdAt ? firestoreData.createdAt.toDate().toISOString() : new Date().toISOString(),
                subscription: firestoreData.subscription || { status: 'free', plan: null, startDate: null, endDate: null }
            };
            
            localStorage.setItem('french_app_current_user', JSON.stringify(userData));
            
            // Update UI
            toggleAuthButtons(true, currentUser.displayName || currentUser.email, subscriptionStatus);
            
            console.log('âœ… Subscription status refreshed successfully!');
            console.log('ðŸ“Š Updated subscription status:', subscriptionStatus);
            console.log('ðŸ’¾ Updated localStorage:', userData.subscription);
            
            return subscriptionStatus;
        }
    } catch (error) {
        console.error('âŒ Error refreshing subscription status:', error);
        throw error;
    }
}

// Helper function to fix subscription data format issues
async function fixUserSubscriptionData(userId, correctStatus = 'free') {
    try {
        console.log('ðŸ”§ Fixing subscription data format...');
        
        const doc = await db.collection('users').doc(userId).get();
        if (doc.exists) {
            const userData = doc.data();
            const currentSubscription = userData.subscription || {};
            
            // Fix common data format issues
            const fixedSubscription = {
                status: typeof correctStatus === 'string' ? correctStatus : 'free',
                plan: currentSubscription.plan || null,
                startDate: currentSubscription.startDate || null,
                endDate: currentSubscription.endDate || null,
                active: correctStatus === 'premium' ? true : false,
                paymentMethod: currentSubscription.paymentMethod || null
            };
            
            // Update Firebase with correct format
            await db.collection('users').doc(userId).update({
                subscription: fixedSubscription
            });
            
            console.log('âœ… Subscription data format fixed!');
            console.log('ðŸ“Š Fixed subscription:', fixedSubscription);
            
            return fixedSubscription;
        }
    } catch (error) {
        console.error('âŒ Error fixing subscription data:', error);
        throw error;
    }
}

// Function to properly revoke premium access
async function revokePremiumAccess(userId, reason = 'manual_revocation') {
    try {
        console.log('ðŸš« Revoking premium access for user:', userId);
        
        const doc = await db.collection('users').doc(userId).get();
        if (doc.exists) {
            const userData = doc.data();
            const currentSubscription = userData.subscription || {};
            
            // Properly revoke premium access
            const revokedSubscription = {
                ...currentSubscription,
                status: 'free',          // â† This is what actually matters for access control
                active: false,           // â† This is just metadata
                revokedAt: firebase.firestore.FieldValue.serverTimestamp(),
                revokedReason: reason
            };
            
            // Update Firebase
            await db.collection('users').doc(userId).update({
                subscription: revokedSubscription,
                subscriptionHistory: firebase.firestore.FieldValue.arrayUnion({
                    action: 'revocation',
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    previousStatus: currentSubscription.status
                })
            });
            
            console.log('âœ… Premium access revoked successfully!');
            console.log('ðŸ“Š Revoked subscription:', revokedSubscription);
            
            return revokedSubscription;
        } else {
            throw new Error('User not found');
        }
    } catch (error) {
        console.error('âŒ Error revoking premium access:', error);
        throw error;
    }
}

// Function to find users with inconsistent subscription data
async function findInconsistentSubscriptions() {
    try {
        console.log('ðŸ” Finding users with inconsistent subscription data...');
        
        const querySnapshot = await db.collection('users').get();
        const inconsistentUsers = [];
        
        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const subscription = userData.subscription;
            
            if (subscription) {
                // Check for inconsistencies
                const hasActiveIssue = (subscription.status === 'premium' && subscription.active === false) ||
                                     (subscription.status !== 'premium' && subscription.active === true);
                
                if (hasActiveIssue) {
                    inconsistentUsers.push({
                        userId: doc.id,
                        email: userData.email,
                        name: userData.name,
                        subscription: subscription,
                        issue: subscription.status === 'premium' && subscription.active === false 
                               ? 'Premium status but active=false' 
                               : 'Non-premium status but active=true'
                    });
                }
            }
        });
        
        console.log('ðŸš¨ Found', inconsistentUsers.length, 'users with inconsistent subscription data:');
        console.table(inconsistentUsers);
        
        return inconsistentUsers;
    } catch (error) {
        console.error('âŒ Error finding inconsistent subscriptions:', error);
        throw error;
    }
}

async function getSubscriptionStats() {
    try {
        const subscriptions = await getAllSubscriptions();
        
        const stats = {
            total: subscriptions.length,
            free: subscriptions.filter(s => s.subscription.status === 'free').length,
            premium: subscriptions.filter(s => s.subscription.status === 'premium').length,
            expired: subscriptions.filter(s => s.subscription.status === 'expired').length,
            cancelled: subscriptions.filter(s => s.subscription.status === 'cancelled').length,
            monthly: subscriptions.filter(s => s.subscription.plan === 'monthly').length,
            yearly: subscriptions.filter(s => s.subscription.plan === 'yearly').length
        };
        
        console.log('Subscription Statistics:', stats);
        return stats;
    } catch (error) {
        console.error('Error getting subscription stats:', error);
        throw error;
    }
}

// Listen for authentication state changes
auth.onAuthStateChanged(async (user) => {
    console.log('ðŸ”„ Firebase onAuthStateChanged triggered:', {
        hasUser: !!user,
        userEmail: user?.email,
        currentUrl: window.location.href,
        forceGuestMode: window.FORCE_GUEST_MODE
    });

    // CRITICAL: Check for sign-out flags before doing anything
    const urlParams = new URLSearchParams(window.location.search);
    const sessionFlags = {
        signedOut: urlParams.get('signedOut') === 'true' || urlParams.get('firebaseSignedOut') === 'true',
        forceGuest: urlParams.get('forceGuest') === 'true',
        justSignedOut: sessionStorage.getItem('just_signed_out') === 'true',
        firebaseSignedOut: sessionStorage.getItem('firebase_signed_out') === 'true',
        forceGuestState: sessionStorage.getItem('force_guest_state') === 'true'
    };

    const isSignOutProcess = Object.values(sessionFlags).some(flag => flag) || window.FORCE_GUEST_MODE;

    console.log('ðŸ” Sign-out flags check:', sessionFlags, 'isSignOutProcess:', isSignOutProcess);

    if (isSignOutProcess) {
        console.log('ðŸš« SIGN-OUT PROCESS DETECTED - onAuthStateChanged will NOT restore localStorage');
        
        // If there's still a Firebase user during sign-out process, sign them out
        if (user) {
            console.log('âš ï¸ Firebase user still exists during sign-out process, force signing out...');
            auth.signOut().catch(error => {
                console.log('Firebase sign-out error in onAuthStateChanged (ignored):', error);
            });
        }
        
        // Ensure localStorage is cleared and UI is in guest state
        localStorage.removeItem('french_app_current_user');
        if (typeof toggleAuthButtons === 'function') {
            toggleAuthButtons(false);
        }
        return; // STOP HERE - do not restore localStorage
    }

    if (user) {
        console.log('âœ… Valid user sign-in detected - syncing localStorage...');
        // User is signed in - get their subscription status and sync localStorage
        try {
            const subscriptionStatus = await getUserSubscriptionStatus(user.uid);
            
            // Ensure localStorage is synced with Firebase user data
            const doc = await db.collection('users').doc(user.uid).get();
            let userData = {
                email: user.email,
                name: user.displayName || user.email,
                country: null, // Default to null, will be set from Firestore if available
                registeredAt: new Date().toISOString(),
                subscription: {
                    status: subscriptionStatus,
                    plan: null,
                    startDate: null,
                    endDate: null
                }
            };
            
            if (doc.exists) {
                const firestoreData = doc.data();
                // Use the subscription status determined by getUserSubscriptionStatus, not raw Firestore data
                // This ensures proper expiration checking and status validation
                userData.subscription = {
                    status: subscriptionStatus, // Use the validated status from getUserSubscriptionStatus
                    plan: firestoreData.subscription?.plan || null,
                    startDate: firestoreData.subscription?.startDate || null,
                    endDate: firestoreData.subscription?.endDate || null,
                    active: firestoreData.subscription?.active || false,
                    paymentMethod: firestoreData.subscription?.paymentMethod || null
                };
                userData.name = firestoreData.name || userData.name;
                userData.country = firestoreData.country || null; // Retrieve country from Firestore
                userData.registeredAt = firestoreData.createdAt ? firestoreData.createdAt.toDate().toISOString() : userData.registeredAt;
            }
            
            localStorage.setItem('french_app_current_user', JSON.stringify(userData));
            if (typeof toggleAuthButtons === 'function') {
                toggleAuthButtons(true, user.displayName || user.email, userData.subscription.status);
            }
            
            // Update subscription pricing based on user's country from Firebase
            if (typeof updateSubscriptionPricingForUser === 'function') {
                updateSubscriptionPricingForUser();
            }
            
            console.log('âœ… localStorage synced for authenticated user');
        } catch (error) {
            console.error('Error getting user subscription:', error);
            // Still create basic localStorage entry
            const userData = {
                email: user.email,
                name: user.displayName || user.email,
                country: null, // No country data available in error case
                registeredAt: new Date().toISOString(),
                subscription: { status: 'free', plan: null, startDate: null, endDate: null }
            };
            localStorage.setItem('french_app_current_user', JSON.stringify(userData));
            if (typeof toggleAuthButtons === 'function') {
                toggleAuthButtons(true, user.displayName || user.email, 'free');
            }
        }
    } else {
        console.log('ðŸš« No Firebase user - clearing localStorage and setting guest state');
        // User is signed out - clear localStorage
        localStorage.removeItem('french_app_current_user');
        if (typeof toggleAuthButtons === 'function') {
            toggleAuthButtons(false);
        }
    }
});

// SECURITY FIX: Removed auto-fix function that granted unauthorized premium access
// This function was bypassing payment validation and should not exist
function autoFixNumbersAccess() {
    console.log('ðŸ”’ Auto-fix function disabled for security - use proper payment verification');
    // No automatic premium access granted
}

// Replace the localStorage-based functions when Firebase is enabled
function enableFirebaseAuth() {
    // Update event listeners to use Firebase functions
    document.getElementById('signUpForm').removeEventListener('submit', handleSignUp);
    document.getElementById('signInForm').removeEventListener('submit', handleSignIn);
    
    document.getElementById('signUpForm').addEventListener('submit', handleFirebaseSignUp);
    document.getElementById('signInForm').addEventListener('submit', handleFirebaseSignIn);
    
    // Update sign out function
    window.signOut = handleFirebaseSignOut;
    
    // Add subscription management functions to global scope
    // Note: updateUserSubscription is defined in index.html for payment processing
    window.getUserSubscriptionStatus = getUserSubscriptionStatus;
    window.cancelUserSubscription = cancelUserSubscription;
    window.reactivateUserSubscription = reactivateUserSubscription;
    window.getAllSubscriptions = getAllSubscriptions;
    window.getSubscriptionStats = getSubscriptionStats;
    window.refreshUserSubscriptionStatus = refreshUserSubscriptionStatus;
    window.fixUserSubscriptionData = fixUserSubscriptionData;
    window.revokePremiumAccess = revokePremiumAccess;
    window.findInconsistentSubscriptions = findInconsistentSubscriptions;
    // SECURITY FIX: Removed global auto-fix function assignment
}

// Automatically enable Firebase auth if Firebase is loaded
if (typeof firebase !== 'undefined') {
    enableFirebaseAuth();
}
    </script>
    
    <!-- Database Admin Functions (embedded from database-admin.js) -->
    <script>
// Database Admin Functions
// Add these functions to access user data programmatically

// Function to get all users from localStorage (demo mode)
function getAllUsersLocal() {
    const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
    console.table(users);
    return users;
}

// Function to get current user from localStorage
function getCurrentUserLocal() {
    const user = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
    console.log('Current User:', user);
    return user;
}

// Function to export users data as CSV (localStorage)
function exportUsersCSV() {
    const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
    
    if (users.length === 0) {
        console.log('No users found');
        return;
    }
    
    // Create CSV content
    const headers = ['Name', 'Email', 'Registration Date', 'Subscription Status', 'Plan', 'Start Date', 'End Date'];
    const csvContent = [
        headers.join(','),
        ...users.map(user => [
            `"${user.name}"`,
            `"${user.email}"`,
            `"${user.registeredAt || 'N/A'}"`,
            `"${user.subscription?.status || 'free'}"`,
            `"${user.subscription?.plan || 'N/A'}"`,
            `"${user.subscription?.startDate || 'N/A'}"`,
            `"${user.subscription?.endDate || 'N/A'}"`
        ].join(','))
    ].join('\n');
    
    // Download CSV file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'french-app-users-with-subscriptions.csv';
    link.click();
    window.URL.revokeObjectURL(url);
}

// Firebase functions (when using cloud database)
function getAllUsersFirebase() {
    if (typeof firebase === 'undefined') {
        console.log('Firebase not loaded. Using localStorage instead.');
        return getAllUsersLocal();
    }
    
    // Get all users from Firestore
    firebase.firestore().collection('users').get()
        .then((querySnapshot) => {
            const users = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                users.push({
                    id: doc.id,
                    email: data.email,
                    name: data.name,
                    createdAt: data.createdAt,
                    subscription: data.subscription || { status: 'free' }
                });
            });
            console.table(users);
            return users;
        })
        .catch((error) => {
            console.error('Error getting users:', error);
        });
}

// Function to search users by email
function findUserByEmail(email) {
    if (typeof firebase !== 'undefined') {
        // Firebase version
        firebase.firestore().collection('users')
            .where('email', '==', email)
            .get()
            .then((querySnapshot) => {
                if (querySnapshot.empty) {
                    console.log('No user found with email:', email);
                    return null;
                }
                querySnapshot.forEach((doc) => {
                    console.log('User found:', doc.data());
                });
            });
    } else {
        // localStorage version
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        const user = users.find(u => u.email === email);
        if (user) {
            console.log('User found:', user);
        } else {
            console.log('No user found with email:', email);
        }
        return user;
    }
}

// Function to get user statistics
function getUserStats() {
    if (typeof firebase !== 'undefined') {
        // Firebase version
        firebase.firestore().collection('users').get()
            .then((querySnapshot) => {
                const total = querySnapshot.size;
                const today = new Date().toDateString();
                let todaySignups = 0;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.createdAt && data.createdAt.toDate().toDateString() === today) {
                        todaySignups++;
                    }
                });
                
                console.log(`Total Users: ${total}`);
                console.log(`New Signups Today: ${todaySignups}`);
            });
    } else {
        // localStorage version
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        const today = new Date().toDateString();
        const todaySignups = users.filter(user => 
            user.registeredAt && new Date(user.registeredAt).toDateString() === today
        ).length;
        
        console.log(`Total Users: ${users.length}`);
        console.log(`New Signups Today: ${todaySignups}`);
    }
}

// ============== SUBSCRIPTION MANAGEMENT FUNCTIONS ==============

// Get comprehensive subscription statistics
async function getSubscriptionStats() {
    if (typeof firebase !== 'undefined') {
        try {
            const stats = await firebase.functions().httpsCallable('getSubscriptionStats')();
            console.log('ðŸ“Š Subscription Statistics:');
            console.table(stats.data);
            return stats.data;
        } catch (error) {
            // Fallback to manual calculation
            console.log('Using manual stats calculation...');
            const subscriptions = await getAllSubscriptions();
            
            const stats = {
                total: subscriptions.length,
                free: subscriptions.filter(s => s.subscription.status === 'free').length,
                premium: subscriptions.filter(s => s.subscription.status === 'premium').length,
                expired: subscriptions.filter(s => s.subscription.status === 'expired').length,
                cancelled: subscriptions.filter(s => s.subscription.status === 'cancelled').length,
                monthly: subscriptions.filter(s => s.subscription.plan === 'monthly').length,
                yearly: subscriptions.filter(s => s.subscription.plan === 'yearly').length,
                revenue: {
                    monthly: subscriptions.filter(s => s.subscription.plan === 'monthly' && s.subscription.status === 'premium').length * 9.99,
                    yearly: subscriptions.filter(s => s.subscription.plan === 'yearly' && s.subscription.status === 'premium').length * 99.99
                }
            };
            
            console.log('ðŸ“Š Subscription Statistics:');
            console.table(stats);
            return stats;
        }
    } else {
        // localStorage version
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        const stats = {
            total: users.length,
            free: users.filter(u => !u.subscription || u.subscription.status === 'free').length,
            premium: users.filter(u => u.subscription?.status === 'premium').length,
            expired: users.filter(u => u.subscription?.status === 'expired').length,
            cancelled: users.filter(u => u.subscription?.status === 'cancelled').length,
            monthly: users.filter(u => u.subscription?.plan === 'monthly').length,
            yearly: users.filter(u => u.subscription?.plan === 'yearly').length
        };
        
        console.log('ðŸ“Š Subscription Statistics (localStorage):');
        console.table(stats);
        return stats;
    }
}

// Get all subscriptions with detailed information
async function getAllSubscriptions() {
    if (typeof firebase !== 'undefined') {
        try {
            const querySnapshot = await firebase.firestore().collection('users').get();
            const subscriptions = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                subscriptions.push({
                    userId: doc.id,
                    email: data.email,
                    name: data.name,
                    subscription: data.subscription || { status: 'free' },
                    subscriptionHistory: data.subscriptionHistory || [],
                    createdAt: data.createdAt
                });
            });
            
            console.log('ðŸ’³ All Subscriptions:');
            console.table(subscriptions.map(s => ({
                email: s.email,
                name: s.name,
                status: s.subscription.status,
                plan: s.subscription.plan,
                startDate: s.subscription.startDate,
                endDate: s.subscription.endDate,
                active: s.subscription.active
            })));
            
            return subscriptions;
        } catch (error) {
            console.error('Error getting subscriptions:', error);
            return [];
        }
    } else {
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        console.log('ðŸ’³ All Subscriptions (localStorage):');
        console.table(users.map(u => ({
            email: u.email,
            name: u.name,
            status: u.subscription?.status || 'free',
            plan: u.subscription?.plan || 'N/A'
        })));
        return users;
    }
}

// Get premium subscribers only
async function getPremiumSubscribers() {
    if (typeof firebase !== 'undefined') {
        try {
            const querySnapshot = await firebase.firestore().collection('users')
                .where('subscription.status', '==', 'premium')
                .get();
            
            const premiumUsers = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                premiumUsers.push({
                    userId: doc.id,
                    email: data.email,
                    name: data.name,
                    subscription: data.subscription,
                    createdAt: data.createdAt
                });
            });
            
            console.log('â­ Premium Subscribers:');
            console.table(premiumUsers);
            return premiumUsers;
        } catch (error) {
            console.error('Error getting premium subscribers:', error);
            return [];
        }
    } else {
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        const premiumUsers = users.filter(u => u.subscription?.status === 'premium');
        console.log('â­ Premium Subscribers (localStorage):');
        console.table(premiumUsers);
        return premiumUsers;
    }
}

// Get expired subscriptions
async function getExpiredSubscriptions() {
    if (typeof firebase !== 'undefined') {
        try {
            const querySnapshot = await firebase.firestore().collection('users').get();
            const expiredUsers = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const subscription = data.subscription;
                
                if (subscription && subscription.endDate) {
                    const endDate = subscription.endDate.toDate ? subscription.endDate.toDate() : new Date(subscription.endDate);
                    if (endDate < new Date() && subscription.status !== 'expired') {
                        expiredUsers.push({
                            userId: doc.id,
                            email: data.email,
                            name: data.name,
                            subscription: subscription,
                            expiredDays: Math.floor((new Date() - endDate) / (1000 * 60 * 60 * 24))
                        });
                    }
                }
            });
            
            console.log('â° Expired Subscriptions:');
            console.table(expiredUsers);
            return expiredUsers;
        } catch (error) {
            console.error('Error getting expired subscriptions:', error);
            return [];
        }
    } else {
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        const expiredUsers = users.filter(u => {
            if (u.subscription && u.subscription.endDate) {
                const endDate = new Date(u.subscription.endDate);
                return endDate < new Date();
            }
            return false;
        });
        
        console.log('â° Expired Subscriptions (localStorage):');
        console.table(expiredUsers);
        return expiredUsers;
    }
}

// Admin function to update user subscription manually
async function updateUserSubscriptionAdmin(userEmail, subscriptionData) {
    if (typeof firebase !== 'undefined') {
        try {
            const querySnapshot = await firebase.firestore().collection('users')
                .where('email', '==', userEmail)
                .get();
            
            if (querySnapshot.empty) {
                console.error('User not found:', userEmail);
                return { success: false, error: 'User not found' };
            }
            
            const userDoc = querySnapshot.docs[0];
            await userDoc.ref.update({
                subscription: subscriptionData,
                subscriptionHistory: firebase.firestore.FieldValue.arrayUnion({
                    ...subscriptionData,
                    updatedBy: 'admin',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            });
            
            console.log(`âœ… Subscription updated for ${userEmail}:`, subscriptionData);
            return { success: true };
        } catch (error) {
            console.error('Error updating subscription:', error);
            return { success: false, error: error.message };
        }
    } else {
        // localStorage version
        const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
        const userIndex = users.findIndex(u => u.email === userEmail);
        
        if (userIndex === -1) {
            console.error('User not found:', userEmail);
            return { success: false, error: 'User not found' };
        }
        
        users[userIndex].subscription = subscriptionData;
        localStorage.setItem('french_app_users', JSON.stringify(users));
        
        // Update current user if it's the same user
        const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
        if (currentUser && currentUser.email === userEmail) {
            currentUser.subscription = subscriptionData;
            localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
        }
        
        console.log(`âœ… Subscription updated for ${userEmail}:`, subscriptionData);
        return { success: true };
    }
}

// Cancel user subscription
async function cancelUserSubscription(userEmail) {
    const subscriptionData = {
        status: 'cancelled',
        active: false,
        cancelledAt: new Date().toISOString()
    };
    
    return await updateUserSubscriptionAdmin(userEmail, subscriptionData);
}

// Reactivate user subscription
async function reactivateUserSubscription(userEmail, plan = 'monthly') {
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + (plan === 'monthly' ? 30 : 365));
    
    const subscriptionData = {
        status: 'premium',
        plan: plan,
        active: true,
        startDate: new Date().toISOString(),
        endDate: endDate.toISOString(),
        reactivatedAt: new Date().toISOString()
    };
    
    return await updateUserSubscriptionAdmin(userEmail, subscriptionData);
}

// Export subscription data as CSV
async function exportSubscriptionsCSV() {
    try {
        const subscriptions = await getAllSubscriptions();
        
        if (subscriptions.length === 0) {
            console.log('No subscriptions found');
            return;
        }
        
        const headers = ['Name', 'Email', 'Status', 'Plan', 'Start Date', 'End Date', 'Active', 'Created At'];
        const csvContent = [
            headers.join(','),
            ...subscriptions.map(sub => [
                `"${sub.name || 'N/A'}"`,
                `"${sub.email}"`,
                `"${sub.subscription.status || 'free'}"`,
                `"${sub.subscription.plan || 'N/A'}"`,
                `"${sub.subscription.startDate || 'N/A'}"`,
                `"${sub.subscription.endDate || 'N/A'}"`,
                `"${sub.subscription.active || false}"`,
                `"${sub.createdAt || 'N/A'}"`
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'french-app-subscriptions.csv';
        link.click();
        window.URL.revokeObjectURL(url);
        
        console.log('âœ… Subscriptions exported to CSV');
    } catch (error) {
        console.error('Error exporting subscriptions:', error);
    }
}

// Admin panel functions
function showAdminPanel() {
    console.log(`
ðŸ”§ ADMIN PANEL - User Database & Subscription Management
========================================================

ðŸ‘¥ USER MANAGEMENT:
- getAllUsersLocal()     â†’ View all users (localStorage)
- getCurrentUserLocal()  â†’ View current user
- getAllUsersFirebase()  â†’ View all users (Firebase)
- findUserByEmail('user@example.com') â†’ Search user
- getUserStats()         â†’ Show user statistics
- exportUsersCSV()       â†’ Download users as CSV

ðŸ’³ SUBSCRIPTION MANAGEMENT:
- getSubscriptionStats() â†’ View subscription statistics
- getAllSubscriptions()  â†’ View all subscriptions
- getPremiumSubscribers() â†’ View premium subscribers only
- getExpiredSubscriptions() â†’ View expired subscriptions
- exportSubscriptionsCSV() â†’ Export subscriptions to CSV

ðŸ› ï¸  ADMIN ACTIONS:
- updateUserSubscriptionAdmin('user@email.com', {status: 'premium', plan: 'monthly'})
- cancelUserSubscription('user@email.com')
- reactivateUserSubscription('user@email.com', 'monthly')

ðŸ“Š QUICK STATS:
Run getSubscriptionStats() for detailed subscription metrics

ðŸ”¥ FIREBASE CONSOLE:
â†’ https://console.firebase.google.com/project/french-learning-app-46d95

Current Status: ${typeof firebase !== 'undefined' ? 'Firebase Enabled' : 'Demo Mode (localStorage)'}
    `);
}

// Revenue calculation function
async function calculateRevenue() {
    try {
        const subscriptions = await getAllSubscriptions();
        
        const revenue = {
            monthly: {
                subscribers: subscriptions.filter(s => s.subscription.plan === 'monthly' && s.subscription.status === 'premium').length,
                amount: 0
            },
            yearly: {
                subscribers: subscriptions.filter(s => s.subscription.plan === 'yearly' && s.subscription.status === 'premium').length,
                amount: 0
            },
            total: 0
        };
        
        revenue.monthly.amount = revenue.monthly.subscribers * 9.99;
        revenue.yearly.amount = revenue.yearly.subscribers * 99.99;
        revenue.total = revenue.monthly.amount + revenue.yearly.amount;
        
        console.log('ðŸ’° Revenue Analysis:');
        console.table({
            'Monthly Subscriptions': `${revenue.monthly.subscribers} users Ã— $9.99 = $${revenue.monthly.amount.toFixed(2)}`,
            'Yearly Subscriptions': `${revenue.yearly.subscribers} users Ã— $99.99 = $${revenue.yearly.amount.toFixed(2)}`,
            'Total Monthly Revenue': `$${revenue.total.toFixed(2)}`
        });
        
        return revenue;
    } catch (error) {
        console.error('Error calculating revenue:', error);
        return null;
    }
}

// Automatically show admin panel when this script loads
showAdminPanel();
    </script>
    
    <!-- Payment Tracking Admin Functions (embedded from payment-tracking-admin.js) -->
    <script>
// Payment Tracking Admin Functions
// Add these to check subscription amounts and payment data

// Function to check specific user's payment details
async function getUserPaymentDetails(userEmail) {
    try {
        if (typeof firebase !== 'undefined') {
            const querySnapshot = await firebase.firestore().collection('users')
                .where('email', '==', userEmail)
                .get();
            
            if (!querySnapshot.empty) {
                const userData = querySnapshot.docs[0].data();
                const subscription = userData.subscription || {};
                
                // Calculate payment amount based on plan
                let amount = 0;
                if (subscription.plan === 'monthly') amount = 9.99;
                if (subscription.plan === 'yearly') amount = 99.99;
                
                const paymentInfo = {
                    email: userData.email,
                    name: userData.name,
                    subscriptionStatus: subscription.status || 'free',
                    plan: subscription.plan || 'none',
                    startDate: subscription.startDate,
                    endDate: subscription.endDate,
                    estimatedAmount: amount,
                    currency: 'USD',
                    paymentMethod: subscription.paymentMethod || 'none'
                };
                
                console.log('ðŸ’³ Payment Details for', userEmail);
                console.table(paymentInfo);
                return paymentInfo;
            } else {
                console.log('âŒ User not found:', userEmail);
                return null;
            }
        } else {
            // localStorage fallback
            const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
            const user = users.find(u => u.email === userEmail);
            
            if (user) {
                let amount = 0;
                if (user.subscription?.plan === 'monthly') amount = 9.99;
                if (user.subscription?.plan === 'yearly') amount = 99.99;
                
                const paymentInfo = {
                    email: user.email,
                    name: user.name,
                    subscriptionStatus: user.subscription?.status || 'free',
                    plan: user.subscription?.plan || 'none',
                    estimatedAmount: amount,
                    currency: 'USD'
                };
                
                console.log('ðŸ’³ Payment Details for', userEmail);
                console.table(paymentInfo);
                return paymentInfo;
            }
        }
    } catch (error) {
        console.error('Error getting payment details:', error);
        return null;
    }
}

// Function to calculate total revenue from all subscriptions
async function calculateTotalRevenue() {
    try {
        let totalRevenue = 0;
        let monthlyRevenue = 0;
        let yearlyRevenue = 0;
        let premiumCount = 0;
        
        if (typeof firebase !== 'undefined') {
            const querySnapshot = await firebase.firestore().collection('users')
                .where('subscription.status', '==', 'premium')
                .get();
            
            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                const plan = userData.subscription?.plan;
                
                if (plan === 'monthly') {
                    monthlyRevenue += 9.99;
                    premiumCount++;
                } else if (plan === 'yearly') {
                    yearlyRevenue += 99.99;
                    premiumCount++;
                }
            });
        } else {
            // localStorage fallback
            const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
            users.forEach(user => {
                if (user.subscription?.status === 'premium') {
                    const plan = user.subscription?.plan;
                    if (plan === 'monthly') {
                        monthlyRevenue += 9.99;
                        premiumCount++;
                    } else if (plan === 'yearly') {
                        yearlyRevenue += 99.99;
                        premiumCount++;
                    }
                }
            });
        }
        
        totalRevenue = monthlyRevenue + yearlyRevenue;
        
        const revenueReport = {
            totalRevenue: `$${totalRevenue.toFixed(2)}`,
            monthlySubscriptionRevenue: `$${monthlyRevenue.toFixed(2)}`,
            yearlySubscriptionRevenue: `$${yearlyRevenue.toFixed(2)}`,
            premiumSubscribers: premiumCount,
            monthlySubscribers: Math.round(monthlyRevenue / 9.99),
            yearlySubscribers: Math.round(yearlyRevenue / 99.99)
        };
        
        console.log('ðŸ’° REVENUE REPORT');
        console.table(revenueReport);
        
        return revenueReport;
    } catch (error) {
        console.error('Error calculating revenue:', error);
        return null;
    }
}

// Function to get all premium subscribers with payment amounts
async function getAllPremiumPayments() {
    try {
        const premiumUsers = [];
        
        if (typeof firebase !== 'undefined') {
            const querySnapshot = await firebase.firestore().collection('users')
                .where('subscription.status', '==', 'premium')
                .get();
            
            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                const subscription = userData.subscription || {};
                
                let amount = 0;
                if (subscription.plan === 'monthly') amount = 9.99;
                if (subscription.plan === 'yearly') amount = 99.99;
                
                premiumUsers.push({
                    email: userData.email,
                    name: userData.name,
                    plan: subscription.plan,
                    amount: `$${amount}`,
                    startDate: subscription.startDate,
                    endDate: subscription.endDate,
                    daysRemaining: subscription.endDate ? 
                        Math.ceil((new Date(subscription.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : 0
                });
            });
        } else {
            // localStorage fallback
            const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
            users.forEach(user => {
                if (user.subscription?.status === 'premium') {
                    let amount = 0;
                    if (user.subscription?.plan === 'monthly') amount = 9.99;
                    if (user.subscription?.plan === 'yearly') amount = 99.99;
                    
                    premiumUsers.push({
                        email: user.email,
                        name: user.name,
                        plan: user.subscription?.plan,
                        amount: `$${amount}`,
                        startDate: user.subscription?.startDate,
                        endDate: user.subscription?.endDate
                    });
                }
            });
        }
        
        console.log('ðŸ’Ž ALL PREMIUM SUBSCRIBERS & PAYMENTS');
        console.table(premiumUsers);
        
        return premiumUsers;
    } catch (error) {
        console.error('Error getting premium payments:', error);
        return [];
    }
}

// Function to check payment for current logged-in user
function checkMyPayment() {
    const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
    
    if (!currentUser) {
        console.log('âŒ No user logged in');
        return null;
    }
    
    let amount = 0;
    if (currentUser.subscription?.plan === 'monthly') amount = 9.99;
    if (currentUser.subscription?.plan === 'yearly') amount = 99.99;
    
    const myPayment = {
        email: currentUser.email,
        name: currentUser.name,
        status: currentUser.subscription?.status || 'free',
        plan: currentUser.subscription?.plan || 'none',
        amountPaid: amount > 0 ? `$${amount}` : '$0 (Free)',
        startDate: currentUser.subscription?.startDate || 'N/A',
        endDate: currentUser.subscription?.endDate || 'N/A',
        isPremium: currentUser.subscription?.status === 'premium' ? 'âœ… YES' : 'âŒ NO'
    };
    
    console.log('ðŸ’³ MY PAYMENT DETAILS');
    console.table(myPayment);
    
    return myPayment;
}

// Function to update payment amount for existing subscription
async function addPaymentAmount(userEmail, amount, currency = 'USD') {
    try {
        if (typeof firebase !== 'undefined') {
            const querySnapshot = await firebase.firestore().collection('users')
                .where('email', '==', userEmail)
                .get();
            
            if (!querySnapshot.empty) {
                const userDoc = querySnapshot.docs[0];
                await userDoc.ref.update({
                    'subscription.amount': amount,
                    'subscription.currency': currency,
                    'subscription.paymentUpdated': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`âœ… Payment amount $${amount} ${currency} added for ${userEmail}`);
                return { success: true };
            } else {
                console.log('âŒ User not found:', userEmail);
                return { success: false, error: 'User not found' };
            }
        } else {
            // localStorage update
            const users = JSON.parse(localStorage.getItem('french_app_users') || '[]');
            const userIndex = users.findIndex(u => u.email === userEmail);
            
            if (userIndex !== -1) {
                users[userIndex].subscription.amount = amount;
                users[userIndex].subscription.currency = currency;
                localStorage.setItem('french_app_users', JSON.stringify(users));
                
                // Update current user if it's the same
                const currentUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
                if (currentUser && currentUser.email === userEmail) {
                    currentUser.subscription.amount = amount;
                    currentUser.subscription.currency = currency;
                    localStorage.setItem('french_app_current_user', JSON.stringify(currentUser));
                }
                
                console.log(`âœ… Payment amount $${amount} ${currency} added for ${userEmail}`);
                return { success: true };
            }
        }
    } catch (error) {
        console.error('Error adding payment amount:', error);
        return { success: false, error: error.message };
    }
}

// Function to export payment data as CSV
async function exportPaymentData() {
    try {
        const premiumUsers = await getAllPremiumPayments();
        
        if (premiumUsers.length === 0) {
            console.log('No premium subscribers found');
            return;
        }
        
        const headers = ['Name', 'Email', 'Plan', 'Amount Paid', 'Start Date', 'End Date', 'Days Remaining'];
        const csvContent = [
            headers.join(','),
            ...premiumUsers.map(user => [
                `"${user.name || 'N/A'}"`,
                `"${user.email}"`,
                `"${user.plan || 'N/A'}"`,
                `"${user.amount}"`,
                `"${user.startDate || 'N/A'}"`,
                `"${user.endDate || 'N/A'}"`,
                `"${user.daysRemaining || 'N/A'}"`
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'french-app-payment-data.csv';
        link.click();
        window.URL.revokeObjectURL(url);
        
        console.log('âœ… Payment data exported to CSV');
    } catch (error) {
        console.error('Error exporting payment data:', error);
    }
}

// Enhanced admin panel for payments
function showPaymentAdminPanel() {
    console.log(`
ðŸ’³ PAYMENT TRACKING ADMIN PANEL
===============================

ðŸ’° REVENUE COMMANDS:
- calculateTotalRevenue()     â†’ Total revenue from all subscriptions
- getAllPremiumPayments()     â†’ All premium users with payment amounts
- checkMyPayment()            â†’ Your current payment status

ðŸ” USER PAYMENT LOOKUP:
- getUserPaymentDetails('email@example.com') â†’ Specific user's payment info

ðŸ’Ž CURRENT USER QUICK CHECK:
- checkMyPayment()            â†’ Your subscription & payment details

ðŸ“Š DATA EXPORT:
- exportPaymentData()         â†’ Download payment data as CSV

ðŸ› ï¸  ADMIN UPDATES:
- addPaymentAmount('email@example.com', 99.99) â†’ Add payment amount to subscription

ðŸ’¡ QUICK STATS:
Run calculateTotalRevenue() for instant business metrics

Current Status: ${typeof firebase !== 'undefined' ? 'Firebase Enabled' : 'Demo Mode (localStorage)'}
    `);
}

// Auto-show payment admin panel
showPaymentAdminPanel();

console.log('ðŸ’³ Payment tracking functions loaded! Try: checkMyPayment()');
    </script>
    
    <!-- User Data Fix Functions (embedded from fix-user-data.js) -->
    <script>
// Fix Missing Email Data in Firebase User Documents

// Function to fix current user's document if email is missing
async function fixCurrentUserEmail() {
    try {
        if (typeof firebase === 'undefined') {
            console.log('âŒ Firebase not loaded');
            return;
        }

        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.log('âŒ No user signed in');
            return;
        }

        console.log('ðŸ” Checking user document for:', currentUser.email);

        // Get the current user's Firestore document
        const userDocRef = firebase.firestore().collection('users').doc(currentUser.uid);
        const doc = await userDocRef.get();

        if (doc.exists) {
            const userData = doc.data();
            console.log('ðŸ“„ Current document data:', userData);

            // Check if email is missing
            if (!userData.email) {
                console.log('âš ï¸ Email missing! Adding email to document...');
                
                // Update document with missing email
                await userDocRef.update({
                    email: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('âœ… Email added to document:', currentUser.email);
                
                // Also update localStorage
                const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || '{}');
                localUser.email = currentUser.email;
                localStorage.setItem('french_app_current_user', JSON.stringify(localUser));
                
                console.log('âœ… localStorage also updated');
            } else {
                console.log('âœ… Email already exists in document:', userData.email);
            }
        } else {
            console.log('âŒ No Firestore document found! Creating new document...');
            
            // Create complete user document
            const newUserData = {
                email: currentUser.email,
                name: currentUser.displayName || currentUser.email.split('@')[0],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                subscription: {
                    status: 'free',
                    plan: null,
                    startDate: null,
                    endDate: null,
                    active: false,
                    paymentMethod: null
                },
                subscriptionHistory: []
            };
            
            await userDocRef.set(newUserData);
            console.log('âœ… New user document created with email:', currentUser.email);
            
            // Update localStorage too
            const localUserData = {
                email: currentUser.email,
                name: currentUser.displayName || currentUser.email.split('@')[0],
                registeredAt: new Date().toISOString(),
                subscription: {
                    status: 'free',
                    plan: null,
                    startDate: null,
                    endDate: null
                }
            };
            localStorage.setItem('french_app_current_user', JSON.stringify(localUserData));
            console.log('âœ… localStorage updated with new user data');
        }

        // Verify the fix
        const updatedDoc = await userDocRef.get();
        if (updatedDoc.exists) {
            console.log('ðŸŽ‰ FINAL DOCUMENT DATA:');
            console.table(updatedDoc.data());
        }

    } catch (error) {
        console.error('âŒ Error fixing user email:', error);
    }
}

// Function to fix any user's missing email by UID
async function fixUserEmailByUID(uid, email) {
    try {
        if (typeof firebase === 'undefined') {
            console.log('âŒ Firebase not loaded');
            return;
        }

        const userDocRef = firebase.firestore().collection('users').doc(uid);
        const doc = await userDocRef.get();

        if (doc.exists) {
            await userDocRef.update({
                email: email,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log(`âœ… Email ${email} added to user ${uid}`);
        } else {
            console.log(`âŒ No document found for UID: ${uid}`);
        }
    } catch (error) {
        console.error('âŒ Error fixing user email:', error);
    }
}

// Function to check all users and fix missing emails
async function fixAllMissingEmails() {
    try {
        if (typeof firebase === 'undefined') {
            console.log('âŒ Firebase not loaded');
            return;
        }

        console.log('ðŸ” Checking all user documents for missing emails...');

        const usersSnapshot = await firebase.firestore().collection('users').get();
        let fixedCount = 0;

        for (const doc of usersSnapshot.docs) {
            const userData = doc.data();
            const uid = doc.id;

            if (!userData.email) {
                console.log(`âš ï¸ Missing email for UID: ${uid}`);
                
                // Try to get email from Firebase Auth
                const authUser = await firebase.auth().getUser(uid).catch(() => null);
                
                if (authUser && authUser.email) {
                    await doc.ref.update({
                        email: authUser.email,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`âœ… Fixed email for ${uid}: ${authUser.email}`);
                    fixedCount++;
                } else {
                    console.log(`âŒ Could not find email for UID: ${uid}`);
                }
            }
        }

        console.log(`ðŸŽ‰ Fixed ${fixedCount} user documents`);
    } catch (error) {
        console.error('âŒ Error fixing all emails:', error);
    }
}

// Function to recreate user document with proper structure
async function recreateUserDocument() {
    try {
        if (typeof firebase === 'undefined') {
            console.log('âŒ Firebase not loaded');
            return;
        }

        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.log('âŒ No user signed in');
            return;
        }

        console.log('ðŸ”„ Recreating user document for:', currentUser.email);

        // Delete existing document
        await firebase.firestore().collection('users').doc(currentUser.uid).delete();
        console.log('ðŸ—‘ï¸ Old document deleted');

        // Create new complete document
        const newUserData = {
            email: currentUser.email,
            name: currentUser.displayName || 'User',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            subscription: {
                status: 'premium',  // Keep your premium status!
                plan: 'yearly',
                startDate: '2025-07-29T01:27:30.113Z',
                endDate: '2026-07-29T01:27:30.113Z',
                active: true,
                paymentMethod: 'stripe',
                amount: 99.99,
                currency: 'USD'
            },
            subscriptionHistory: [
                {
                    action: 'upgrade',
                    plan: 'yearly',
                    amount: 99.99,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }
            ]
        };

        await firebase.firestore().collection('users').doc(currentUser.uid).set(newUserData);
        console.log('âœ… New complete document created!');

        // Update localStorage too
        const localUserData = {
            email: currentUser.email,
            name: currentUser.displayName || 'User',
            registeredAt: new Date().toISOString(),
            subscription: {
                status: 'premium',
                plan: 'yearly',
                startDate: '2025-07-29T01:27:30.113Z',
                endDate: '2026-07-29T01:27:30.113Z'
            }
        };
        localStorage.setItem('french_app_current_user', JSON.stringify(localUserData));

        console.log('ðŸŽ‰ User document recreated with email and premium subscription!');
        
        // Verify
        const newDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        console.log('ðŸ“„ NEW DOCUMENT:');
        console.table(newDoc.data());

    } catch (error) {
        console.error('âŒ Error recreating document:', error);
    }
}

// Quick diagnostic function
function diagnoseUserData() {
    console.log('ðŸ” USER DATA DIAGNOSTIC');
    console.log('========================');
    
    // Check localStorage
    const localUser = JSON.parse(localStorage.getItem('french_app_current_user') || 'null');
    console.log('ðŸ“± localStorage user:', localUser);
    
    // Check Firebase Auth
    if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
        const authUser = firebase.auth().currentUser;
        console.log('ðŸ” Firebase Auth user:', {
            uid: authUser.uid,
            email: authUser.email,
            displayName: authUser.displayName
        });
        
        // Check Firestore document
        firebase.firestore().collection('users').doc(authUser.uid).get()
            .then(doc => {
                if (doc.exists) {
                    console.log('ðŸ”¥ Firestore document:', doc.data());
                    
                    const data = doc.data();
                    if (!data.email) {
                        console.log('âš ï¸ EMAIL MISSING FROM FIRESTORE DOCUMENT!');
                        console.log('ðŸ”§ Run: fixCurrentUserEmail()');
                    } else {
                        console.log('âœ… Email found in Firestore:', data.email);
                    }
                } else {
                    console.log('âŒ NO FIRESTORE DOCUMENT EXISTS!');
                    console.log('ðŸ”§ Run: recreateUserDocument()');
                }
            });
    } else {
        console.log('âŒ No Firebase user signed in');
    }
}

// Auto-execute clean document recreation if needed
async function autoCleanDocument() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.log('â³ Waiting for Firebase authentication...');
            setTimeout(autoCleanDocument, 2000);
            return;
        }

        console.log('ðŸ” Checking document for user:', currentUser.email);
        
        const doc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        
        if (doc.exists) {
            const data = doc.data();
            console.log('ðŸ“„ Current document data:', data);
            
            // Check if data looks corrupted (hex, base64, or missing email)
            const emailField = data.email;
            const needsCleanup = !emailField || 
                                (typeof emailField === 'string' && (
                                    /^[0-9a-fA-F]+$/.test(emailField) || // hex
                                    /^[A-Za-z0-9+/]+=*$/.test(emailField) || // base64
                                    emailField.length > 50 // suspiciously long
                                ));
            
            if (needsCleanup) {
                console.log('âš ï¸ Document appears corrupted or incomplete. Starting clean recreation...');
                await performCleanRecreation();
            } else {
                console.log('âœ… Document looks good!');
                console.table(data);
            }
        } else {
            console.log('âŒ No document found. Creating new one...');
            await performCleanRecreation();
        }
    } catch (error) {
        console.error('âŒ Error in auto cleanup:', error);
    }
}

// Perform the actual clean recreation
async function performCleanRecreation() {
    const currentUser = firebase.auth().currentUser;
    
    console.log('ðŸ§¹ PERFORMING CLEAN DOCUMENT RECREATION');
    console.log('=====================================');
    
    try {
        // Delete any existing corrupted document
        await firebase.firestore().collection('users').doc(currentUser.uid).delete();
        console.log('ðŸ—‘ï¸ Old document deleted');
        
        // Create completely clean document with readable data
        const cleanUserData = {
            email: currentUser.email,      // Use actual Firebase Auth email
            name: currentUser.displayName || 'User',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            subscription: {
                status: 'premium',         // Keep your premium status!
                plan: 'yearly',           
                startDate: '2025-07-29T01:27:30.113Z',
                endDate: '2026-07-29T01:27:30.113Z',
                active: true,
                paymentMethod: 'stripe',
                amount: 99.99,
                currency: 'USD'
            },
            subscriptionHistory: [
                {
                    action: 'upgrade',
                    plan: 'yearly',
                    amount: 99.99,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }
            ],
            documentVersion: '2.0',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Save the clean document
        await firebase.firestore().collection('users').doc(currentUser.uid).set(cleanUserData);
        console.log('âœ… Clean document created successfully!');
        
        // Update localStorage with clean data
        const localUserData = {
            email: currentUser.email,
            name: currentUser.displayName || 'User',
            registeredAt: new Date().toISOString(),
            subscription: {
                status: 'premium',
                plan: 'yearly',
                startDate: '2025-07-29T01:27:30.113Z',
                endDate: '2026-07-29T01:27:30.113Z'
            }
        };
        localStorage.setItem('french_app_current_user', JSON.stringify(localUserData));
        console.log('âœ… localStorage updated with clean data');
        
        // Verify the new document
        const newDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        console.log('ðŸŽ‰ NEW CLEAN DOCUMENT CREATED:');
        console.table(newDoc.data());
        
        // Test all admin functions
        console.log('ðŸ§ª TESTING ADMIN FUNCTIONS:');
        console.log('============================');
        
        setTimeout(() => {
            console.log('ðŸ’³ Testing checkMyPayment():');
            checkMyPayment();
        }, 1000);
        
        setTimeout(() => {
            console.log('ðŸ’° Testing calculateTotalRevenue():');
            calculateTotalRevenue();
        }, 2000);
        
        setTimeout(() => {
            console.log('ðŸ’Ž Testing getAllPremiumPayments():');
            getAllPremiumPayments();
        }, 3000);
        
        console.log('âœ… DOCUMENT RECREATION COMPLETE!');
        console.log('ðŸŽ¯ Your premium subscription has been preserved!');
        console.log('ðŸ“Š All admin functions should now work perfectly!');
        
        return newDoc.data();
        
    } catch (error) {
        console.error('âŒ Error during clean recreation:', error);
        throw error;
    }
}

// Manual trigger function
async function forceCleanRecreation() {
    console.log('ðŸ”„ FORCING CLEAN DOCUMENT RECREATION');
    console.log('===================================');
    await performCleanRecreation();
}

// Simple clean recreation without arrays (if above still fails)
async function simpleCleanRecreation() {
    const currentUser = firebase.auth().currentUser;
    
    console.log('ðŸ§¹ SIMPLE CLEAN DOCUMENT RECREATION');
    console.log('==================================');
    
    try {
        // Delete any existing corrupted document
        await firebase.firestore().collection('users').doc(currentUser.uid).delete();
        console.log('ðŸ—‘ï¸ Old document deleted');
        
        // Create simple clean document without complex arrays
        const simpleUserData = {
            email: currentUser.email,
            name: currentUser.displayName || 'User',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            subscription: {
                status: 'premium',
                plan: 'yearly',
                startDate: '2025-07-29T01:27:30.113Z',
                endDate: '2026-07-29T01:27:30.113Z',
                active: true,
                paymentMethod: 'stripe',
                amount: 99.99,
                currency: 'USD'
            },
            documentVersion: '2.0',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Save the simple clean document
        await firebase.firestore().collection('users').doc(currentUser.uid).set(simpleUserData);
        console.log('âœ… Simple clean document created successfully!');
        
        // Add subscription history separately to avoid array issues
        await firebase.firestore().collection('users').doc(currentUser.uid).update({
            subscriptionHistory: firebase.firestore.FieldValue.arrayUnion({
                action: 'upgrade',
                plan: 'yearly',
                amount: 99.99,
                timestamp: new Date().toISOString(),
                note: 'Document recreated with clean data'
            })
        });
        console.log('âœ… Subscription history added separately');
        
        // Update localStorage with clean data
        const localUserData = {
            email: currentUser.email,
            name: currentUser.displayName || 'User',
            registeredAt: new Date().toISOString(),
            subscription: {
                status: 'premium',
                plan: 'yearly',
                startDate: '2025-07-29T01:27:30.113Z',
                endDate: '2026-07-29T01:27:30.113Z'
            }
        };
        localStorage.setItem('french_app_current_user', JSON.stringify(localUserData));
        console.log('âœ… localStorage updated with clean data');
        
        // Verify the new document
        const newDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        console.log('ðŸŽ‰ NEW SIMPLE CLEAN DOCUMENT CREATED:');
        console.table(newDoc.data());
        
        console.log('âœ… SIMPLE DOCUMENT RECREATION COMPLETE!');
        console.log('ðŸŽ¯ Your premium subscription has been preserved!');
        
        return newDoc.data();
        
    } catch (error) {
        console.error('âŒ Error during simple clean recreation:', error);
        throw error;
    }
}

console.log('ðŸ”§ USER DATA FIX TOOLS LOADED');
console.log('============================');
console.log('ðŸ“‹ Available Commands:');
console.log('- diagnoseUserData()        â†’ Check what data exists');
console.log('- fixCurrentUserEmail()     â†’ Fix missing email for current user');
console.log('- recreateUserDocument()    â†’ Recreate complete user document');
console.log('- forceCleanRecreation()    â†’ Force immediate clean recreation');
console.log('- simpleCleanRecreation()   â†’ Simple clean recreation (if above fails)');
console.log('');
console.log('ðŸš€ Auto-checking document in 3 seconds...');

// Auto-run the cleanup after page loads
setTimeout(autoCleanDocument, 3000);
    </script>


</body>
</html> 